<!DOCTYPE html>
            <html lang="es">
            <head><style>
        @import url(https://fonts.googleapis.com/css?family=Google+Sans+Text);
        html {
          font-family: 'Google Sans Text', 'Google Sans';
          font-size: 14px;
          color-scheme: light dark;
          background: light-dark(white, black);
          color: light-dark(black, white);
        }
        </style>
        
        <script type="importmap">{"imports":{"@modelcontextprotocol/sdk/":"https://aistudiocdn.com/@modelcontextprotocol/sdk/dist/esm/","https://aistudiocdn.com/@modelcontextprotocol/sdk@^1.11.0/es2022/":"https://aistudiocdn.com/@modelcontextprotocol/sdk@^1.11.0/es2022/dist/esm/","https://aistudiocdn.com/@modelcontextprotocol/sdk@^1.11.0/client/index?target=es2022":"https://aistudiocdn.com/@modelcontextprotocol/sdk@^1.11.0/dist/esm/client/index?target=es2022","https://aistudiocdn.com/@modelcontextprotocol/sdk@^1.11.0/types?target=es2022":"https://aistudiocdn.com/@modelcontextprotocol/sdk@^1.11.0/dist/esm/types?target=es2022","@/index":"data:application/javascript;base64,ZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHsKICAgIC8vIENhc3QgdG8gSFRNTEVsZW1lbnQgb3Igc3BlY2lmaWMgZWxlbWVudCB0eXBlcyB0byBhdm9pZCBudWxsIGlzc3VlcyBhbmQgZ2V0IFRTIHN1cHBvcnQKICAgIGNvbnN0IG1haW5TY3JlZW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi1zY3JlZW4nKTsKICAgIGNvbnN0IGRvY3VtZW50b3NTY3JlZW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvcy1zY3JlZW4nKTsKICAgIGNvbnN0IGhpam9zU2NyZWVuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLXNjcmVlbicpOwogICAgY29uc3QgZG5pRGV0YWlsc1NjcmVlbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGV0YWlscy1zY3JlZW4nKTsKICAgIGNvbnN0IHRlbGVmb25vc1NjcmVlbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3Mtc2NyZWVuJyk7CiAgICBjb25zdCBib3R0b21OYXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYm90dG9tLW5hdicpOwogICAgY29uc3QgbG9hZGluZ092ZXJsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZy1vdmVybGF5Jyk7CiAgICBjb25zdCBhY3Rpb25Mb2FkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxvYWRlcicpOwogICAgY29uc3QgZG9jdW1lbnRvc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb2N1bWVudG9zLWJ0bicpOwogICAgY29uc3QgaGlqb3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtYnRuJyk7CiAgICBjb25zdCB0ZWxlZm9ub3NCdG5Eb2NzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlbGVmb25vcy1idG4tZG9jcycpOwogICAgY29uc3QgdGVsZWZvbm9zQnRuRGV0YWlscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3MtYnRuLWRldGFpbHMnKTsKICAgIGNvbnN0IHRlbGVmb25vc0luaWNpb0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3MtaW5pY2lvLWJ0bicpOwogICAgLy8gRklYOiBDaGFuZ2VkIHR5cGUgZnJvbSBTVkdFbGVtZW50IHRvIEhUTUxFbGVtZW50IHRvIHJlc29sdmUgYSBUeXBlU2NyaXB0IGNhc3RpbmcgZXJyb3IuCiAgICAvLyBJdCdzIG1vcmUgY29udmVudGlvbmFsIGZvciBhIGNsaWNrYWJsZSBlbGVtZW50IGxpa2UgYSBidXR0b24gdG8gYmUgYW4gSFRNTEVsZW1lbnQsIHdoaWNoIG1pZ2h0IGNvbnRhaW4gYW4gU1ZHLgogICAgY29uc3QgYmFja0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdiYWNrLWJ0bicpOwogICAgY29uc3QgaGlqb3NCYWNrQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWJhY2stYnRuJyk7CiAgICBjb25zdCBkZXRhaWxzQmFja0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWJhY2stYnRuJyk7CiAgICBjb25zdCBpbmljaW9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5pY2lvLWJ0bicpOwogICAgLy8gRE5JIENhcmQgZWxlbWVudHMKICAgIGNvbnN0IHNvbGljaXRhckRuaUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb2xpY2l0YXItZG5pLWJ0bicpOwogICAgY29uc3QgZG5pSW5pdGlhbFZpZXcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWluaXRpYWwtdmlldycpOwogICAgY29uc3QgZG5pU29saWNpdHVkVmlldyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktc29saWNpdHVkLXZpZXcnKTsKICAgIGNvbnN0IGRuaUNhcmRIZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWNhcmQtaGVhZGVyJyk7CiAgICBjb25zdCBkbmlDYXJkQm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktY2FyZC1ib2R5Jyk7CiAgICBjb25zdCBjb25maXJtYXJTb2xpY2l0dWRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uZmlybWFyLXNvbGljaXR1ZC1idG4nKTsKICAgIGNvbnN0IGRuaURpZ2l0YWxEaXNwbGF5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1kaWdpdGFsLWRpc3BsYXknKTsKICAgIGNvbnN0IG1haW5EbmlQcm9maWxlUGljID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLXByb2ZpbGUtcGljJyk7CiAgICBjb25zdCBtYWluRG5pUHJvZmlsZUltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLXByb2ZpbGUtaW1hZ2UnKTsKICAgIGNvbnN0IHZlckRldGFsbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVyLWRldGFsbGUtYnRuJyk7CiAgICBjb25zdCB2ZXJEbmlEaWdpdGFsQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Zlci1kbmktZGlnaXRhbC1idG4nKTsKICAgIC8vIEhlYWRlciBlbGVtZW50cyBmb3IgZHluYW1pYyBjb250ZW50CiAgICBjb25zdCBkb2N1bWVudG9zSGVhZGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRvY3VtZW50b3MtaGVhZGVyJyk7CiAgICBjb25zdCBkb2N1bWVudG9zSGVhZGVyVGl0bGUgPSBkb2N1bWVudG9zSGVhZGVyLnF1ZXJ5U2VsZWN0b3IoJ2gyJyk7CiAgICBjb25zdCByZWZyZXNoSWNvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWZyZXNoLWljb24nKTsKICAgIGNvbnN0IHdlbGNvbWVOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtbmFtZScpOwogICAgY29uc3QgZG5pRGlnaXRhbFRpdGxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1kaWdpdGFsLXRpdGxlJyk7CiAgICBjb25zdCBzb2xpY2l0dWREbmlOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvbGljaXR1ZC1kbmktbmFtZScpOwogICAgLy8gSGlqb3Mgc2NyZWVuIGNvbnRyb2xzIChJbWFnZSkKICAgIGNvbnN0IGhpam9zRG5pUHJvZmlsZVBpYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWpvcy1kbmktcHJvZmlsZS1waWMnKTsKICAgIGNvbnN0IGhpam9zRG5pUHJvZmlsZUltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1wcm9maWxlLWltYWdlJyk7CiAgICBjb25zdCBpbWFnZVVybElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ltYWdlLXVybC1pbnB1dCcpOwogICAgY29uc3QgdG9wU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvcC1zbGlkZXInKTsKICAgIGNvbnN0IGxlZnRTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGVmdC1zbGlkZXInKTsKICAgIGNvbnN0IHdpZHRoU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpZHRoLXNsaWRlcicpOwogICAgY29uc3QgaGVpZ2h0U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlaWdodC1zbGlkZXInKTsKICAgIGNvbnN0IHRvcFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvcC12YWx1ZScpOwogICAgY29uc3QgbGVmdFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xlZnQtdmFsdWUnKTsKICAgIGNvbnN0IHdpZHRoVmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lkdGgtdmFsdWUnKTsKICAgIGNvbnN0IGhlaWdodFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlaWdodC12YWx1ZScpOwogICAgLy8gSGlqb3Mgc2NyZWVuIGNvbnRyb2xzIChRUikKICAgIGNvbnN0IG1haW5EbmlRclBpYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluLWRuaS1xci1waWMnKTsKICAgIGNvbnN0IG1haW5EbmlRckltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLXFyLWltYWdlJyk7CiAgICBjb25zdCBoaWpvc0RuaVFyUGljID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1xci1waWMnKTsKICAgIGNvbnN0IGhpam9zRG5pUXJJbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWpvcy1kbmktcXItaW1hZ2UnKTsKICAgIGNvbnN0IHFyVXJsSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItdXJsLWlucHV0Jyk7CiAgICBjb25zdCBxclRvcFNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxci10b3Atc2xpZGVyJyk7CiAgICBjb25zdCBxckxlZnRTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItbGVmdC1zbGlkZXInKTsKICAgIGNvbnN0IHFyV2lkdGhTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItd2lkdGgtc2xpZGVyJyk7CiAgICBjb25zdCBxckhlaWdodFNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxci1oZWlnaHQtc2xpZGVyJyk7CiAgICBjb25zdCBxclRvcFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3FyLXRvcC12YWx1ZScpOwogICAgY29uc3QgcXJMZWZ0VmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItbGVmdC12YWx1ZScpOwogICAgY29uc3QgcXJXaWR0aFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3FyLXdpZHRoLXZhbHVlJyk7CiAgICBjb25zdCBxckhlaWdodFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3FyLWhlaWdodC12YWx1ZScpOwogICAgY29uc3QgZGV0YWlsc0JhcmNvZGVJbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWJhcmNvZGUtaW1hZ2UnKTsKICAgIGNvbnN0IGRldGFpbHNQcm9maWxlSW1hZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy1wcm9maWxlLWltYWdlJyk7CiAgICAvLyBIaWpvcyBzY3JlZW4gY29udHJvbHMgKEJhY2sgSW1hZ2UpCiAgICBjb25zdCBtYWluRG5pQmFja0ltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLWJhY2staW1hZ2UnKTsKICAgIGNvbnN0IGhpam9zRG5pQmFja0ltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1iYWNrLWltYWdlJyk7CiAgICBjb25zdCBkbmlCYWNrVXJsSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWJhY2stdXJsLWlucHV0Jyk7CiAgICAvLyBVc2VyIE1lbnUgRWxlbWVudHMKICAgIGNvbnN0IHVzZXJQcm9maWxlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXItcHJvZmlsZS1idG4nKTsKICAgIGNvbnN0IHByb2ZpbGVBcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFycm93Jyk7CiAgICBjb25zdCB1c2VyTWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyLW1lbnUnKTsKICAgIGNvbnN0IG1lbnVIaWpvc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW51LWhpam9zLWJ0bicpOwogICAgY29uc3QgbWVudVVzZXJOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnUtdXNlci1uYW1lJyk7CiAgICBjb25zdCBtZW51VXNlcklkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnUtdXNlci1pZCcpOwogICAgZnVuY3Rpb24gc2V0dXBTbGlkZXIoc2xpZGVyLCB0YXJnZXRzLCBwcm9wZXJ0eSwgdmFsdWVTcGFuLCB1bml0ID0gJyUnKSB7CiAgICAgICAgaWYgKHNsaWRlciAmJiB0YXJnZXRzICYmIHRhcmdldHMubGVuZ3RoID4gMCAmJiB2YWx1ZVNwYW4pIHsKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgdmFsdWUKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFZhbHVlID0gc2xpZGVyLnZhbHVlOwogICAgICAgICAgICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQuc3R5bGVbcHJvcGVydHldID0gYCR7aW5pdGlhbFZhbHVlfSR7dW5pdH1gOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFsdWVTcGFuLnRleHRDb250ZW50ID0gaW5pdGlhbFZhbHVlOwogICAgICAgICAgICAvLyBBZGQgZXZlbnQgbGlzdGVuZXIKICAgICAgICAgICAgc2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzbGlkZXIudmFsdWU7CiAgICAgICAgICAgICAgICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5zdHlsZVtwcm9wZXJ0eV0gPSBgJHt2YWx1ZX0ke3VuaXR9YDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHZhbHVlU3Bhbi50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVEeW5hbWljSGVhZGVyRGF0YSgpIHsKICAgICAgICBjb25zdCBhcGVsbGlkb0lucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwZWxsaWRvLWlucHV0Jyk7CiAgICAgICAgY29uc3Qgbm9tYnJlSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbm9tYnJlLWlucHV0Jyk7CiAgICAgICAgY29uc3QgY3VpbElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1aWwtaW5wdXQnKTsKICAgICAgICBpZiAoYXBlbGxpZG9JbnB1dCAmJiBub21icmVJbnB1dCAmJiBjdWlsSW5wdXQpIHsKICAgICAgICAgICAgY29uc3QgYXBlbGxpZG8gPSBhcGVsbGlkb0lucHV0LnZhbHVlOwogICAgICAgICAgICBjb25zdCBub21icmUgPSBub21icmVJbnB1dC52YWx1ZTsKICAgICAgICAgICAgY29uc3QgY3VpbCA9IGN1aWxJbnB1dC52YWx1ZTsKICAgICAgICAgICAgY29uc3QgZHJvcGRvd25OYW1lID0gYCR7bm9tYnJlfSAke2FwZWxsaWRvfWA7CiAgICAgICAgICAgIGNvbnN0IGRuaVRpdGxlTmFtZSA9IGAke2FwZWxsaWRvfSAke25vbWJyZX1gOwogICAgICAgICAgICBjb25zdCBtZW51TmFtZSA9IGAke25vbWJyZX0gJHthcGVsbGlkb31gOwogICAgICAgICAgICBpZiAod2VsY29tZU5hbWUpIHsKICAgICAgICAgICAgICAgIHdlbGNvbWVOYW1lLnRleHRDb250ZW50ID0gbm9tYnJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkbmlEaWdpdGFsVGl0bGUpIHsKICAgICAgICAgICAgICAgIGRuaURpZ2l0YWxUaXRsZS50ZXh0Q29udGVudCA9IGRuaVRpdGxlTmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc29saWNpdHVkRG5pTmFtZSkgewogICAgICAgICAgICAgICAgc29saWNpdHVkRG5pTmFtZS50ZXh0Q29udGVudCA9IGRyb3Bkb3duTmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWVudVVzZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBtZW51VXNlck5hbWUudGV4dENvbnRlbnQgPSBtZW51TmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWVudVVzZXJJZCkgewogICAgICAgICAgICAgICAgbWVudVVzZXJJZC50ZXh0Q29udGVudCA9IGN1aWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBzZXR1cFRleHRDb250cm9sKGZpZWxkKSB7CiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LWlucHV0YCk7CiAgICAgICAgY29uc3QgdG9wU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LXRvcC1zbGlkZXJgKTsKICAgICAgICBjb25zdCBsZWZ0U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LWxlZnQtc2xpZGVyYCk7CiAgICAgICAgY29uc3QgZm9udHNpemVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgJHtmaWVsZH0tZm9udHNpemUtc2xpZGVyYCk7CiAgICAgICAgY29uc3QgZm9udFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke2ZpZWxkfS1mb250LXNlbGVjdGApOwogICAgICAgIGNvbnN0IHRvcFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LXRvcC12YWx1ZWApOwogICAgICAgIGNvbnN0IGxlZnRWYWx1ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke2ZpZWxkfS1sZWZ0LXZhbHVlYCk7CiAgICAgICAgY29uc3QgZm9udHNpemVWYWx1ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke2ZpZWxkfS1mb250c2l6ZS12YWx1ZWApOwogICAgICAgIGNvbnN0IG1haW5UYXJnZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgbWFpbi1kbmktJHtmaWVsZH1gKTsKICAgICAgICBjb25zdCBoaWpvc1RhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBoaWpvcy1kbmktJHtmaWVsZH1gKTsKICAgICAgICBjb25zdCB0YXJnZXRzID0gW21haW5UYXJnZXQsIGhpam9zVGFyZ2V0XS5maWx0ZXIoZWwgPT4gZWwpOwogICAgICAgIGlmICh0ZXh0SW5wdXQgJiYgdGFyZ2V0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHRleHQKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFZhbHVlID0gdGV4dElucHV0LnZhbHVlOwogICAgICAgICAgICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHRhcmdldC50ZXh0Q29udGVudCA9IGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIC8vIEFkZCBsaXN0ZW5lcgogICAgICAgICAgICB0ZXh0SW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHRleHRJbnB1dC52YWx1ZTsKICAgICAgICAgICAgICAgIHRhcmdldHMuZm9yRWFjaCh0YXJnZXQgPT4gdGFyZ2V0LnRleHRDb250ZW50ID0gbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnbm9tYnJlJyB8fCBmaWVsZCA9PT0gJ2FwZWxsaWRvJyB8fCBmaWVsZCA9PT0gJ2N1aWwnKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlRHluYW1pY0hlYWRlckRhdGEoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHNldHVwU2xpZGVyKHRvcFNsaWRlciwgdGFyZ2V0cywgJ3RvcCcsIHRvcFZhbHVlLCAnJScpOwogICAgICAgIHNldHVwU2xpZGVyKGxlZnRTbGlkZXIsIHRhcmdldHMsICdsZWZ0JywgbGVmdFZhbHVlLCAnJScpOwogICAgICAgIHNldHVwU2xpZGVyKGZvbnRzaXplU2xpZGVyLCB0YXJnZXRzLCAnZm9udFNpemUnLCBmb250c2l6ZVZhbHVlLCAncHgnKTsKICAgICAgICBpZiAoZm9udFNlbGVjdCAmJiB0YXJnZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgZm9udCBmYW1pbHkKICAgICAgICAgICAgdGFyZ2V0cy5mb3JFYWNoKHRhcmdldCA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnN0eWxlLmZvbnRGYW1pbHkgPSBmb250U2VsZWN0LnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gQWRkIGV2ZW50IGxpc3RlbmVyCiAgICAgICAgICAgIGZvbnRTZWxlY3QuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdGb250ID0gZm9udFNlbGVjdC52YWx1ZTsKICAgICAgICAgICAgICAgIHRhcmdldHMuZm9yRWFjaCh0YXJnZXQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnN0eWxlLmZvbnRGYW1pbHkgPSBuZXdGb250OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvLyBTZXR1cCBmb3IgUHJvZmlsZSBJbWFnZQogICAgaWYgKGltYWdlVXJsSW5wdXQgJiYgbWFpbkRuaVByb2ZpbGVJbWFnZSAmJiBoaWpvc0RuaVByb2ZpbGVJbWFnZSkgewogICAgICAgIGNvbnN0IGluaXRpYWxVcmwgPSBpbWFnZVVybElucHV0LnZhbHVlOwogICAgICAgIG1haW5EbmlQcm9maWxlSW1hZ2Uuc3JjID0gaW5pdGlhbFVybDsKICAgICAgICBoaWpvc0RuaVByb2ZpbGVJbWFnZS5zcmMgPSBpbml0aWFsVXJsOwogICAgICAgIGlmIChkZXRhaWxzUHJvZmlsZUltYWdlKQogICAgICAgICAgICBkZXRhaWxzUHJvZmlsZUltYWdlLnNyYyA9IGluaXRpYWxVcmw7CiAgICAgICAgaW1hZ2VVcmxJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpID0+IHsKICAgICAgICAgICAgY29uc3QgbmV3VXJsID0gaW1hZ2VVcmxJbnB1dC52YWx1ZTsKICAgICAgICAgICAgbWFpbkRuaVByb2ZpbGVJbWFnZS5zcmMgPSBuZXdVcmw7CiAgICAgICAgICAgIGhpam9zRG5pUHJvZmlsZUltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgaWYgKGRldGFpbHNQcm9maWxlSW1hZ2UpCiAgICAgICAgICAgICAgICBkZXRhaWxzUHJvZmlsZUltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIFNldHVwIGZvciBCYWNrIEROSSBJbWFnZQogICAgaWYgKGRuaUJhY2tVcmxJbnB1dCAmJiBtYWluRG5pQmFja0ltYWdlICYmIGhpam9zRG5pQmFja0ltYWdlKSB7CiAgICAgICAgbWFpbkRuaUJhY2tJbWFnZS5zcmMgPSBkbmlCYWNrVXJsSW5wdXQudmFsdWU7CiAgICAgICAgaGlqb3NEbmlCYWNrSW1hZ2Uuc3JjID0gZG5pQmFja1VybElucHV0LnZhbHVlOwogICAgICAgIGRuaUJhY2tVcmxJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpID0+IHsKICAgICAgICAgICAgY29uc3QgbmV3VXJsID0gZG5pQmFja1VybElucHV0LnZhbHVlOwogICAgICAgICAgICBtYWluRG5pQmFja0ltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgaGlqb3NEbmlCYWNrSW1hZ2Uuc3JjID0gbmV3VXJsOwogICAgICAgIH0pOwogICAgfQogICAgLy8gU2V0dXAgZm9yIFFSIEltYWdlCiAgICBpZiAocXJVcmxJbnB1dCkgewogICAgICAgIGNvbnN0IHVwZGF0ZUFsbFFySW1hZ2VzID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBuZXdVcmwgPSBxclVybElucHV0LnZhbHVlOwogICAgICAgICAgICBpZiAobWFpbkRuaVFySW1hZ2UpIHsKICAgICAgICAgICAgICAgIG1haW5EbmlRckltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGlqb3NEbmlRckltYWdlKSB7CiAgICAgICAgICAgICAgICBoaWpvc0RuaVFySW1hZ2Uuc3JjID0gbmV3VXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZXRhaWxzQmFyY29kZUltYWdlKSB7CiAgICAgICAgICAgICAgICBkZXRhaWxzQmFyY29kZUltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLy8gU2V0IGluaXRpYWwgdmFsdWVzCiAgICAgICAgdXBkYXRlQWxsUXJJbWFnZXMoKTsKICAgICAgICAvLyBBZGQgZXZlbnQgbGlzdGVuZXIKICAgICAgICBxclVybElucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdXBkYXRlQWxsUXJJbWFnZXMpOwogICAgfQogICAgY29uc3QgcHJvZmlsZVBpY1RhcmdldHMgPSBbaGlqb3NEbmlQcm9maWxlUGljLCBtYWluRG5pUHJvZmlsZVBpY107CiAgICBzZXR1cFNsaWRlcih0b3BTbGlkZXIsIHByb2ZpbGVQaWNUYXJnZXRzLCAndG9wJywgdG9wVmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcihsZWZ0U2xpZGVyLCBwcm9maWxlUGljVGFyZ2V0cywgJ2xlZnQnLCBsZWZ0VmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcih3aWR0aFNsaWRlciwgcHJvZmlsZVBpY1RhcmdldHMsICd3aWR0aCcsIHdpZHRoVmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcihoZWlnaHRTbGlkZXIsIHByb2ZpbGVQaWNUYXJnZXRzLCAnaGVpZ2h0JywgaGVpZ2h0VmFsdWUsICclJyk7CiAgICBjb25zdCBxclBpY1RhcmdldHMgPSBbaGlqb3NEbmlRclBpYywgbWFpbkRuaVFyUGljXTsKICAgIHNldHVwU2xpZGVyKHFyVG9wU2xpZGVyLCBxclBpY1RhcmdldHMsICd0b3AnLCBxclRvcFZhbHVlLCAnJScpOwogICAgc2V0dXBTbGlkZXIocXJMZWZ0U2xpZGVyLCBxclBpY1RhcmdldHMsICdsZWZ0JywgcXJMZWZ0VmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcihxcldpZHRoU2xpZGVyLCBxclBpY1RhcmdldHMsICd3aWR0aCcsIHFyV2lkdGhWYWx1ZSwgJyUnKTsKICAgIHNldHVwU2xpZGVyKHFySGVpZ2h0U2xpZGVyLCBxclBpY1RhcmdldHMsICdoZWlnaHQnLCBxckhlaWdodFZhbHVlLCAnJScpOwogICAgLy8gU2V0dXAgZm9yIFRleHQgT3ZlcmxheXMKICAgIGNvbnN0IHRleHRGaWVsZHMgPSBbCiAgICAgICAgJ2FwZWxsaWRvJywgJ25vbWJyZScsICdkb2N1bWVudG8nLCAnbmFjaW1pZW50bycsCiAgICAgICAgJ3RyYW1pdGUnLCAnZWplbXBsYXInLCAnZW1pc2lvbicsICd2ZW5jaW1pZW50bycsCiAgICAgICAgJ2RvbWljaWxpbycsICdzZXhvJwogICAgICAgIC8vICdjdWlsJyBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgZm9yIGR5bmFtaWMgaGVhZGVyIHVwZGF0ZXMgYnV0IHVzZXMgdGhlIHNhbWUgc2V0dXAgbG9naWMKICAgIF07CiAgICB0ZXh0RmllbGRzLmZvckVhY2goc2V0dXBUZXh0Q29udHJvbCk7CiAgICBzZXR1cFRleHRDb250cm9sKCdjdWlsJyk7IC8vIEVuc3VyZSBDVUlMIGlzIGFsc28gc2V0IHVwCiAgICB1cGRhdGVEeW5hbWljSGVhZGVyRGF0YSgpOyAvLyBTZXQgaW5pdGlhbCBkeW5hbWljIG5hbWVzCiAgICBsZXQgaXNGbGlwcGVkID0gZmFsc2U7IC8vIFNoYXJlZCBzdGF0ZSBmb3IgRE5JIGNhcmQgZmxpcAogICAgZnVuY3Rpb24gcmVzZXREbmlDYXJkKCkgewogICAgICAgIGlmIChkbmlDYXJkSGVhZGVyKQogICAgICAgICAgICBkbmlDYXJkSGVhZGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgaWYgKGRuaUluaXRpYWxWaWV3KQogICAgICAgICAgICBkbmlJbml0aWFsVmlldy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICBpZiAoZG5pU29saWNpdHVkVmlldykKICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkbmlEaWdpdGFsRGlzcGxheSkKICAgICAgICAgICAgZG5pRGlnaXRhbERpc3BsYXkuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBpZiAoZG5pQ2FyZEJvZHkpCiAgICAgICAgICAgIGRuaUNhcmRCb2R5LmNsYXNzTGlzdC5yZW1vdmUoJ25vLWhlYWRlcicpOwogICAgICAgIC8vIFJlc2V0IGhlYWRlcgogICAgICAgIGlmIChkb2N1bWVudG9zSGVhZGVyVGl0bGUpCiAgICAgICAgICAgIGRvY3VtZW50b3NIZWFkZXJUaXRsZS50ZXh0Q29udGVudCA9ICdEb2N1bWVudG9zJzsKICAgICAgICBpZiAocmVmcmVzaEljb24pCiAgICAgICAgICAgIHJlZnJlc2hJY29uLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKGRvY3VtZW50b3NIZWFkZXIpCiAgICAgICAgICAgIGRvY3VtZW50b3NIZWFkZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAnZmxleC1zdGFydCc7CiAgICAgICAgLy8gUmVzZXQgZmxpcAogICAgICAgIGNvbnN0IGRuaUZsaXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWZsaXBwZXInKTsKICAgICAgICBpZiAoZG5pRmxpcHBlcikgewogICAgICAgICAgICBpZiAoaXNGbGlwcGVkKSB7CiAgICAgICAgICAgICAgICAvLyBBbmltYXRlIGl0IGJhY2sgdG8gdGhlIGZyb250IGlmIGl0IHdhcyBmbGlwcGVkCiAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAndHJhbnNmb3JtIDAuNnMgY3ViaWMtYmV6aWVyKDAuMzQsIDEuNTYsIDAuNjQsIDEpJzsKICAgICAgICAgICAgICAgIGRuaUZsaXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3JvdGF0ZVkoMGRlZyknOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlzRmxpcHBlZCA9IGZhbHNlOyAvLyBBbHdheXMgcmVzZXQgdGhlIGxvZ2ljYWwgc3RhdGUKICAgIH0KICAgIGZ1bmN0aW9uIHNob3dTY3JlZW4oc2NyZWVuTmFtZSkgewogICAgICAgIC8vIEhpZGUgYWxsIHNjcmVlbnMgZmlyc3QKICAgICAgICBpZiAobWFpblNjcmVlbikKICAgICAgICAgICAgbWFpblNjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkb2N1bWVudG9zU2NyZWVuKQogICAgICAgICAgICBkb2N1bWVudG9zU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKGhpam9zU2NyZWVuKQogICAgICAgICAgICBoaWpvc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkbmlEZXRhaWxzU2NyZWVuKQogICAgICAgICAgICBkbmlEZXRhaWxzU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKHRlbGVmb25vc1NjcmVlbikKICAgICAgICAgICAgdGVsZWZvbm9zU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKGJvdHRvbU5hdikKICAgICAgICAgICAgYm90dG9tTmF2LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgc3dpdGNoIChzY3JlZW5OYW1lKSB7CiAgICAgICAgICAgIGNhc2UgJ21haW4nOgogICAgICAgICAgICAgICAgaWYgKG1haW5TY3JlZW4pCiAgICAgICAgICAgICAgICAgICAgbWFpblNjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgcmVzZXREbmlDYXJkKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnZG9jdW1lbnRvcyc6CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnRvc1NjcmVlbikKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudG9zU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICBpZiAoYm90dG9tTmF2KQogICAgICAgICAgICAgICAgICAgIGJvdHRvbU5hdi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2hpam9zJzoKICAgICAgICAgICAgICAgIGlmIChoaWpvc1NjcmVlbikKICAgICAgICAgICAgICAgICAgICBoaWpvc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2RldGFpbHMnOgogICAgICAgICAgICAgICAgaWYgKGRuaURldGFpbHNTY3JlZW4pCiAgICAgICAgICAgICAgICAgICAgZG5pRGV0YWlsc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3RlbGVmb25vcyc6CiAgICAgICAgICAgICAgICBpZiAodGVsZWZvbm9zU2NyZWVuKQogICAgICAgICAgICAgICAgICAgIHRlbGVmb25vc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gc2hvd0RuaURpZ2l0YWxWaWV3KCkgewogICAgICAgIGlmIChkbmlJbml0aWFsVmlldykKICAgICAgICAgICAgZG5pSW5pdGlhbFZpZXcuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBpZiAoZG5pU29saWNpdHVkVmlldykKICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkbmlEaWdpdGFsRGlzcGxheSkKICAgICAgICAgICAgZG5pRGlnaXRhbERpc3BsYXkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgaWYgKGRuaUNhcmRIZWFkZXIpCiAgICAgICAgICAgIGRuaUNhcmRIZWFkZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBpZiAoZG5pQ2FyZEJvZHkpCiAgICAgICAgICAgIGRuaUNhcmRCb2R5LmNsYXNzTGlzdC5hZGQoJ25vLWhlYWRlcicpOwogICAgICAgIGlmIChkb2N1bWVudG9zSGVhZGVyVGl0bGUpCiAgICAgICAgICAgIGRvY3VtZW50b3NIZWFkZXJUaXRsZS50ZXh0Q29udGVudCA9ICdETkkgRGlnaXRhbCc7CiAgICAgICAgaWYgKHJlZnJlc2hJY29uKQogICAgICAgICAgICByZWZyZXNoSWNvbi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICBpZiAoZG9jdW1lbnRvc0hlYWRlcikKICAgICAgICAgICAgZG9jdW1lbnRvc0hlYWRlci5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdzcGFjZS1iZXR3ZWVuJzsKICAgIH0KICAgIGZ1bmN0aW9uIHBvcHVsYXRlRG5pRGV0YWlscygpIHsKICAgICAgICAvLyBHZXQgdmFsdWVzIGZyb20gdGhlIGlucHV0IGZpZWxkcyBvbiB0aGUgImhpam9zIiAoZWRpdG9yKSBzY3JlZW4KICAgICAgICBjb25zdCBkbmkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgdHJhbWl0ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0cmFtaXRlLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgZW1pc2lvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbWlzaW9uLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgdmVuY2ltaWVudG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVuY2ltaWVudG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBub21icmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbm9tYnJlLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgYXBlbGxpZG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBlbGxpZG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBzZXhvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NleG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBuYWNpbWllbnRvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25hY2ltaWVudG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBkb21pY2lsaW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9taWNpbGlvLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgY3VpbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlsLWlucHV0JykudmFsdWU7CiAgICAgICAgLy8gSGFyZGNvZGVkIGRhdGEgZm9yIG5vbi1lZGl0YWJsZSBmaWVsZHMgKGZvciBub3cpCiAgICAgICAgY29uc3QgbmFjaW9uYWxpZGFkID0gJ0FSJzsKICAgICAgICBjb25zdCBsdWdhck5hY2ltaWVudG8gPSAnQVJHRU5UaW5hJzsKICAgICAgICAvLyBQb3B1bGF0ZSB0aGUgZGV0YWlscyBzY3JlZW4gd2l0aCB0aGUgcmV0cmlldmVkIHZhbHVlcwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWRuaScpLnRleHRDb250ZW50ID0gZG5pOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLXRyYW1pdGUnKS50ZXh0Q29udGVudCA9IHRyYW1pdGU7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtZW1pc2lvbicpLnRleHRDb250ZW50ID0gZW1pc2lvbjsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy12ZW5jaW1pZW50bycpLnRleHRDb250ZW50ID0gdmVuY2ltaWVudG87CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtbm9tYnJlJykudGV4dENvbnRlbnQgPSBub21icmU7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtYXBlbGxpZG8nKS50ZXh0Q29udGVudCA9IGFwZWxsaWRvOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWN1aWwnKS50ZXh0Q29udGVudCA9IGN1aWw7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtc2V4bycpLnRleHRDb250ZW50ID0gc2V4bzsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy1uYWNpbWllbnRvJykudGV4dENvbnRlbnQgPSBuYWNpbWllbnRvOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLW5hY2lvbmFsaWRhZCcpLnRleHRDb250ZW50ID0gbmFjaW9uYWxpZGFkOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWx1Z2FyLW5hY2ltaWVudG8nKS50ZXh0Q29udGVudCA9IGx1Z2FyTmFjaW1pZW50bzsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy1kb21pY2lsaW8nKS50ZXh0Q29udGVudCA9IGRvbWljaWxpbzsKICAgIH0KICAgIGlmIChkb2N1bWVudG9zQnRuKSB7CiAgICAgICAgZG9jdW1lbnRvc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSB7CiAgICAgICAgICAgICAgICBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHNob3dTY3JlZW4oJ2RvY3VtZW50b3MnKTsKICAgICAgICAgICAgICAgIGlmIChsb2FkaW5nT3ZlcmxheSkgewogICAgICAgICAgICAgICAgICAgIGxvYWRpbmdPdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJEbmlEaWdpdGFsQnRuKSB7CiAgICAgICAgdmVyRG5pRGlnaXRhbEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgewogICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgc2hvd0RuaURpZ2l0YWxWaWV3KCk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uTG9hZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChoaWpvc0J0bikgewogICAgICAgIGhpam9zQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzaG93U2NyZWVuKCdoaWpvcycpOwogICAgICAgIH0pOwogICAgfQogICAgaWYgKGJhY2tCdG4pIHsKICAgICAgICBiYWNrQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBpZiAoZG5pRGlnaXRhbERpc3BsYXkgJiYgZ2V0Q29tcHV0ZWRTdHlsZShkbmlEaWdpdGFsRGlzcGxheSkuZGlzcGxheSAhPT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICByZXNldERuaUNhcmQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3dTY3JlZW4oJ21haW4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGRldGFpbHNCYWNrQnRuKSB7CiAgICAgICAgZGV0YWlsc0JhY2tCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHNob3dTY3JlZW4oJ2RvY3VtZW50b3MnKTsKICAgICAgICAgICAgc2hvd0RuaURpZ2l0YWxWaWV3KCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoaGlqb3NCYWNrQnRuKSB7CiAgICAgICAgaGlqb3NCYWNrQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzaG93U2NyZWVuKCdtYWluJyk7CiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoaW5pY2lvQnRuKSB7CiAgICAgICAgaW5pY2lvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzaG93U2NyZWVuKCdtYWluJyk7CiAgICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBoYW5kbGVUZWxlZm9ub3NOYXYgPSAoZSkgPT4gewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBpZiAobG9hZGluZ092ZXJsYXkpIHsKICAgICAgICAgICAgbG9hZGluZ092ZXJsYXkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBzaG93U2NyZWVuKCd0ZWxlZm9ub3MnKTsKICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSB7CiAgICAgICAgICAgICAgICBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIDE1MDApOwogICAgfTsKICAgIGlmICh0ZWxlZm9ub3NCdG5Eb2NzKSB7CiAgICAgICAgdGVsZWZvbm9zQnRuRG9jcy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRlbGVmb25vc05hdik7CiAgICB9CiAgICBpZiAodGVsZWZvbm9zQnRuRGV0YWlscykgewogICAgICAgIHRlbGVmb25vc0J0bkRldGFpbHMuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUZWxlZm9ub3NOYXYpOwogICAgfQogICAgaWYgKHRlbGVmb25vc0luaWNpb0J0bikgewogICAgICAgIHRlbGVmb25vc0luaWNpb0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSB7CiAgICAgICAgICAgICAgICBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHNob3dTY3JlZW4oJ21haW4nKTsKICAgICAgICAgICAgICAgIGlmIChsb2FkaW5nT3ZlcmxheSkgewogICAgICAgICAgICAgICAgICAgIGxvYWRpbmdPdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChzb2xpY2l0YXJEbmlCdG4pIHsKICAgICAgICBzb2xpY2l0YXJEbmlCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGlmIChhY3Rpb25Mb2FkZXIpIHsKICAgICAgICAgICAgICAgIGFjdGlvbkxvYWRlci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChkbmlJbml0aWFsVmlldykKICAgICAgICAgICAgICAgICAgICBkbmlJbml0aWFsVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKGRuaUNhcmRIZWFkZXIpCiAgICAgICAgICAgICAgICAgICAgZG5pQ2FyZEhlYWRlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKGRuaVNvbGljaXR1ZFZpZXcpCiAgICAgICAgICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGlmIChkbmlDYXJkQm9keSkKICAgICAgICAgICAgICAgICAgICBkbmlDYXJkQm9keS5jbGFzc0xpc3QuYWRkKCduby1oZWFkZXInKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25Mb2FkZXIpIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Mb2FkZXIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDE1MDApOwogICAgICAgIH0pOwogICAgfQogICAgaWYgKGNvbmZpcm1hclNvbGljaXR1ZEJ0bikgewogICAgICAgIGNvbmZpcm1hclNvbGljaXR1ZEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgewogICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRuaVNvbGljaXR1ZFZpZXcpCiAgICAgICAgICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgc2hvd0RuaURpZ2l0YWxWaWV3KCk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uTG9hZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJEZXRhbGxlQnRuKSB7CiAgICAgICAgdmVyRGV0YWxsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcG9wdWxhdGVEbmlEZXRhaWxzKCk7CiAgICAgICAgICAgIHNob3dTY3JlZW4oJ2RldGFpbHMnKTsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIFVzZXIgTWVudSBMb2dpYwogICAgaWYgKHVzZXJQcm9maWxlQnRuICYmIHVzZXJNZW51ICYmIHByb2ZpbGVBcnJvdykgewogICAgICAgIHVzZXJQcm9maWxlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudHMgdGhlIGRvY3VtZW50IGNsaWNrIGxpc3RlbmVyIGZyb20gZmlyaW5nIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVzZXJNZW51LmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScpOwogICAgICAgICAgICBwcm9maWxlQXJyb3cuY2xhc3NMaXN0LnRvZ2dsZSgncm90YXRlZCcpOwogICAgICAgIH0pOwogICAgICAgIC8vIENsb3NlIG1lbnUgd2hlbiBjbGlja2luZyBvdXRzaWRlCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICBpZiAodXNlck1lbnUuY2xhc3NMaXN0LmNvbnRhaW5zKCdhY3RpdmUnKSkgewogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgY2xpY2sgaXMgb3V0c2lkZSB0aGUgbWVudSBBTkQgbm90IG9uIHRoZSBwcm9maWxlIGJ1dHRvbiBpdHNlbGYKICAgICAgICAgICAgICAgIGlmICghdXNlck1lbnUuY29udGFpbnModGFyZ2V0KSAmJiAhdXNlclByb2ZpbGVCdG4uY29udGFpbnModGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgIHVzZXJNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHByb2ZpbGVBcnJvdy5jbGFzc0xpc3QucmVtb3ZlKCdyb3RhdGVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIC8vIExpbmsgZnJvbSBtZW51IHRvIEhpam9zIHNjcmVlbgogICAgaWYgKG1lbnVIaWpvc0J0bikgewogICAgICAgIG1lbnVIaWpvc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgc2hvd1NjcmVlbignaGlqb3MnKTsKICAgICAgICAgICAgLy8gQ2xvc2UgbWVudSBhZnRlciBuYXZpZ2F0aW9uCiAgICAgICAgICAgIGlmICh1c2VyTWVudSAmJiBwcm9maWxlQXJyb3cpIHsKICAgICAgICAgICAgICAgIHVzZXJNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgcHJvZmlsZUFycm93LmNsYXNzTGlzdC5yZW1vdmUoJ3JvdGF0ZWQnKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgLy8gUHJldmVudCBpbmFjdGl2ZSBtZW51IGxpbmtzIGZyb20gbmF2aWdhdGluZwogICAgaWYgKHVzZXJNZW51ICYmIHByb2ZpbGVBcnJvdykgewogICAgICAgIGNvbnN0IGluYWN0aXZlTGlua3MgPSB1c2VyTWVudS5xdWVyeVNlbGVjdG9yQWxsKCcudXNlci1tZW51LWxpc3QgYTpub3QoI21lbnUtaGlqb3MtYnRuKSwgLnVzZXItbWVudS1mb290ZXIgYScpOwogICAgICAgIGluYWN0aXZlTGlua3MuZm9yRWFjaChsaW5rID0+IHsKICAgICAgICAgICAgbGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB1c2VyTWVudS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVBcnJvdy5jbGFzc0xpc3QucmVtb3ZlKCdyb3RhdGVkJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgLy8gRE5JIENhcmQgQ29sbGFwc2UvRXhwYW5kIExvZ2ljCiAgICBjb25zdCBkbmlDYXJkID0gZG9jdW1lbnRvc1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcuZG5pLWNhcmQnKTsKICAgIGlmIChkbmlDYXJkSGVhZGVyICYmIGRuaUNhcmQpIHsKICAgICAgICBkbmlDYXJkSGVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAvLyBPbmx5IGFsbG93IGNvbGxhcHNpbmcgaWYgdGhlIGluaXRpYWwgb3Igc29saWNpdHVkIHZpZXcgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBpc0luaXRpYWxTdGF0ZSA9IGdldENvbXB1dGVkU3R5bGUoZG5pSW5pdGlhbFZpZXcpLmRpc3BsYXkgIT09ICdub25lJyB8fCBnZXRDb21wdXRlZFN0eWxlKGRuaVNvbGljaXR1ZFZpZXcpLmRpc3BsYXkgIT09ICdub25lJzsKICAgICAgICAgICAgaWYgKGlzSW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgICBkbmlDYXJkLmNsYXNzTGlzdC50b2dnbGUoJ2lzLWNvbGxhcHNlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyBETkkgRmxpcHBlciBMb2dpYwogICAgY29uc3QgZG5pRmxpcHBlckNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kbmktZmxpcHBlci1jb250YWluZXInKTsKICAgIGNvbnN0IGRuaUZsaXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWZsaXBwZXInKTsKICAgIGlmIChkbmlGbGlwcGVyQ29udGFpbmVyICYmIGRuaUZsaXBwZXIpIHsKICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGxldCBzdGFydFggPSAwOwogICAgICAgIGxldCBzdGFydEFuZ2xlID0gMDsKICAgICAgICBsZXQgY3VycmVudEFuZ2xlID0gMDsKICAgICAgICBjb25zdCBnZXRFdmVudFggPSAoZSkgPT4gewogICAgICAgICAgICByZXR1cm4gZS50eXBlLmluY2x1ZGVzKCdtb3VzZScpID8gZS5zY3JlZW5YIDogZS5jaGFuZ2VkVG91Y2hlc1swXS5zY3JlZW5YOwogICAgICAgIH07CiAgICAgICAgY29uc3QgaGFuZGxlRHJhZ1N0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ21vdXNlZG93bicgJiYgZS5idXR0b24gIT09IDApCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBzdGFydFggPSBnZXRFdmVudFgoZSk7CiAgICAgICAgICAgIHN0YXJ0QW5nbGUgPSBjdXJyZW50QW5nbGU7CiAgICAgICAgICAgIGRuaUZsaXBwZXIuc3R5bGUudHJhbnNpdGlvbiA9ICdub25lJzsgLy8gTm8gdHJhbnNpdGlvbiB3aGlsZSBkcmFnZ2luZwogICAgICAgICAgICBpZiAoZS50eXBlICE9PSAndG91Y2hzdGFydCcpIHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgY29uc3QgaGFuZGxlRHJhZ01vdmUgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBzY3JvbGxpbmcgd2hpbGUgZHJhZ2dpbmcgY2FyZAogICAgICAgICAgICBjb25zdCBjdXJyZW50WCA9IGdldEV2ZW50WChlKTsKICAgICAgICAgICAgY29uc3QgZGVsdGFYID0gY3VycmVudFggLSBzdGFydFg7CiAgICAgICAgICAgIC8vIEEgZnVsbCBkcmFnIGFjcm9zcyB0aGUgY2FyZCB3aWR0aCBzaG91bGQgYmUgYWJvdXQgYSAxODAtZGVncmVlIHR1cm4KICAgICAgICAgICAgY29uc3Qgcm90YXRpb25TZW5zaXRpdml0eSA9IDE4MCAvIGRuaUZsaXBwZXJDb250YWluZXIub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIGNvbnN0IGRlbHRhQW5nbGUgPSBkZWx0YVggKiByb3RhdGlvblNlbnNpdGl2aXR5OwogICAgICAgICAgICBjdXJyZW50QW5nbGUgPSBzdGFydEFuZ2xlICsgZGVsdGFBbmdsZTsKICAgICAgICAgICAgZG5pRmxpcHBlci5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlWSgke2N1cnJlbnRBbmdsZX1kZWcpYDsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGhhbmRsZURyYWdFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZG5pRmxpcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3RyYW5zZm9ybSAwLjZzIGN1YmljLWJlemllcigwLjM0LCAxLjU2LCAwLjY0LCAxKSc7CiAgICAgICAgICAgIC8vIFNuYXAgdG8gdGhlIG5lYXJlc3QgMTgwLWRlZ3JlZSBzaWRlCiAgICAgICAgICAgIGNvbnN0IGZpbmFsUm90YXRpb24gPSBNYXRoLnJvdW5kKGN1cnJlbnRBbmdsZSAvIDE4MCkgKiAxODA7CiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbG9naWNhbCBzdGF0ZSBiYXNlZCBvbiB0aGUgZmluYWwgYW5nbGUKICAgICAgICAgICAgLy8gVXNlIG1vZHVsbyB0byBoYW5kbGUgbXVsdGlwbGUgc3BpbnMsIHRob3VnaCB1bmxpa2VseQogICAgICAgICAgICBpc0ZsaXBwZWQgPSAoTWF0aC5yb3VuZChmaW5hbFJvdGF0aW9uIC8gMTgwKSAlIDIpICE9PSAwOwogICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9IGByb3RhdGVZKCR7ZmluYWxSb3RhdGlvbn1kZWcpYDsKICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gZmluYWxSb3RhdGlvbjsgLy8gU3RvcmUgdGhlIGZpbmFsIGFuZ2xlCiAgICAgICAgfTsKICAgICAgICAvLyBNb3VzZSBldmVudHMKICAgICAgICBkbmlGbGlwcGVyQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZURyYWdTdGFydCk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlRHJhZ01vdmUpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVEcmFnRW5kKTsKICAgICAgICAvLyBUb3VjaCBldmVudHMgLSBwYXNzaXZlOiBmYWxzZSBpcyByZXF1aXJlZCB0byBjYWxsIGUucHJldmVudERlZmF1bHQoKSBpbiB0aGUgbW92ZSBoYW5kbGVyCiAgICAgICAgZG5pRmxpcHBlckNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlRHJhZ1N0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZURyYWdNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRHJhZ0VuZCk7CiAgICB9CiAgICAvLyBIaWpvcyBETkkgRmxpcHBlciBMb2dpYwogICAgY29uc3QgaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1mbGlwcGVyLWNvbnRhaW5lcicpOwogICAgY29uc3QgaGlqb3NEbmlGbGlwcGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1mbGlwcGVyJyk7CiAgICBpZiAoaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyICYmIGhpam9zRG5pRmxpcHBlcikgewogICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgbGV0IHN0YXJ0WCA9IDA7CiAgICAgICAgbGV0IHN0YXJ0QW5nbGUgPSAwOwogICAgICAgIGxldCBjdXJyZW50QW5nbGUgPSAwOwogICAgICAgIGNvbnN0IGdldEV2ZW50WCA9IChlKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBlLnR5cGUuaW5jbHVkZXMoJ21vdXNlJykgPyBlLnNjcmVlblggOiBlLmNoYW5nZWRUb3VjaGVzWzBdLnNjcmVlblg7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBoYW5kbGVEcmFnU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50eXBlID09PSAnbW91c2Vkb3duJyAmJiBlLmJ1dHRvbiAhPT0gMCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGdldEV2ZW50WChlKTsKICAgICAgICAgICAgc3RhcnRBbmdsZSA9IGN1cnJlbnRBbmdsZTsKICAgICAgICAgICAgaGlqb3NEbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAnbm9uZSc7IC8vIE5vIHRyYW5zaXRpb24gd2hpbGUgZHJhZ2dpbmcKICAgICAgICAgICAgaWYgKGUudHlwZSAhPT0gJ3RvdWNoc3RhcnQnKSB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IGhhbmRsZURyYWdNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7IC8vIHByZXZlbnQgc2Nyb2xsaW5nIHdoaWxlIGRyYWdnaW5nIGNhcmQKICAgICAgICAgICAgY29uc3QgY3VycmVudFggPSBnZXRFdmVudFgoZSk7CiAgICAgICAgICAgIGNvbnN0IGRlbHRhWCA9IGN1cnJlbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBjb25zdCByb3RhdGlvblNlbnNpdGl2aXR5ID0gMTgwIC8gaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyLm9mZnNldFdpZHRoOwogICAgICAgICAgICBjb25zdCBkZWx0YUFuZ2xlID0gZGVsdGFYICogcm90YXRpb25TZW5zaXRpdml0eTsKICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gc3RhcnRBbmdsZSArIGRlbHRhQW5nbGU7CiAgICAgICAgICAgIGhpam9zRG5pRmxpcHBlci5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlWSgke2N1cnJlbnRBbmdsZX1kZWcpYDsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGhhbmRsZURyYWdFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgaGlqb3NEbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAndHJhbnNmb3JtIDAuNnMgY3ViaWMtYmV6aWVyKDAuMzQsIDEuNTYsIDAuNjQsIDEpJzsKICAgICAgICAgICAgY29uc3QgZmluYWxSb3RhdGlvbiA9IE1hdGgucm91bmQoY3VycmVudEFuZ2xlIC8gMTgwKSAqIDE4MDsKICAgICAgICAgICAgaGlqb3NEbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9IGByb3RhdGVZKCR7ZmluYWxSb3RhdGlvbn1kZWcpYDsKICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gZmluYWxSb3RhdGlvbjsKICAgICAgICB9OwogICAgICAgIC8vIE1vdXNlIGV2ZW50cwogICAgICAgIGhpam9zRG5pRmxpcHBlckNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVEcmFnU3RhcnQpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZURyYWdNb3ZlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRHJhZ0VuZCk7CiAgICAgICAgLy8gVG91Y2ggZXZlbnRzCiAgICAgICAgaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVEcmFnU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlRHJhZ01vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVEcmFnRW5kKTsKICAgIH0KICAgIC8vIEhpam9zIENhcm91c2VsIExvZ2ljCiAgICBjb25zdCBjYXJvdXNlbFdyYXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtY2Fyb3VzZWwtd3JhcHBlcicpOwogICAgY29uc3QgY2Fyb3VzZWxUcmFjayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWpvcy1jYXJvdXNlbC10cmFjaycpOwogICAgY29uc3Qgc2xpZGVzID0gQXJyYXkuZnJvbShjYXJvdXNlbFRyYWNrLmNoaWxkcmVuKTsKICAgIGNvbnN0IGRvdHNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtY2Fyb3VzZWwtZG90cycpOwogICAgaWYgKGNhcm91c2VsV3JhcHBlciAmJiBjYXJvdXNlbFRyYWNrICYmIHNsaWRlcy5sZW5ndGggPiAwICYmIGRvdHNDb250YWluZXIpIHsKICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gMDsKICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGxldCBzdGFydFBvcyA9IDA7CiAgICAgICAgbGV0IGN1cnJlbnRUcmFuc2xhdGUgPSAwOwogICAgICAgIGxldCBwcmV2VHJhbnNsYXRlID0gMDsKICAgICAgICBsZXQgYW5pbWF0aW9uSUQ7CiAgICAgICAgY29uc3Qgc2xpZGVXaWR0aCA9ICgpID0+IHNsaWRlc1swXS5vZmZzZXRXaWR0aDsKICAgICAgICAvLyBDcmVhdGUgZG90cwogICAgICAgIHNsaWRlcy5mb3JFYWNoKChfLCBpKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgZG90LmNsYXNzTGlzdC5hZGQoJ2Nhcm91c2VsLWRvdCcpOwogICAgICAgICAgICBpZiAoaSA9PT0gMCkKICAgICAgICAgICAgICAgIGRvdC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgZG90LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgZ29Ub1NsaWRlKGkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG90c0NvbnRhaW5lci5hcHBlbmRDaGlsZChkb3QpOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGRvdHMgPSBBcnJheS5mcm9tKGRvdHNDb250YWluZXIuY2hpbGRyZW4pOwogICAgICAgIGZ1bmN0aW9uIGdvVG9TbGlkZShzbGlkZUluZGV4KSB7CiAgICAgICAgICAgIGlmIChzbGlkZUluZGV4IDwgMCB8fCBzbGlkZUluZGV4ID49IHNsaWRlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IC1zbGlkZUluZGV4ICogc2xpZGVXaWR0aCgpOwogICAgICAgICAgICBjYXJvdXNlbFRyYWNrLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVYKCR7b2Zmc2V0fXB4KWA7CiAgICAgICAgICAgIGNhcm91c2VsVHJhY2suc3R5bGUudHJhbnNpdGlvbiA9ICd0cmFuc2Zvcm0gMC4zcyBlYXNlLWluLW91dCc7CiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IHNsaWRlSW5kZXg7CiAgICAgICAgICAgIHVwZGF0ZURvdHMoKTsKICAgICAgICAgICAgcHJldlRyYW5zbGF0ZSA9IG9mZnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRG90cygpIHsKICAgICAgICAgICAgZG90cy5mb3JFYWNoKChkb3QsIGkpID0+IHsKICAgICAgICAgICAgICAgIGRvdC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCBpID09PSBjdXJyZW50SW5kZXgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2V0UG9zaXRpb25YID0gKGUpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGUudHlwZS5pbmNsdWRlcygnbW91c2UnKSA/IGUucGFnZVggOiBlLnRvdWNoZXNbMF0uY2xpZW50WDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHRvdWNoU3RhcnQoaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN0YXJ0UG9zID0gZ2V0UG9zaXRpb25YKGUpOwogICAgICAgICAgICAgICAgYW5pbWF0aW9uSUQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uKTsKICAgICAgICAgICAgICAgIGNhcm91c2VsVHJhY2suc3R5bGUudHJhbnNpdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG91Y2hNb3ZlKGUpIHsKICAgICAgICAgICAgaWYgKGlzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQb3NpdGlvbiA9IGdldFBvc2l0aW9uWChlKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSBwcmV2VHJhbnNsYXRlICsgY3VycmVudFBvc2l0aW9uIC0gc3RhcnRQb3M7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG91Y2hFbmQoKSB7CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uSUQpOwogICAgICAgICAgICBjb25zdCBtb3ZlZEJ5ID0gY3VycmVudFRyYW5zbGF0ZSAtIHByZXZUcmFuc2xhdGU7CiAgICAgICAgICAgIC8vIFNuYXAgbG9naWMKICAgICAgICAgICAgaWYgKG1vdmVkQnkgPCAtMTAwICYmIGN1cnJlbnRJbmRleCA8IHNsaWRlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggKz0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobW92ZWRCeSA+IDEwMCAmJiBjdXJyZW50SW5kZXggPiAwKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggLT0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnb1RvU2xpZGUoY3VycmVudEluZGV4KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uKCkgewogICAgICAgICAgICBzZXRTbGlkZXJQb3NpdGlvbigpOwogICAgICAgICAgICBpZiAoaXNEcmFnZ2luZykKICAgICAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRpb24pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTbGlkZXJQb3NpdGlvbigpIHsKICAgICAgICAgICAgY2Fyb3VzZWxUcmFjay5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlWCgke2N1cnJlbnRUcmFuc2xhdGV9cHgpYDsKICAgICAgICB9CiAgICAgICAgLy8gRXZlbnQgTGlzdGVuZXJzCiAgICAgICAgc2xpZGVzLmZvckVhY2goKHNsaWRlLCBpbmRleCkgPT4gewogICAgICAgICAgICBjb25zdCBzbGlkZUltYWdlID0gc2xpZGUucXVlcnlTZWxlY3RvcignaW1nJyk7CiAgICAgICAgICAgIGlmIChzbGlkZUltYWdlKQogICAgICAgICAgICAgICAgc2xpZGVJbWFnZS5hZGRFdmVudExpc3RlbmVyKCdkcmFnc3RhcnQnLCAoZSkgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnRIYW5kbGVyID0gdG91Y2hTdGFydChpbmRleCk7CiAgICAgICAgICAgIGNvbnN0IGludGVyYWN0aW9uU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7CiAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IHN0YXJ0aW5nIGEgZHJhZyBpZiB0aGUgdXNlciBpcyBpbnRlcmFjdGluZyB3aXRoIGFueSBjb250cm9sIGVsZW1lbnQgb3IgaXRzIGNvbnRhaW5lci4KICAgICAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIHNsaWRlcnMgYW5kIGlucHV0cyB0byBiZSB1c2VkIHdpdGhvdXQgbW92aW5nIHRoZSBjYXJvdXNlbC4KICAgICAgICAgICAgICAgIGlmICh0YXJnZXQuY2xvc2VzdCgnLmNvbnRyb2wtZ3JvdXAnKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXJ0SGFuZGxlcihlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gVG91Y2ggZXZlbnRzCiAgICAgICAgICAgIHNsaWRlLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBpbnRlcmFjdGlvblN0YXJ0KTsKICAgICAgICAgICAgc2xpZGUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0b3VjaEVuZCk7CiAgICAgICAgICAgIHNsaWRlLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRvdWNoTW92ZSk7CiAgICAgICAgICAgIC8vIE1vdXNlIGV2ZW50cwogICAgICAgICAgICBzbGlkZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBpbnRlcmFjdGlvblN0YXJ0KTsKICAgICAgICAgICAgc2xpZGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRvdWNoRW5kKTsKICAgICAgICAgICAgc2xpZGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChpc0RyYWdnaW5nKQogICAgICAgICAgICAgICAgICAgIHRvdWNoRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzbGlkZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0b3VjaE1vdmUpOwogICAgICAgIH0pOwogICAgICAgIC8vIFJlc2l6ZSBvYnNlcnZlcgogICAgICAgIGNvbnN0IHJlc2l6ZU9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKCgpID0+IHsKICAgICAgICAgICAgZ29Ub1NsaWRlKGN1cnJlbnRJbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgcmVzaXplT2JzZXJ2ZXIub2JzZXJ2ZShjYXJvdXNlbFdyYXBwZXIpOwogICAgfQogICAgLy8gRXhwb3J0IEhUTUwgbG9naWMKICAgIGNvbnN0IGV4cG9ydEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleHBvcnQtaHRtbC1idG4nKTsKICAgIGZ1bmN0aW9uIGdlbmVyYXRlQW5kRG93bmxvYWRIdG1sKCkgewogICAgICAgIGNvbnN0IHRlbXBIZWFkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaGVhZCcpOwogICAgICAgIHRlbXBIZWFkLmlubmVySFRNTCA9IGRvY3VtZW50LmhlYWQuaW5uZXJIVE1MOwogICAgICAgIC8vIFJlbW92ZSBhbnkgcG90ZW50aWFsbHkgcHJvYmxlbWF0aWMgb3IgZHVwbGljYXRlZCBpY29uIGxpbmtzCiAgICAgICAgdGVtcEhlYWQucXVlcnlTZWxlY3RvckFsbCgnbGlua1tyZWw9Imljb24iXSwgbGlua1tyZWw9InNob3J0Y3V0IGljb24iXSwgbGlua1tyZWw9ImFwcGxlLXRvdWNoLWljb24iXScpLmZvckVhY2gobGluayA9PiBsaW5rLnJlbW92ZSgpKTsKICAgICAgICAvLyBBZGQgdGhlIGNvcnJlY3QsIHVzZXItc3BlY2lmaWVkIGljb24gbGluawogICAgICAgIGNvbnN0IGZhdmljb25MaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwogICAgICAgIGZhdmljb25MaW5rLnJlbCA9ICdpY29uJzsKICAgICAgICBmYXZpY29uTGluay5ocmVmID0gJ2h0dHBzOi8vaWlsaS5pby9LWFJCbnRhLmpwZyc7CiAgICAgICAgZmF2aWNvbkxpbmsudHlwZSA9ICdpbWFnZS9qcGVnJzsKICAgICAgICB0ZW1wSGVhZC5hcHBlbmRDaGlsZChmYXZpY29uTGluayk7CiAgICAgICAgLy8gQWxzbyBhZGQgYXBwbGUtdG91Y2gtaWNvbiBmb3IgZ29vZCBtZWFzdXJlCiAgICAgICAgY29uc3QgYXBwbGVUb3VjaEljb25MaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwogICAgICAgIGFwcGxlVG91Y2hJY29uTGluay5yZWwgPSAnYXBwbGUtdG91Y2gtaWNvbic7CiAgICAgICAgYXBwbGVUb3VjaEljb25MaW5rLmhyZWYgPSAnaHR0cHM6Ly9paWxpLmlvL0tYUkJudGEuanBnJzsKICAgICAgICB0ZW1wSGVhZC5hcHBlbmRDaGlsZChhcHBsZVRvdWNoSWNvbkxpbmspOwogICAgICAgIGNvbnN0IGhlYWRDb250ZW50ID0gdGVtcEhlYWQuaW5uZXJIVE1MOwogICAgICAgIGNvbnN0IGJvZHlDbG9uZSA9IGRvY3VtZW50LmJvZHkuY2xvbmVOb2RlKHRydWUpOwogICAgICAgIGNvbnN0IGhpam9zU2NyZWVuQ2xvbmUgPSBib2R5Q2xvbmUucXVlcnlTZWxlY3RvcignI2hpam9zLXNjcmVlbicpOwogICAgICAgIGlmIChoaWpvc1NjcmVlbkNsb25lKQogICAgICAgICAgICBoaWpvc1NjcmVlbkNsb25lLnJlbW92ZSgpOwogICAgICAgIGNvbnN0IHNjcmlwdFRhZ0Nsb25lID0gYm9keUNsb25lLnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdFtzcmM9ImluZGV4LnRzeCJdJyk7CiAgICAgICAgaWYgKHNjcmlwdFRhZ0Nsb25lKQogICAgICAgICAgICBzY3JpcHRUYWdDbG9uZS5yZW1vdmUoKTsKICAgICAgICBjb25zdCBhcHBseUFsbER5bmFtaWNEYXRhVG9DbG9uZSA9IChjbG9uZSkgPT4gewogICAgICAgICAgICBjb25zdCBnZXRMaXZlVmFsdWUgPSAoaWQpID0+IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKT8udmFsdWUgfHwgJyc7CiAgICAgICAgICAgIGNvbnN0IHNldENsb25lVGV4dCA9IChzZWxlY3RvciwgdmFsdWUsIGlzVXBwZXJjYXNlID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgICAgIGNsb25lLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpLmZvckVhY2goZWwgPT4gewogICAgICAgICAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gaXNVcHBlcmNhc2UgPyB2YWx1ZS50b1VwcGVyQ2FzZSgpIDogdmFsdWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc3Qgc2V0Q2xvbmVTcmMgPSAoc2VsZWN0b3IsIHZhbHVlKSA9PiB7CiAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKS5mb3JFYWNoKGVsID0+IHsKICAgICAgICAgICAgICAgICAgICBlbC5zcmMgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCBhcHBseVN0eWxlRnJvbVNsaWRlciA9IChjbG9uZSwgZmllbGQsIHByb3BlcnR5LCB1bml0KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGdldExpdmVWYWx1ZShgJHtmaWVsZH0tJHtwcm9wZXJ0eS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ3NpemUnLCAnJykucmVwbGFjZSgnZmFtaWx5JywgJycpfS1zbGlkZXJgKSB8fCBnZXRMaXZlVmFsdWUoYCR7ZmllbGR9LSR7cHJvcGVydHkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdzaXplJywgJycpLnJlcGxhY2UoJ2ZhbWlseScsICcnKX0tc2VsZWN0YCk7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKGAjbWFpbi1kbmktJHtmaWVsZH0sICNoaWpvcy1kbmktJHtmaWVsZH1gKS5mb3JFYWNoKGVsID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbcHJvcGVydHldID0gYCR7dmFsdWV9JHt1bml0fWA7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIC0tLSBBcHBseSBJbWFnZSBVUkxzIGFuZCBTdHlsZXMgLS0tCiAgICAgICAgICAgIHNldENsb25lU3JjKCcjbWFpbi1kbmktcHJvZmlsZS1pbWFnZSwgI2RldGFpbHMtcHJvZmlsZS1pbWFnZScsIGdldExpdmVWYWx1ZSgnaW1hZ2UtdXJsLWlucHV0JykpOwogICAgICAgICAgICBzZXRDbG9uZVNyYygnI21haW4tZG5pLWJhY2staW1hZ2UnLCBnZXRMaXZlVmFsdWUoJ2RuaS1iYWNrLXVybC1pbnB1dCcpKTsKICAgICAgICAgICAgc2V0Q2xvbmVTcmMoJyNtYWluLWRuaS1xci1pbWFnZSwgI2RldGFpbHMtYmFyY29kZS1pbWFnZScsIGdldExpdmVWYWx1ZSgncXItdXJsLWlucHV0JykpOwogICAgICAgICAgICBbJ3RvcCcsICdsZWZ0JywgJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2gocHJvcCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBnZXRMaXZlVmFsdWUoYCR7cHJvcH0tc2xpZGVyYCk7CiAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKCcjbWFpbi1kbmktcHJvZmlsZS1waWMnKS5mb3JFYWNoKGVsID0+IGVsLnN0eWxlW3Byb3BdID0gYCR7dmFsfSVgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIFsndG9wJywgJ2xlZnQnLCAnd2lkdGgnLCAnaGVpZ2h0J10uZm9yRWFjaChwcm9wID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGdldExpdmVWYWx1ZShgcXItJHtwcm9wfS1zbGlkZXJgKTsKICAgICAgICAgICAgICAgIGNsb25lLnF1ZXJ5U2VsZWN0b3JBbGwoJyNtYWluLWRuaS1xci1waWMnKS5mb3JFYWNoKGVsID0+IGVsLnN0eWxlW3Byb3BdID0gYCR7dmFsfSVgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIC0tLSBBcHBseSBUZXh0IENvbnRlbnQgYW5kIFN0eWxlcyAtLS0KICAgICAgICAgICAgY29uc3QgYWxsVGV4dEZpZWxkcyA9IFsnYXBlbGxpZG8nLCAnbm9tYnJlJywgJ2RvY3VtZW50bycsICduYWNpbWllbnRvJywgJ3RyYW1pdGUnLCAnZWplbXBsYXInLCAnZW1pc2lvbicsICd2ZW5jaW1pZW50bycsICdkb21pY2lsaW8nLCAnc2V4bycsICdjdWlsJ107CiAgICAgICAgICAgIGFsbFRleHRGaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGdldExpdmVWYWx1ZShgJHtmaWVsZH0taW5wdXRgKTsKICAgICAgICAgICAgICAgIHNldENsb25lVGV4dChgI21haW4tZG5pLSR7ZmllbGR9YCwgdmFsdWUsIFsnYXBlbGxpZG8nLCAnc2V4bycsICdkb21pY2lsaW8nXS5pbmNsdWRlcyhmaWVsZCkpOwogICAgICAgICAgICAgICAgYXBwbHlTdHlsZUZyb21TbGlkZXIoY2xvbmUsIGZpZWxkLCAndG9wJywgJyUnKTsKICAgICAgICAgICAgICAgIGFwcGx5U3R5bGVGcm9tU2xpZGVyKGNsb25lLCBmaWVsZCwgJ2xlZnQnLCAnJScpOwogICAgICAgICAgICAgICAgYXBwbHlTdHlsZUZyb21TbGlkZXIoY2xvbmUsIGZpZWxkLCAnZm9udFNpemUnLCAncHgnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvbnQgPSBnZXRMaXZlVmFsdWUoYCR7ZmllbGR9LWZvbnQtc2VsZWN0YCk7CiAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKGAjbWFpbi1kbmktJHtmaWVsZH1gKS5mb3JFYWNoKGVsID0+IGVsLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIC0tLSBQb3B1bGF0ZSBIZWFkZXJzIGFuZCBEZXRhaWxzIFNjcmVlbiAtLS0KICAgICAgICAgICAgY29uc3Qgbm9tYnJlID0gZ2V0TGl2ZVZhbHVlKCdub21icmUtaW5wdXQnKTsKICAgICAgICAgICAgY29uc3QgYXBlbGxpZG8gPSBnZXRMaXZlVmFsdWUoJ2FwZWxsaWRvLWlucHV0Jyk7CiAgICAgICAgICAgIGNvbnN0IGN1aWwgPSBnZXRMaXZlVmFsdWUoJ2N1aWwtaW5wdXQnKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjd2VsY29tZS1uYW1lLCAjZGV0YWlscy1ub21icmUnLCBub21icmUpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkbmktZGlnaXRhbC10aXRsZScsIGAke2FwZWxsaWRvfSAke25vbWJyZX1gLCB0cnVlKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjc29saWNpdHVkLWRuaS1uYW1lJywgYCR7bm9tYnJlfSAke2FwZWxsaWRvfWApOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNtZW51LXVzZXItbmFtZScsIGAke25vbWJyZX0gJHthcGVsbGlkb31gKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjbWVudS11c2VyLWlkJywgY3VpbCk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtYXBlbGxpZG8nLCBhcGVsbGlkbywgdHJ1ZSk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtY3VpbCcsIGN1aWwpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLWRuaScsIGdldExpdmVWYWx1ZSgnZG9jdW1lbnRvLWlucHV0JykpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLXRyYW1pdGUnLCBnZXRMaXZlVmFsdWUoJ3RyYW1pdGUtaW5wdXQnKSk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtZW1pc2lvbicsIGdldExpdmVWYWx1ZSgnZW1pc2lvbi1pbnB1dCcpKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjZGV0YWlscy12ZW5jaW1pZW50bycsIGdldExpdmVWYWx1ZSgndmVuY2ltaWVudG8taW5wdXQnKSk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtc2V4bycsIGdldExpdmVWYWx1ZSgnc2V4by1pbnB1dCcpLCB0cnVlKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjZGV0YWlscy1uYWNpbWllbnRvJywgZ2V0TGl2ZVZhbHVlKCduYWNpbWllbnRvLWlucHV0JykpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLWRvbWljaWxpbycsIGdldExpdmVWYWx1ZSgnZG9taWNpbGlvLWlucHV0JyksIHRydWUpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLW5hY2lvbmFsaWRhZCcsICdBUicsIHRydWUpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLWx1Z2FyLW5hY2ltaWVudG8nLCAnQVJHRU5UaW5hJywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBhcHBseUFsbER5bmFtaWNEYXRhVG9DbG9uZShib2R5Q2xvbmUpOwogICAgICAgIGNvbnN0IHJlc2V0Q2xvbmVUb0luaXRpYWxTdGF0ZSA9IChjbG9uZSkgPT4gewogICAgICAgICAgICBjb25zdCBzZXREaXNwbGF5ID0gKHNlbGVjdG9yLCBkaXNwbGF5KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGNsb25lLnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgaWYgKGVsKQogICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5OwogICAgICAgICAgICB9OwogICAgICAgICAgICBzZXREaXNwbGF5KCcjbWFpbi1zY3JlZW4nLCAnZmxleCcpOwogICAgICAgICAgICBzZXREaXNwbGF5KCcjZG9jdW1lbnRvcy1zY3JlZW4nLCAnbm9uZScpOwogICAgICAgICAgICBzZXREaXNwbGF5KCcjdGVsZWZvbm9zLXNjcmVlbicsICdub25lJyk7CiAgICAgICAgICAgIHNldERpc3BsYXkoJyNkbmktZGV0YWlscy1zY3JlZW4nLCAnbm9uZScpOwogICAgICAgICAgICBzZXREaXNwbGF5KCcjYm90dG9tLW5hdicsICdub25lJyk7CiAgICAgICAgICAgIC8vIFJlc2V0IERvY3VtZW50b3Mgc2NyZWVuIHN0YXRlCiAgICAgICAgICAgIGNvbnN0IGRvY1NjcmVlbiA9IGNsb25lLnF1ZXJ5U2VsZWN0b3IoJyNkb2N1bWVudG9zLXNjcmVlbicpOwogICAgICAgICAgICBpZiAoZG9jU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkbmlJbml0aWFsVmlldyA9IGRvY1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcjZG5pLWluaXRpYWwtdmlldycpOwogICAgICAgICAgICAgICAgaWYgKGRuaUluaXRpYWxWaWV3KQogICAgICAgICAgICAgICAgICAgIGRuaUluaXRpYWxWaWV3LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgY29uc3QgZG5pRGlnaXRhbERpc3BsYXkgPSBkb2NTY3JlZW4ucXVlcnlTZWxlY3RvcignI2RuaS1kaWdpdGFsLWRpc3BsYXknKTsKICAgICAgICAgICAgICAgIGlmIChkbmlEaWdpdGFsRGlzcGxheSkKICAgICAgICAgICAgICAgICAgICBkbmlEaWdpdGFsRGlzcGxheS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgY29uc3QgZG5pRmxpcHBlciA9IGRvY1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcjZG5pLWZsaXBwZXInKTsKICAgICAgICAgICAgICAgIGlmIChkbmlGbGlwcGVyKQogICAgICAgICAgICAgICAgICAgIGRuaUZsaXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3JvdGF0ZVkoMGRlZyknOwogICAgICAgICAgICAgICAgY29uc3QgZG5pQ2FyZCA9IGRvY1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcuZG5pLWNhcmQnKTsKICAgICAgICAgICAgICAgIGlmIChkbmlDYXJkKQogICAgICAgICAgICAgICAgICAgIGRuaUNhcmQuY2xhc3NMaXN0LnJlbW92ZSgnaXMtY29sbGFwc2VkJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJlc2V0Q2xvbmVUb0luaXRpYWxTdGF0ZShib2R5Q2xvbmUpOwogICAgICAgIGNvbnN0IGludGVyYWN0aXZlU2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgaW50ZXJhY3RpdmVTY3JpcHQudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0U2NyZWVuTmF2aWdhdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5zID0gewogICAgICAgICAgICAgICAgICAgICAgICBtYWluOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi1zY3JlZW4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRvczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RvY3VtZW50b3Mtc2NyZWVuJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbHM6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGV0YWlscy1zY3JlZW4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgdGVsZWZvbm9zOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVsZWZvbm9zLXNjcmVlbicpLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRvczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JvdHRvbS1uYXYnKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRldGFpbHMtYm90dG9tLW5hdicpLAogICAgICAgICAgICAgICAgICAgICAgICB0ZWxlZm9ub3M6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWxlZm9ub3MtYm90dG9tLW5hdicpLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9hZGluZ092ZXJsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZy1vdmVybGF5Jyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd1NjcmVlbiA9IChzY3JlZW5LZXksIHN1YlZpZXcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhzY3JlZW5zKS5mb3JFYWNoKHMgPT4gcyAmJiAocy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMobmF2cykuZm9yRWFjaChuID0+IG4gJiYgKG4uc3R5bGUuZGlzcGxheSA9ICdub25lJykpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbnNbc2NyZWVuS2V5XSkgc2NyZWVuc1tzY3JlZW5LZXldLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NyZWVuS2V5ID09PSAnZG9jdW1lbnRvcycgJiYgbmF2cy5kb2N1bWVudG9zKSBuYXZzLmRvY3VtZW50b3Muc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbktleSA9PT0gJ2RldGFpbHMnICYmIG5hdnMuZGV0YWlscykgbmF2cy5kZXRhaWxzLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY3JlZW5LZXkgPT09ICd0ZWxlZm9ub3MnICYmIG5hdnMudGVsZWZvbm9zKSBuYXZzLnRlbGVmb25vcy5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbktleSA9PT0gJ2RvY3VtZW50b3MnICYmIHN1YlZpZXcgPT09ICdkaWdpdGFsJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2hvd0RuaVZpZXcnLCB7IGRldGFpbDogJ2RpZ2l0YWwnIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hdmlnYXRlV2l0aExvYWRlciA9IChzY3JlZW5LZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93U2NyZWVuKHNjcmVlbktleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9hZGluZ092ZXJsYXkpIGxvYWRpbmdPdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvcy1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ2RvY3VtZW50b3MnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtYmFjay1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBzaG93U2NyZWVuKCdkb2N1bWVudG9zJywgJ2RpZ2l0YWwnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlbGVmb25vcy1idG4tZG9jcycpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IG5hdmlnYXRlV2l0aExvYWRlcigndGVsZWZvbm9zJyk7IH0pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3MtYnRuLWRldGFpbHMnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ3RlbGVmb25vcycpOyB9KTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVsZWZvbm9zLWluaWNpby1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ21haW4nKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2luaWNpby1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ21haW4nKTsgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdERuaUZsb3coKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uTG9hZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1sb2FkZXInKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkbmlWaWV3cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1pbml0aWFsLXZpZXcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgc29saWNpdHVkOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLXNvbGljaXR1ZC12aWV3JyksCiAgICAgICAgICAgICAgICAgICAgICAgIGRpZ2l0YWw6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGlnaXRhbC1kaXNwbGF5JyksCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBoZWFkZXJFbGVtZW50cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FyZEhlYWRlcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1jYXJkLWhlYWRlcicpLAogICAgICAgICAgICAgICAgICAgICAgICBjYXJkQm9keTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1jYXJkLWJvZHknKSwKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZG9jdW1lbnRvcy1zY3JlZW4gLmRvY3VtZW50b3MtaGVhZGVyJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZG9jdW1lbnRvcy1zY3JlZW4gLmRvY3VtZW50b3MtaGVhZGVyIGgyJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hJY29uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVmcmVzaC1pY29uJyksCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd0RuaVZpZXcgPSAodmlld0tleSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QudmFsdWVzKGRuaVZpZXdzKS5mb3JFYWNoKHYgPT4gdiAmJiAodi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkbmlWaWV3c1t2aWV3S2V5XSkgZG5pVmlld3Nbdmlld0tleV0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0RpZ2l0YWwgPSB2aWV3S2V5ID09PSAnZGlnaXRhbCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzU29saWNpdHVkID0gdmlld0tleSA9PT0gJ3NvbGljaXR1ZCc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyRWxlbWVudHMuY2FyZEhlYWRlcikgaGVhZGVyRWxlbWVudHMuY2FyZEhlYWRlci5zdHlsZS5kaXNwbGF5ID0gKGlzRGlnaXRhbCB8fCBpc1NvbGljaXR1ZCkgPyAnbm9uZScgOiAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXJFbGVtZW50cy5jYXJkQm9keSkgaGVhZGVyRWxlbWVudHMuY2FyZEJvZHkuY2xhc3NMaXN0LnRvZ2dsZSgnbm8taGVhZGVyJywgaXNEaWdpdGFsIHx8IGlzU29saWNpdHVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhlYWRlckVsZW1lbnRzLnRpdGxlKSBoZWFkZXJFbGVtZW50cy50aXRsZS50ZXh0Q29udGVudCA9IGlzRGlnaXRhbCA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGlnaXRhbC10aXRsZScpLnRleHRDb250ZW50IDogJ0RvY3VtZW50b3MnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyRWxlbWVudHMucmVmcmVzaEljb24pIGhlYWRlckVsZW1lbnRzLnJlZnJlc2hJY29uLnN0eWxlLmRpc3BsYXkgPSBpc0RpZ2l0YWwgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyRWxlbWVudHMuaGVhZGVyKSBoZWFkZXJFbGVtZW50cy5oZWFkZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSBpc0RpZ2l0YWwgPyAnc3BhY2UtYmV0d2VlbicgOiAnZmxleC1zdGFydCc7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzaG93RG5pVmlldycsIChlKSA9PiBzaG93RG5pVmlldyhlLmRldGFpbCkpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJmb3JtQWN0aW9uID0gKHZpZXcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dEbmlWaWV3KHZpZXcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc29saWNpdGFyLWRuaS1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBwZXJmb3JtQWN0aW9uKCdzb2xpY2l0dWQnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Zlci1kbmktZGlnaXRhbC1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBwZXJmb3JtQWN0aW9uKCdkaWdpdGFsJyk7IH0pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25maXJtYXItc29saWNpdHVkLWJ0bicpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IHBlcmZvcm1BY3Rpb24oJ2RpZ2l0YWwnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Zlci1kZXRhbGxlLWJ0bicpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGV0YWlscy1zY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOyB9KTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYmFjay1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnZXRDb21wdXRlZFN0eWxlKGRuaVZpZXdzLmRpZ2l0YWwpLmRpc3BsYXkgIT09ICdub25lJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93RG5pVmlldygnaW5pdGlhbCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmbGlwcGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2RuaS1mbGlwcGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGZsaXBwZXIpIGZsaXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3JvdGF0ZVkoMGRlZyknOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi1zY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvcy1zY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdFVzZXJNZW51KCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyLXByb2ZpbGUtYnRuJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyLW1lbnUnKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFycm93Jyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4gfHwgIW1lbnUgfHwgIWFycm93KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbnUuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycm93LmNsYXNzTGlzdC50b2dnbGUoJ3JvdGF0ZWQnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVudS5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZScpICYmICFtZW51LmNvbnRhaW5zKGUudGFyZ2V0KSAmJiAhYnRuLmNvbnRhaW5zKGUudGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycm93LmNsYXNzTGlzdC5yZW1vdmUoJ3JvdGF0ZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0RG5pSW50ZXJhY3Rpb25zKCkgewogICAgICAgICAgICAgICAgICAgIC8vIEROSSBGbGlwcGVyIExvZ2ljIChEcmFnL1N3aXBlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRuaUZsaXBwZXJDb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZG5pLWZsaXBwZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG5pRmxpcHBlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZmxpcHBlcicpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZG5pRmxpcHBlckNvbnRhaW5lciAmJiBkbmlGbGlwcGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdGFydFggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnRBbmdsZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjdXJyZW50QW5nbGUgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2V0RXZlbnRYID0gKGUpID0+IGUudHlwZS5pbmNsdWRlcygnbW91c2UnKSA/IGUuc2NyZWVuWCA6IGUuY2hhbmdlZFRvdWNoZXNbMF0uc2NyZWVuWDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbmRsZURyYWdTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50eXBlID09PSAnbW91c2Vkb3duJyAmJiBlLmJ1dHRvbiAhPT0gMCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydFggPSBnZXRFdmVudFgoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydEFuZ2xlID0gY3VycmVudEFuZ2xlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG5pRmxpcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUudHlwZSAhPT0gJ3RvdWNoc3RhcnQnKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVEcmFnTW92ZSA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRYID0gZ2V0RXZlbnRYKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsdGFYID0gY3VycmVudFggLSBzdGFydFg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByb3RhdGlvblNlbnNpdGl2aXR5ID0gMTgwIC8gZG5pRmxpcHBlckNvbnRhaW5lci5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhQW5nbGUgPSBkZWx0YVggKiByb3RhdGlvblNlbnNpdGl2aXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gc3RhcnRBbmdsZSArIGRlbHRhQW5nbGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9ICdyb3RhdGVZKCcgKyBjdXJyZW50QW5nbGUgKyAnZGVnKSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVEcmFnRW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAndHJhbnNmb3JtIDAuNnMgY3ViaWMtYmV6aWVyKDAuMzQsIDEuNTYsIDAuNjQsIDEpJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsUm90YXRpb24gPSBNYXRoLnJvdW5kKGN1cnJlbnRBbmdsZSAvIDE4MCkgKiAxODA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9ICdyb3RhdGVZKCcgKyBmaW5hbFJvdGF0aW9uICsgJ2RlZyknOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gZmluYWxSb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRuaUZsaXBwZXJDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlRHJhZ1N0YXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlRHJhZ01vdmUpOwogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRHJhZ0VuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRuaUZsaXBwZXJDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZURyYWdTdGFydCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlRHJhZ01vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRHJhZ0VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEROSSBDb2xsYXBzZSBMb2dpYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZG9jdW1lbnRvcy1zY3JlZW4gLmRuaS1jYXJkJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1jYXJkLWhlYWRlcicpOwogICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXIgJiYgY2FyZCkgewogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0luaXRpYWwgPSBnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktaW5pdGlhbC12aWV3JykpLmRpc3BsYXkgIT09ICdub25lJyB8fCBnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktc29saWNpdHVkLXZpZXcnKSkuZGlzcGxheSAhPT0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5pdGlhbCkgY2FyZC5jbGFzc0xpc3QudG9nZ2xlKCdpcy1jb2xsYXBzZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGluaXREaXNhYmxlZEJ1dHRvbnMoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0b3JzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAnI21haW4tc2NyZWVuIGEuZ3JpZC1pdGVtOm5vdCgjZG9jdW1lbnRvcy1idG4pOm5vdCgjaGlqb3MtYnRuKScsCiAgICAgICAgICAgICAgICAgICAgICAgICcjbWFpbi1zY3JlZW4gLnR1cm5vcy1jYXJkIC5idG4nLCAnI21haW4tc2NyZWVuIC5lbGVjY2lvbmVzLWNhcmQnLAogICAgICAgICAgICAgICAgICAgICAgICAnI2RvY3VtZW50b3Mtc2NyZWVuIC5kbmktYWN0aW9ucyBidXR0b246bm90KCN2ZXItZGV0YWxsZS1idG4pJywKICAgICAgICAgICAgICAgICAgICAgICAgJyNkb2N1bWVudG9zLXNjcmVlbiAuZG5pLXFyLXZlcmlmeScsCiAgICAgICAgICAgICAgICAgICAgICAgICcjYm90dG9tLW5hdiBhOm5vdCgjaW5pY2lvLWJ0bik6bm90KCN0ZWxlZm9ub3MtYnRuLWRvY3MpJywKICAgICAgICAgICAgICAgICAgICAgICAgJy5kZXRhaWxzLWJvdHRvbS1uYXYgYTpub3QoLmFjdGl2ZSk6bm90KCN0ZWxlZm9ub3MtYnRuLWRldGFpbHMpJywKICAgICAgICAgICAgICAgICAgICAgICAgJy50ZWxlZm9ub3MtYm90dG9tLW5hdiBhOm5vdCgjdGVsZWZvbm9zLWluaWNpby1idG4pJywKICAgICAgICAgICAgICAgICAgICAgICAgJyN1c2VyLW1lbnUgYTpub3QoI21lbnUtaGlqb3MtYnRuKScsCiAgICAgICAgICAgICAgICAgICAgICAgICcuYXBwLWhlYWRlciBzdmc6Zmlyc3Qtb2YtdHlwZScKICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3JzLmpvaW4oJywgJykpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IGUucHJldmVudERlZmF1bHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBIaWpvcyBidXR0b24gYXMgaXQgbGVhZHMgdG8gYSByZW1vdmVkIHNjcmVlbgogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW51LWhpam9zLWJ0bicpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtYnRuJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiBlLnByZXZlbnREZWZhdWx0KCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7IGluaXRTY3JlZW5OYXZpZ2F0aW9uKCk7IH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBuYXZpZ2F0aW9uOicsIGUpOyB9CiAgICAgICAgICAgICAgICB0cnkgeyBpbml0RG5pRmxvdygpOyB9IGNhdGNoKGUpIHsgY29uc29sZS5lcnJvcignRXJyb3IgaW4gRE5JIGZsb3c6JywgZSk7IH0KICAgICAgICAgICAgICAgIHRyeSB7IGluaXRVc2VyTWVudSgpOyB9IGNhdGNoKGUpIHsgY29uc29sZS5lcnJvcignRXJyb3IgaW4gdXNlciBtZW51OicsIGUpOyB9CiAgICAgICAgICAgICAgICB0cnkgeyBpbml0RG5pSW50ZXJhY3Rpb25zKCk7IH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBETkkgaW50ZXJhY3Rpb25zOicsIGUpOyB9CiAgICAgICAgICAgICAgICB0cnkgeyBpbml0RGlzYWJsZWRCdXR0b25zKCk7IH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKCdFcnJvciBkaXNhYmxpbmcgYnV0dG9uczonLCBlKTsgfQogICAgICAgICAgICB9KTsKICAgICAgICBgOwogICAgICAgIGJvZHlDbG9uZS5hcHBlbmRDaGlsZChpbnRlcmFjdGl2ZVNjcmlwdCk7CiAgICAgICAgY29uc3QgaHRtbENvbnRlbnQgPSBgCiAgICAgICAgICAgIDwhRE9DVFlQRSBodG1sPgogICAgICAgICAgICA8aHRtbCBsYW5nPSJlcyI+CiAgICAgICAgICAgIDxoZWFkPiR7aGVhZENvbnRlbnR9PC9oZWFkPgogICAgICAgICAgICAke2JvZHlDbG9uZS5vdXRlckhUTUx9CiAgICAgICAgICAgIDwvaHRtbD4KICAgICAgICBgOwogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbaHRtbENvbnRlbnQudHJpbSgpXSwgeyB0eXBlOiAndGV4dC9odG1sJyB9KTsKICAgICAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGxpbmsuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgbGluay5kb3dubG9hZCA9ICdpbmRleC5odG1sJzsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgIGxpbmsuY2xpY2soKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmspOwogICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwobGluay5ocmVmKTsKICAgIH0KICAgIGlmIChleHBvcnRCdG4pIHsKICAgICAgICBleHBvcnRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBnZW5lcmF0ZUFuZERvd25sb2FkSHRtbCk7CiAgICB9CiAgICAvLyBQV0EgU2VydmljZSBXb3JrZXIgUmVnaXN0cmF0aW9uCiAgICBpZiAoJ3NlcnZpY2VXb3JrZXInIGluIG5hdmlnYXRvcikgewogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4gewogICAgICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3RlcignL3N3LmpzJykudGhlbihyZWdpc3RyYXRpb24gPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1NXIHJlZ2lzdGVyZWQ6ICcsIHJlZ2lzdHJhdGlvbik7CiAgICAgICAgICAgIH0pLmNhdGNoKHJlZ2lzdHJhdGlvbkVycm9yID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTVyByZWdpc3RyYXRpb24gZmFpbGVkOiAnLCByZWdpc3RyYXRpb25FcnJvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQp9KTsK","@":"data:application/javascript;base64,ZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHsKICAgIC8vIENhc3QgdG8gSFRNTEVsZW1lbnQgb3Igc3BlY2lmaWMgZWxlbWVudCB0eXBlcyB0byBhdm9pZCBudWxsIGlzc3VlcyBhbmQgZ2V0IFRTIHN1cHBvcnQKICAgIGNvbnN0IG1haW5TY3JlZW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi1zY3JlZW4nKTsKICAgIGNvbnN0IGRvY3VtZW50b3NTY3JlZW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvcy1zY3JlZW4nKTsKICAgIGNvbnN0IGhpam9zU2NyZWVuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLXNjcmVlbicpOwogICAgY29uc3QgZG5pRGV0YWlsc1NjcmVlbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGV0YWlscy1zY3JlZW4nKTsKICAgIGNvbnN0IHRlbGVmb25vc1NjcmVlbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3Mtc2NyZWVuJyk7CiAgICBjb25zdCBib3R0b21OYXYgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYm90dG9tLW5hdicpOwogICAgY29uc3QgbG9hZGluZ092ZXJsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZy1vdmVybGF5Jyk7CiAgICBjb25zdCBhY3Rpb25Mb2FkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWN0aW9uLWxvYWRlcicpOwogICAgY29uc3QgZG9jdW1lbnRvc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb2N1bWVudG9zLWJ0bicpOwogICAgY29uc3QgaGlqb3NCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtYnRuJyk7CiAgICBjb25zdCB0ZWxlZm9ub3NCdG5Eb2NzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlbGVmb25vcy1idG4tZG9jcycpOwogICAgY29uc3QgdGVsZWZvbm9zQnRuRGV0YWlscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3MtYnRuLWRldGFpbHMnKTsKICAgIGNvbnN0IHRlbGVmb25vc0luaWNpb0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3MtaW5pY2lvLWJ0bicpOwogICAgLy8gRklYOiBDaGFuZ2VkIHR5cGUgZnJvbSBTVkdFbGVtZW50IHRvIEhUTUxFbGVtZW50IHRvIHJlc29sdmUgYSBUeXBlU2NyaXB0IGNhc3RpbmcgZXJyb3IuCiAgICAvLyBJdCdzIG1vcmUgY29udmVudGlvbmFsIGZvciBhIGNsaWNrYWJsZSBlbGVtZW50IGxpa2UgYSBidXR0b24gdG8gYmUgYW4gSFRNTEVsZW1lbnQsIHdoaWNoIG1pZ2h0IGNvbnRhaW4gYW4gU1ZHLgogICAgY29uc3QgYmFja0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdiYWNrLWJ0bicpOwogICAgY29uc3QgaGlqb3NCYWNrQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWJhY2stYnRuJyk7CiAgICBjb25zdCBkZXRhaWxzQmFja0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWJhY2stYnRuJyk7CiAgICBjb25zdCBpbmljaW9CdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5pY2lvLWJ0bicpOwogICAgLy8gRE5JIENhcmQgZWxlbWVudHMKICAgIGNvbnN0IHNvbGljaXRhckRuaUJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb2xpY2l0YXItZG5pLWJ0bicpOwogICAgY29uc3QgZG5pSW5pdGlhbFZpZXcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWluaXRpYWwtdmlldycpOwogICAgY29uc3QgZG5pU29saWNpdHVkVmlldyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktc29saWNpdHVkLXZpZXcnKTsKICAgIGNvbnN0IGRuaUNhcmRIZWFkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWNhcmQtaGVhZGVyJyk7CiAgICBjb25zdCBkbmlDYXJkQm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktY2FyZC1ib2R5Jyk7CiAgICBjb25zdCBjb25maXJtYXJTb2xpY2l0dWRCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29uZmlybWFyLXNvbGljaXR1ZC1idG4nKTsKICAgIGNvbnN0IGRuaURpZ2l0YWxEaXNwbGF5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1kaWdpdGFsLWRpc3BsYXknKTsKICAgIGNvbnN0IG1haW5EbmlQcm9maWxlUGljID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLXByb2ZpbGUtcGljJyk7CiAgICBjb25zdCBtYWluRG5pUHJvZmlsZUltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLXByb2ZpbGUtaW1hZ2UnKTsKICAgIGNvbnN0IHZlckRldGFsbGVCdG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVyLWRldGFsbGUtYnRuJyk7CiAgICBjb25zdCB2ZXJEbmlEaWdpdGFsQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Zlci1kbmktZGlnaXRhbC1idG4nKTsKICAgIC8vIEhlYWRlciBlbGVtZW50cyBmb3IgZHluYW1pYyBjb250ZW50CiAgICBjb25zdCBkb2N1bWVudG9zSGVhZGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRvY3VtZW50b3MtaGVhZGVyJyk7CiAgICBjb25zdCBkb2N1bWVudG9zSGVhZGVyVGl0bGUgPSBkb2N1bWVudG9zSGVhZGVyLnF1ZXJ5U2VsZWN0b3IoJ2gyJyk7CiAgICBjb25zdCByZWZyZXNoSWNvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWZyZXNoLWljb24nKTsKICAgIGNvbnN0IHdlbGNvbWVOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtbmFtZScpOwogICAgY29uc3QgZG5pRGlnaXRhbFRpdGxlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1kaWdpdGFsLXRpdGxlJyk7CiAgICBjb25zdCBzb2xpY2l0dWREbmlOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvbGljaXR1ZC1kbmktbmFtZScpOwogICAgLy8gSGlqb3Mgc2NyZWVuIGNvbnRyb2xzIChJbWFnZSkKICAgIGNvbnN0IGhpam9zRG5pUHJvZmlsZVBpYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWpvcy1kbmktcHJvZmlsZS1waWMnKTsKICAgIGNvbnN0IGhpam9zRG5pUHJvZmlsZUltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1wcm9maWxlLWltYWdlJyk7CiAgICBjb25zdCBpbWFnZVVybElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ltYWdlLXVybC1pbnB1dCcpOwogICAgY29uc3QgdG9wU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvcC1zbGlkZXInKTsKICAgIGNvbnN0IGxlZnRTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbGVmdC1zbGlkZXInKTsKICAgIGNvbnN0IHdpZHRoU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dpZHRoLXNsaWRlcicpOwogICAgY29uc3QgaGVpZ2h0U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlaWdodC1zbGlkZXInKTsKICAgIGNvbnN0IHRvcFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvcC12YWx1ZScpOwogICAgY29uc3QgbGVmdFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xlZnQtdmFsdWUnKTsKICAgIGNvbnN0IHdpZHRoVmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2lkdGgtdmFsdWUnKTsKICAgIGNvbnN0IGhlaWdodFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlaWdodC12YWx1ZScpOwogICAgLy8gSGlqb3Mgc2NyZWVuIGNvbnRyb2xzIChRUikKICAgIGNvbnN0IG1haW5EbmlRclBpYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluLWRuaS1xci1waWMnKTsKICAgIGNvbnN0IG1haW5EbmlRckltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLXFyLWltYWdlJyk7CiAgICBjb25zdCBoaWpvc0RuaVFyUGljID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1xci1waWMnKTsKICAgIGNvbnN0IGhpam9zRG5pUXJJbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWpvcy1kbmktcXItaW1hZ2UnKTsKICAgIGNvbnN0IHFyVXJsSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItdXJsLWlucHV0Jyk7CiAgICBjb25zdCBxclRvcFNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxci10b3Atc2xpZGVyJyk7CiAgICBjb25zdCBxckxlZnRTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItbGVmdC1zbGlkZXInKTsKICAgIGNvbnN0IHFyV2lkdGhTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItd2lkdGgtc2xpZGVyJyk7CiAgICBjb25zdCBxckhlaWdodFNsaWRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdxci1oZWlnaHQtc2xpZGVyJyk7CiAgICBjb25zdCBxclRvcFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3FyLXRvcC12YWx1ZScpOwogICAgY29uc3QgcXJMZWZ0VmFsdWUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXItbGVmdC12YWx1ZScpOwogICAgY29uc3QgcXJXaWR0aFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3FyLXdpZHRoLXZhbHVlJyk7CiAgICBjb25zdCBxckhlaWdodFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3FyLWhlaWdodC12YWx1ZScpOwogICAgY29uc3QgZGV0YWlsc0JhcmNvZGVJbWFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWJhcmNvZGUtaW1hZ2UnKTsKICAgIGNvbnN0IGRldGFpbHNQcm9maWxlSW1hZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy1wcm9maWxlLWltYWdlJyk7CiAgICAvLyBIaWpvcyBzY3JlZW4gY29udHJvbHMgKEJhY2sgSW1hZ2UpCiAgICBjb25zdCBtYWluRG5pQmFja0ltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21haW4tZG5pLWJhY2staW1hZ2UnKTsKICAgIGNvbnN0IGhpam9zRG5pQmFja0ltYWdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1iYWNrLWltYWdlJyk7CiAgICBjb25zdCBkbmlCYWNrVXJsSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWJhY2stdXJsLWlucHV0Jyk7CiAgICAvLyBVc2VyIE1lbnUgRWxlbWVudHMKICAgIGNvbnN0IHVzZXJQcm9maWxlQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXItcHJvZmlsZS1idG4nKTsKICAgIGNvbnN0IHByb2ZpbGVBcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFycm93Jyk7CiAgICBjb25zdCB1c2VyTWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyLW1lbnUnKTsKICAgIGNvbnN0IG1lbnVIaWpvc0J0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW51LWhpam9zLWJ0bicpOwogICAgY29uc3QgbWVudVVzZXJOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnUtdXNlci1uYW1lJyk7CiAgICBjb25zdCBtZW51VXNlcklkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnUtdXNlci1pZCcpOwogICAgZnVuY3Rpb24gc2V0dXBTbGlkZXIoc2xpZGVyLCB0YXJnZXRzLCBwcm9wZXJ0eSwgdmFsdWVTcGFuLCB1bml0ID0gJyUnKSB7CiAgICAgICAgaWYgKHNsaWRlciAmJiB0YXJnZXRzICYmIHRhcmdldHMubGVuZ3RoID4gMCAmJiB2YWx1ZVNwYW4pIHsKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgdmFsdWUKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFZhbHVlID0gc2xpZGVyLnZhbHVlOwogICAgICAgICAgICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHsKICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXQuc3R5bGVbcHJvcGVydHldID0gYCR7aW5pdGlhbFZhbHVlfSR7dW5pdH1gOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFsdWVTcGFuLnRleHRDb250ZW50ID0gaW5pdGlhbFZhbHVlOwogICAgICAgICAgICAvLyBBZGQgZXZlbnQgbGlzdGVuZXIKICAgICAgICAgICAgc2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgKCkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzbGlkZXIudmFsdWU7CiAgICAgICAgICAgICAgICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5zdHlsZVtwcm9wZXJ0eV0gPSBgJHt2YWx1ZX0ke3VuaXR9YDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHZhbHVlU3Bhbi50ZXh0Q29udGVudCA9IHZhbHVlOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiB1cGRhdGVEeW5hbWljSGVhZGVyRGF0YSgpIHsKICAgICAgICBjb25zdCBhcGVsbGlkb0lucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwZWxsaWRvLWlucHV0Jyk7CiAgICAgICAgY29uc3Qgbm9tYnJlSW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbm9tYnJlLWlucHV0Jyk7CiAgICAgICAgY29uc3QgY3VpbElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1aWwtaW5wdXQnKTsKICAgICAgICBpZiAoYXBlbGxpZG9JbnB1dCAmJiBub21icmVJbnB1dCAmJiBjdWlsSW5wdXQpIHsKICAgICAgICAgICAgY29uc3QgYXBlbGxpZG8gPSBhcGVsbGlkb0lucHV0LnZhbHVlOwogICAgICAgICAgICBjb25zdCBub21icmUgPSBub21icmVJbnB1dC52YWx1ZTsKICAgICAgICAgICAgY29uc3QgY3VpbCA9IGN1aWxJbnB1dC52YWx1ZTsKICAgICAgICAgICAgY29uc3QgZHJvcGRvd25OYW1lID0gYCR7bm9tYnJlfSAke2FwZWxsaWRvfWA7CiAgICAgICAgICAgIGNvbnN0IGRuaVRpdGxlTmFtZSA9IGAke2FwZWxsaWRvfSAke25vbWJyZX1gOwogICAgICAgICAgICBjb25zdCBtZW51TmFtZSA9IGAke25vbWJyZX0gJHthcGVsbGlkb31gOwogICAgICAgICAgICBpZiAod2VsY29tZU5hbWUpIHsKICAgICAgICAgICAgICAgIHdlbGNvbWVOYW1lLnRleHRDb250ZW50ID0gbm9tYnJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkbmlEaWdpdGFsVGl0bGUpIHsKICAgICAgICAgICAgICAgIGRuaURpZ2l0YWxUaXRsZS50ZXh0Q29udGVudCA9IGRuaVRpdGxlTmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc29saWNpdHVkRG5pTmFtZSkgewogICAgICAgICAgICAgICAgc29saWNpdHVkRG5pTmFtZS50ZXh0Q29udGVudCA9IGRyb3Bkb3duTmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWVudVVzZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBtZW51VXNlck5hbWUudGV4dENvbnRlbnQgPSBtZW51TmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobWVudVVzZXJJZCkgewogICAgICAgICAgICAgICAgbWVudVVzZXJJZC50ZXh0Q29udGVudCA9IGN1aWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBzZXR1cFRleHRDb250cm9sKGZpZWxkKSB7CiAgICAgICAgY29uc3QgdGV4dElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LWlucHV0YCk7CiAgICAgICAgY29uc3QgdG9wU2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LXRvcC1zbGlkZXJgKTsKICAgICAgICBjb25zdCBsZWZ0U2xpZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LWxlZnQtc2xpZGVyYCk7CiAgICAgICAgY29uc3QgZm9udHNpemVTbGlkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgJHtmaWVsZH0tZm9udHNpemUtc2xpZGVyYCk7CiAgICAgICAgY29uc3QgZm9udFNlbGVjdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke2ZpZWxkfS1mb250LXNlbGVjdGApOwogICAgICAgIGNvbnN0IHRvcFZhbHVlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYCR7ZmllbGR9LXRvcC12YWx1ZWApOwogICAgICAgIGNvbnN0IGxlZnRWYWx1ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke2ZpZWxkfS1sZWZ0LXZhbHVlYCk7CiAgICAgICAgY29uc3QgZm9udHNpemVWYWx1ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGAke2ZpZWxkfS1mb250c2l6ZS12YWx1ZWApOwogICAgICAgIGNvbnN0IG1haW5UYXJnZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgbWFpbi1kbmktJHtmaWVsZH1gKTsKICAgICAgICBjb25zdCBoaWpvc1RhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBoaWpvcy1kbmktJHtmaWVsZH1gKTsKICAgICAgICBjb25zdCB0YXJnZXRzID0gW21haW5UYXJnZXQsIGhpam9zVGFyZ2V0XS5maWx0ZXIoZWwgPT4gZWwpOwogICAgICAgIGlmICh0ZXh0SW5wdXQgJiYgdGFyZ2V0cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHRleHQKICAgICAgICAgICAgY29uc3QgaW5pdGlhbFZhbHVlID0gdGV4dElucHV0LnZhbHVlOwogICAgICAgICAgICB0YXJnZXRzLmZvckVhY2godGFyZ2V0ID0+IHRhcmdldC50ZXh0Q29udGVudCA9IGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIC8vIEFkZCBsaXN0ZW5lcgogICAgICAgICAgICB0ZXh0SW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IHRleHRJbnB1dC52YWx1ZTsKICAgICAgICAgICAgICAgIHRhcmdldHMuZm9yRWFjaCh0YXJnZXQgPT4gdGFyZ2V0LnRleHRDb250ZW50ID0gbmV3VmFsdWUpOwogICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnbm9tYnJlJyB8fCBmaWVsZCA9PT0gJ2FwZWxsaWRvJyB8fCBmaWVsZCA9PT0gJ2N1aWwnKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlRHluYW1pY0hlYWRlckRhdGEoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHNldHVwU2xpZGVyKHRvcFNsaWRlciwgdGFyZ2V0cywgJ3RvcCcsIHRvcFZhbHVlLCAnJScpOwogICAgICAgIHNldHVwU2xpZGVyKGxlZnRTbGlkZXIsIHRhcmdldHMsICdsZWZ0JywgbGVmdFZhbHVlLCAnJScpOwogICAgICAgIHNldHVwU2xpZGVyKGZvbnRzaXplU2xpZGVyLCB0YXJnZXRzLCAnZm9udFNpemUnLCBmb250c2l6ZVZhbHVlLCAncHgnKTsKICAgICAgICBpZiAoZm9udFNlbGVjdCAmJiB0YXJnZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gU2V0IGluaXRpYWwgZm9udCBmYW1pbHkKICAgICAgICAgICAgdGFyZ2V0cy5mb3JFYWNoKHRhcmdldCA9PiB7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnN0eWxlLmZvbnRGYW1pbHkgPSBmb250U2VsZWN0LnZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gQWRkIGV2ZW50IGxpc3RlbmVyCiAgICAgICAgICAgIGZvbnRTZWxlY3QuYWRkRXZlbnRMaXN0ZW5lcignaW5wdXQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdGb250ID0gZm9udFNlbGVjdC52YWx1ZTsKICAgICAgICAgICAgICAgIHRhcmdldHMuZm9yRWFjaCh0YXJnZXQgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnN0eWxlLmZvbnRGYW1pbHkgPSBuZXdGb250OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICAvLyBTZXR1cCBmb3IgUHJvZmlsZSBJbWFnZQogICAgaWYgKGltYWdlVXJsSW5wdXQgJiYgbWFpbkRuaVByb2ZpbGVJbWFnZSAmJiBoaWpvc0RuaVByb2ZpbGVJbWFnZSkgewogICAgICAgIGNvbnN0IGluaXRpYWxVcmwgPSBpbWFnZVVybElucHV0LnZhbHVlOwogICAgICAgIG1haW5EbmlQcm9maWxlSW1hZ2Uuc3JjID0gaW5pdGlhbFVybDsKICAgICAgICBoaWpvc0RuaVByb2ZpbGVJbWFnZS5zcmMgPSBpbml0aWFsVXJsOwogICAgICAgIGlmIChkZXRhaWxzUHJvZmlsZUltYWdlKQogICAgICAgICAgICBkZXRhaWxzUHJvZmlsZUltYWdlLnNyYyA9IGluaXRpYWxVcmw7CiAgICAgICAgaW1hZ2VVcmxJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpID0+IHsKICAgICAgICAgICAgY29uc3QgbmV3VXJsID0gaW1hZ2VVcmxJbnB1dC52YWx1ZTsKICAgICAgICAgICAgbWFpbkRuaVByb2ZpbGVJbWFnZS5zcmMgPSBuZXdVcmw7CiAgICAgICAgICAgIGhpam9zRG5pUHJvZmlsZUltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgaWYgKGRldGFpbHNQcm9maWxlSW1hZ2UpCiAgICAgICAgICAgICAgICBkZXRhaWxzUHJvZmlsZUltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIFNldHVwIGZvciBCYWNrIEROSSBJbWFnZQogICAgaWYgKGRuaUJhY2tVcmxJbnB1dCAmJiBtYWluRG5pQmFja0ltYWdlICYmIGhpam9zRG5pQmFja0ltYWdlKSB7CiAgICAgICAgbWFpbkRuaUJhY2tJbWFnZS5zcmMgPSBkbmlCYWNrVXJsSW5wdXQudmFsdWU7CiAgICAgICAgaGlqb3NEbmlCYWNrSW1hZ2Uuc3JjID0gZG5pQmFja1VybElucHV0LnZhbHVlOwogICAgICAgIGRuaUJhY2tVcmxJbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpID0+IHsKICAgICAgICAgICAgY29uc3QgbmV3VXJsID0gZG5pQmFja1VybElucHV0LnZhbHVlOwogICAgICAgICAgICBtYWluRG5pQmFja0ltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgaGlqb3NEbmlCYWNrSW1hZ2Uuc3JjID0gbmV3VXJsOwogICAgICAgIH0pOwogICAgfQogICAgLy8gU2V0dXAgZm9yIFFSIEltYWdlCiAgICBpZiAocXJVcmxJbnB1dCkgewogICAgICAgIGNvbnN0IHVwZGF0ZUFsbFFySW1hZ2VzID0gKCkgPT4gewogICAgICAgICAgICBjb25zdCBuZXdVcmwgPSBxclVybElucHV0LnZhbHVlOwogICAgICAgICAgICBpZiAobWFpbkRuaVFySW1hZ2UpIHsKICAgICAgICAgICAgICAgIG1haW5EbmlRckltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGlqb3NEbmlRckltYWdlKSB7CiAgICAgICAgICAgICAgICBoaWpvc0RuaVFySW1hZ2Uuc3JjID0gbmV3VXJsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZXRhaWxzQmFyY29kZUltYWdlKSB7CiAgICAgICAgICAgICAgICBkZXRhaWxzQmFyY29kZUltYWdlLnNyYyA9IG5ld1VybDsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgLy8gU2V0IGluaXRpYWwgdmFsdWVzCiAgICAgICAgdXBkYXRlQWxsUXJJbWFnZXMoKTsKICAgICAgICAvLyBBZGQgZXZlbnQgbGlzdGVuZXIKICAgICAgICBxclVybElucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgdXBkYXRlQWxsUXJJbWFnZXMpOwogICAgfQogICAgY29uc3QgcHJvZmlsZVBpY1RhcmdldHMgPSBbaGlqb3NEbmlQcm9maWxlUGljLCBtYWluRG5pUHJvZmlsZVBpY107CiAgICBzZXR1cFNsaWRlcih0b3BTbGlkZXIsIHByb2ZpbGVQaWNUYXJnZXRzLCAndG9wJywgdG9wVmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcihsZWZ0U2xpZGVyLCBwcm9maWxlUGljVGFyZ2V0cywgJ2xlZnQnLCBsZWZ0VmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcih3aWR0aFNsaWRlciwgcHJvZmlsZVBpY1RhcmdldHMsICd3aWR0aCcsIHdpZHRoVmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcihoZWlnaHRTbGlkZXIsIHByb2ZpbGVQaWNUYXJnZXRzLCAnaGVpZ2h0JywgaGVpZ2h0VmFsdWUsICclJyk7CiAgICBjb25zdCBxclBpY1RhcmdldHMgPSBbaGlqb3NEbmlRclBpYywgbWFpbkRuaVFyUGljXTsKICAgIHNldHVwU2xpZGVyKHFyVG9wU2xpZGVyLCBxclBpY1RhcmdldHMsICd0b3AnLCBxclRvcFZhbHVlLCAnJScpOwogICAgc2V0dXBTbGlkZXIocXJMZWZ0U2xpZGVyLCBxclBpY1RhcmdldHMsICdsZWZ0JywgcXJMZWZ0VmFsdWUsICclJyk7CiAgICBzZXR1cFNsaWRlcihxcldpZHRoU2xpZGVyLCBxclBpY1RhcmdldHMsICd3aWR0aCcsIHFyV2lkdGhWYWx1ZSwgJyUnKTsKICAgIHNldHVwU2xpZGVyKHFySGVpZ2h0U2xpZGVyLCBxclBpY1RhcmdldHMsICdoZWlnaHQnLCBxckhlaWdodFZhbHVlLCAnJScpOwogICAgLy8gU2V0dXAgZm9yIFRleHQgT3ZlcmxheXMKICAgIGNvbnN0IHRleHRGaWVsZHMgPSBbCiAgICAgICAgJ2FwZWxsaWRvJywgJ25vbWJyZScsICdkb2N1bWVudG8nLCAnbmFjaW1pZW50bycsCiAgICAgICAgJ3RyYW1pdGUnLCAnZWplbXBsYXInLCAnZW1pc2lvbicsICd2ZW5jaW1pZW50bycsCiAgICAgICAgJ2RvbWljaWxpbycsICdzZXhvJwogICAgICAgIC8vICdjdWlsJyBpcyBoYW5kbGVkIHNlcGFyYXRlbHkgZm9yIGR5bmFtaWMgaGVhZGVyIHVwZGF0ZXMgYnV0IHVzZXMgdGhlIHNhbWUgc2V0dXAgbG9naWMKICAgIF07CiAgICB0ZXh0RmllbGRzLmZvckVhY2goc2V0dXBUZXh0Q29udHJvbCk7CiAgICBzZXR1cFRleHRDb250cm9sKCdjdWlsJyk7IC8vIEVuc3VyZSBDVUlMIGlzIGFsc28gc2V0IHVwCiAgICB1cGRhdGVEeW5hbWljSGVhZGVyRGF0YSgpOyAvLyBTZXQgaW5pdGlhbCBkeW5hbWljIG5hbWVzCiAgICBsZXQgaXNGbGlwcGVkID0gZmFsc2U7IC8vIFNoYXJlZCBzdGF0ZSBmb3IgRE5JIGNhcmQgZmxpcAogICAgZnVuY3Rpb24gcmVzZXREbmlDYXJkKCkgewogICAgICAgIGlmIChkbmlDYXJkSGVhZGVyKQogICAgICAgICAgICBkbmlDYXJkSGVhZGVyLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgaWYgKGRuaUluaXRpYWxWaWV3KQogICAgICAgICAgICBkbmlJbml0aWFsVmlldy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICBpZiAoZG5pU29saWNpdHVkVmlldykKICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkbmlEaWdpdGFsRGlzcGxheSkKICAgICAgICAgICAgZG5pRGlnaXRhbERpc3BsYXkuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBpZiAoZG5pQ2FyZEJvZHkpCiAgICAgICAgICAgIGRuaUNhcmRCb2R5LmNsYXNzTGlzdC5yZW1vdmUoJ25vLWhlYWRlcicpOwogICAgICAgIC8vIFJlc2V0IGhlYWRlcgogICAgICAgIGlmIChkb2N1bWVudG9zSGVhZGVyVGl0bGUpCiAgICAgICAgICAgIGRvY3VtZW50b3NIZWFkZXJUaXRsZS50ZXh0Q29udGVudCA9ICdEb2N1bWVudG9zJzsKICAgICAgICBpZiAocmVmcmVzaEljb24pCiAgICAgICAgICAgIHJlZnJlc2hJY29uLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKGRvY3VtZW50b3NIZWFkZXIpCiAgICAgICAgICAgIGRvY3VtZW50b3NIZWFkZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSAnZmxleC1zdGFydCc7CiAgICAgICAgLy8gUmVzZXQgZmxpcAogICAgICAgIGNvbnN0IGRuaUZsaXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWZsaXBwZXInKTsKICAgICAgICBpZiAoZG5pRmxpcHBlcikgewogICAgICAgICAgICBpZiAoaXNGbGlwcGVkKSB7CiAgICAgICAgICAgICAgICAvLyBBbmltYXRlIGl0IGJhY2sgdG8gdGhlIGZyb250IGlmIGl0IHdhcyBmbGlwcGVkCiAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAndHJhbnNmb3JtIDAuNnMgY3ViaWMtYmV6aWVyKDAuMzQsIDEuNTYsIDAuNjQsIDEpJzsKICAgICAgICAgICAgICAgIGRuaUZsaXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3JvdGF0ZVkoMGRlZyknOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlzRmxpcHBlZCA9IGZhbHNlOyAvLyBBbHdheXMgcmVzZXQgdGhlIGxvZ2ljYWwgc3RhdGUKICAgIH0KICAgIGZ1bmN0aW9uIHNob3dTY3JlZW4oc2NyZWVuTmFtZSkgewogICAgICAgIC8vIEhpZGUgYWxsIHNjcmVlbnMgZmlyc3QKICAgICAgICBpZiAobWFpblNjcmVlbikKICAgICAgICAgICAgbWFpblNjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkb2N1bWVudG9zU2NyZWVuKQogICAgICAgICAgICBkb2N1bWVudG9zU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKGhpam9zU2NyZWVuKQogICAgICAgICAgICBoaWpvc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkbmlEZXRhaWxzU2NyZWVuKQogICAgICAgICAgICBkbmlEZXRhaWxzU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKHRlbGVmb25vc1NjcmVlbikKICAgICAgICAgICAgdGVsZWZvbm9zU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgaWYgKGJvdHRvbU5hdikKICAgICAgICAgICAgYm90dG9tTmF2LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgc3dpdGNoIChzY3JlZW5OYW1lKSB7CiAgICAgICAgICAgIGNhc2UgJ21haW4nOgogICAgICAgICAgICAgICAgaWYgKG1haW5TY3JlZW4pCiAgICAgICAgICAgICAgICAgICAgbWFpblNjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgcmVzZXREbmlDYXJkKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnZG9jdW1lbnRvcyc6CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnRvc1NjcmVlbikKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudG9zU2NyZWVuLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICBpZiAoYm90dG9tTmF2KQogICAgICAgICAgICAgICAgICAgIGJvdHRvbU5hdi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2hpam9zJzoKICAgICAgICAgICAgICAgIGlmIChoaWpvc1NjcmVlbikKICAgICAgICAgICAgICAgICAgICBoaWpvc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2RldGFpbHMnOgogICAgICAgICAgICAgICAgaWYgKGRuaURldGFpbHNTY3JlZW4pCiAgICAgICAgICAgICAgICAgICAgZG5pRGV0YWlsc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ3RlbGVmb25vcyc6CiAgICAgICAgICAgICAgICBpZiAodGVsZWZvbm9zU2NyZWVuKQogICAgICAgICAgICAgICAgICAgIHRlbGVmb25vc1NjcmVlbi5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gc2hvd0RuaURpZ2l0YWxWaWV3KCkgewogICAgICAgIGlmIChkbmlJbml0aWFsVmlldykKICAgICAgICAgICAgZG5pSW5pdGlhbFZpZXcuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBpZiAoZG5pU29saWNpdHVkVmlldykKICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIGlmIChkbmlEaWdpdGFsRGlzcGxheSkKICAgICAgICAgICAgZG5pRGlnaXRhbERpc3BsYXkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgaWYgKGRuaUNhcmRIZWFkZXIpCiAgICAgICAgICAgIGRuaUNhcmRIZWFkZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICBpZiAoZG5pQ2FyZEJvZHkpCiAgICAgICAgICAgIGRuaUNhcmRCb2R5LmNsYXNzTGlzdC5hZGQoJ25vLWhlYWRlcicpOwogICAgICAgIGlmIChkb2N1bWVudG9zSGVhZGVyVGl0bGUpCiAgICAgICAgICAgIGRvY3VtZW50b3NIZWFkZXJUaXRsZS50ZXh0Q29udGVudCA9ICdETkkgRGlnaXRhbCc7CiAgICAgICAgaWYgKHJlZnJlc2hJY29uKQogICAgICAgICAgICByZWZyZXNoSWNvbi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICBpZiAoZG9jdW1lbnRvc0hlYWRlcikKICAgICAgICAgICAgZG9jdW1lbnRvc0hlYWRlci5zdHlsZS5qdXN0aWZ5Q29udGVudCA9ICdzcGFjZS1iZXR3ZWVuJzsKICAgIH0KICAgIGZ1bmN0aW9uIHBvcHVsYXRlRG5pRGV0YWlscygpIHsKICAgICAgICAvLyBHZXQgdmFsdWVzIGZyb20gdGhlIGlucHV0IGZpZWxkcyBvbiB0aGUgImhpam9zIiAoZWRpdG9yKSBzY3JlZW4KICAgICAgICBjb25zdCBkbmkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgdHJhbWl0ZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0cmFtaXRlLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgZW1pc2lvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlbWlzaW9uLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgdmVuY2ltaWVudG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVuY2ltaWVudG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBub21icmUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbm9tYnJlLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgYXBlbGxpZG8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBlbGxpZG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBzZXhvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NleG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBuYWNpbWllbnRvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25hY2ltaWVudG8taW5wdXQnKS52YWx1ZTsKICAgICAgICBjb25zdCBkb21pY2lsaW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9taWNpbGlvLWlucHV0JykudmFsdWU7CiAgICAgICAgY29uc3QgY3VpbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdWlsLWlucHV0JykudmFsdWU7CiAgICAgICAgLy8gSGFyZGNvZGVkIGRhdGEgZm9yIG5vbi1lZGl0YWJsZSBmaWVsZHMgKGZvciBub3cpCiAgICAgICAgY29uc3QgbmFjaW9uYWxpZGFkID0gJ0FSJzsKICAgICAgICBjb25zdCBsdWdhck5hY2ltaWVudG8gPSAnQVJHRU5UaW5hJzsKICAgICAgICAvLyBQb3B1bGF0ZSB0aGUgZGV0YWlscyBzY3JlZW4gd2l0aCB0aGUgcmV0cmlldmVkIHZhbHVlcwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWRuaScpLnRleHRDb250ZW50ID0gZG5pOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLXRyYW1pdGUnKS50ZXh0Q29udGVudCA9IHRyYW1pdGU7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtZW1pc2lvbicpLnRleHRDb250ZW50ID0gZW1pc2lvbjsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy12ZW5jaW1pZW50bycpLnRleHRDb250ZW50ID0gdmVuY2ltaWVudG87CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtbm9tYnJlJykudGV4dENvbnRlbnQgPSBub21icmU7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtYXBlbGxpZG8nKS50ZXh0Q29udGVudCA9IGFwZWxsaWRvOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWN1aWwnKS50ZXh0Q29udGVudCA9IGN1aWw7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtc2V4bycpLnRleHRDb250ZW50ID0gc2V4bzsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy1uYWNpbWllbnRvJykudGV4dENvbnRlbnQgPSBuYWNpbWllbnRvOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLW5hY2lvbmFsaWRhZCcpLnRleHRDb250ZW50ID0gbmFjaW9uYWxpZGFkOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZXRhaWxzLWx1Z2FyLW5hY2ltaWVudG8nKS50ZXh0Q29udGVudCA9IGx1Z2FyTmFjaW1pZW50bzsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGV0YWlscy1kb21pY2lsaW8nKS50ZXh0Q29udGVudCA9IGRvbWljaWxpbzsKICAgIH0KICAgIGlmIChkb2N1bWVudG9zQnRuKSB7CiAgICAgICAgZG9jdW1lbnRvc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSB7CiAgICAgICAgICAgICAgICBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHNob3dTY3JlZW4oJ2RvY3VtZW50b3MnKTsKICAgICAgICAgICAgICAgIGlmIChsb2FkaW5nT3ZlcmxheSkgewogICAgICAgICAgICAgICAgICAgIGxvYWRpbmdPdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJEbmlEaWdpdGFsQnRuKSB7CiAgICAgICAgdmVyRG5pRGlnaXRhbEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgewogICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgc2hvd0RuaURpZ2l0YWxWaWV3KCk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uTG9hZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChoaWpvc0J0bikgewogICAgICAgIGhpam9zQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzaG93U2NyZWVuKCdoaWpvcycpOwogICAgICAgIH0pOwogICAgfQogICAgaWYgKGJhY2tCdG4pIHsKICAgICAgICBiYWNrQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBpZiAoZG5pRGlnaXRhbERpc3BsYXkgJiYgZ2V0Q29tcHV0ZWRTdHlsZShkbmlEaWdpdGFsRGlzcGxheSkuZGlzcGxheSAhPT0gJ25vbmUnKSB7CiAgICAgICAgICAgICAgICByZXNldERuaUNhcmQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHNob3dTY3JlZW4oJ21haW4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgaWYgKGRldGFpbHNCYWNrQnRuKSB7CiAgICAgICAgZGV0YWlsc0JhY2tCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHNob3dTY3JlZW4oJ2RvY3VtZW50b3MnKTsKICAgICAgICAgICAgc2hvd0RuaURpZ2l0YWxWaWV3KCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoaGlqb3NCYWNrQnRuKSB7CiAgICAgICAgaGlqb3NCYWNrQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzaG93U2NyZWVuKCdtYWluJyk7CiAgICAgICAgfSk7CiAgICB9CiAgICBpZiAoaW5pY2lvQnRuKSB7CiAgICAgICAgaW5pY2lvQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBzaG93U2NyZWVuKCdtYWluJyk7CiAgICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBoYW5kbGVUZWxlZm9ub3NOYXYgPSAoZSkgPT4gewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBpZiAobG9hZGluZ092ZXJsYXkpIHsKICAgICAgICAgICAgbG9hZGluZ092ZXJsYXkuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgICAgICAgfQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICBzaG93U2NyZWVuKCd0ZWxlZm9ub3MnKTsKICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSB7CiAgICAgICAgICAgICAgICBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgIH0sIDE1MDApOwogICAgfTsKICAgIGlmICh0ZWxlZm9ub3NCdG5Eb2NzKSB7CiAgICAgICAgdGVsZWZvbm9zQnRuRG9jcy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZVRlbGVmb25vc05hdik7CiAgICB9CiAgICBpZiAodGVsZWZvbm9zQnRuRGV0YWlscykgewogICAgICAgIHRlbGVmb25vc0J0bkRldGFpbHMuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBoYW5kbGVUZWxlZm9ub3NOYXYpOwogICAgfQogICAgaWYgKHRlbGVmb25vc0luaWNpb0J0bikgewogICAgICAgIHRlbGVmb25vc0luaWNpb0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSB7CiAgICAgICAgICAgICAgICBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIHNob3dTY3JlZW4oJ21haW4nKTsKICAgICAgICAgICAgICAgIGlmIChsb2FkaW5nT3ZlcmxheSkgewogICAgICAgICAgICAgICAgICAgIGxvYWRpbmdPdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmIChzb2xpY2l0YXJEbmlCdG4pIHsKICAgICAgICBzb2xpY2l0YXJEbmlCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGlmIChhY3Rpb25Mb2FkZXIpIHsKICAgICAgICAgICAgICAgIGFjdGlvbkxvYWRlci5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChkbmlJbml0aWFsVmlldykKICAgICAgICAgICAgICAgICAgICBkbmlJbml0aWFsVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKGRuaUNhcmRIZWFkZXIpCiAgICAgICAgICAgICAgICAgICAgZG5pQ2FyZEhlYWRlci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgaWYgKGRuaVNvbGljaXR1ZFZpZXcpCiAgICAgICAgICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgICAgIGlmIChkbmlDYXJkQm9keSkKICAgICAgICAgICAgICAgICAgICBkbmlDYXJkQm9keS5jbGFzc0xpc3QuYWRkKCduby1oZWFkZXInKTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpb25Mb2FkZXIpIHsKICAgICAgICAgICAgICAgICAgICBhY3Rpb25Mb2FkZXIuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDE1MDApOwogICAgICAgIH0pOwogICAgfQogICAgaWYgKGNvbmZpcm1hclNvbGljaXR1ZEJ0bikgewogICAgICAgIGNvbmZpcm1hclNvbGljaXR1ZEJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgewogICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgaWYgKGRuaVNvbGljaXR1ZFZpZXcpCiAgICAgICAgICAgICAgICAgICAgZG5pU29saWNpdHVkVmlldy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgc2hvd0RuaURpZ2l0YWxWaWV3KCk7CiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uTG9hZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAxNTAwKTsKICAgICAgICB9KTsKICAgIH0KICAgIGlmICh2ZXJEZXRhbGxlQnRuKSB7CiAgICAgICAgdmVyRGV0YWxsZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgcG9wdWxhdGVEbmlEZXRhaWxzKCk7CiAgICAgICAgICAgIHNob3dTY3JlZW4oJ2RldGFpbHMnKTsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIFVzZXIgTWVudSBMb2dpYwogICAgaWYgKHVzZXJQcm9maWxlQnRuICYmIHVzZXJNZW51ICYmIHByb2ZpbGVBcnJvdykgewogICAgICAgIHVzZXJQcm9maWxlQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsgLy8gUHJldmVudHMgdGhlIGRvY3VtZW50IGNsaWNrIGxpc3RlbmVyIGZyb20gZmlyaW5nIGltbWVkaWF0ZWx5CiAgICAgICAgICAgIHVzZXJNZW51LmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScpOwogICAgICAgICAgICBwcm9maWxlQXJyb3cuY2xhc3NMaXN0LnRvZ2dsZSgncm90YXRlZCcpOwogICAgICAgIH0pOwogICAgICAgIC8vIENsb3NlIG1lbnUgd2hlbiBjbGlja2luZyBvdXRzaWRlCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICBpZiAodXNlck1lbnUuY2xhc3NMaXN0LmNvbnRhaW5zKCdhY3RpdmUnKSkgewogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7CiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgY2xpY2sgaXMgb3V0c2lkZSB0aGUgbWVudSBBTkQgbm90IG9uIHRoZSBwcm9maWxlIGJ1dHRvbiBpdHNlbGYKICAgICAgICAgICAgICAgIGlmICghdXNlck1lbnUuY29udGFpbnModGFyZ2V0KSAmJiAhdXNlclByb2ZpbGVCdG4uY29udGFpbnModGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgIHVzZXJNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgIHByb2ZpbGVBcnJvdy5jbGFzc0xpc3QucmVtb3ZlKCdyb3RhdGVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIC8vIExpbmsgZnJvbSBtZW51IHRvIEhpam9zIHNjcmVlbgogICAgaWYgKG1lbnVIaWpvc0J0bikgewogICAgICAgIG1lbnVIaWpvc0J0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgc2hvd1NjcmVlbignaGlqb3MnKTsKICAgICAgICAgICAgLy8gQ2xvc2UgbWVudSBhZnRlciBuYXZpZ2F0aW9uCiAgICAgICAgICAgIGlmICh1c2VyTWVudSAmJiBwcm9maWxlQXJyb3cpIHsKICAgICAgICAgICAgICAgIHVzZXJNZW51LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgcHJvZmlsZUFycm93LmNsYXNzTGlzdC5yZW1vdmUoJ3JvdGF0ZWQnKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgLy8gUHJldmVudCBpbmFjdGl2ZSBtZW51IGxpbmtzIGZyb20gbmF2aWdhdGluZwogICAgaWYgKHVzZXJNZW51ICYmIHByb2ZpbGVBcnJvdykgewogICAgICAgIGNvbnN0IGluYWN0aXZlTGlua3MgPSB1c2VyTWVudS5xdWVyeVNlbGVjdG9yQWxsKCcudXNlci1tZW51LWxpc3QgYTpub3QoI21lbnUtaGlqb3MtYnRuKSwgLnVzZXItbWVudS1mb290ZXIgYScpOwogICAgICAgIGluYWN0aXZlTGlua3MuZm9yRWFjaChsaW5rID0+IHsKICAgICAgICAgICAgbGluay5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICB1c2VyTWVudS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgIHByb2ZpbGVBcnJvdy5jbGFzc0xpc3QucmVtb3ZlKCdyb3RhdGVkJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgLy8gRE5JIENhcmQgQ29sbGFwc2UvRXhwYW5kIExvZ2ljCiAgICBjb25zdCBkbmlDYXJkID0gZG9jdW1lbnRvc1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcuZG5pLWNhcmQnKTsKICAgIGlmIChkbmlDYXJkSGVhZGVyICYmIGRuaUNhcmQpIHsKICAgICAgICBkbmlDYXJkSGVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAvLyBPbmx5IGFsbG93IGNvbGxhcHNpbmcgaWYgdGhlIGluaXRpYWwgb3Igc29saWNpdHVkIHZpZXcgaXMgdmlzaWJsZQogICAgICAgICAgICBjb25zdCBpc0luaXRpYWxTdGF0ZSA9IGdldENvbXB1dGVkU3R5bGUoZG5pSW5pdGlhbFZpZXcpLmRpc3BsYXkgIT09ICdub25lJyB8fCBnZXRDb21wdXRlZFN0eWxlKGRuaVNvbGljaXR1ZFZpZXcpLmRpc3BsYXkgIT09ICdub25lJzsKICAgICAgICAgICAgaWYgKGlzSW5pdGlhbFN0YXRlKSB7CiAgICAgICAgICAgICAgICBkbmlDYXJkLmNsYXNzTGlzdC50b2dnbGUoJ2lzLWNvbGxhcHNlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyBETkkgRmxpcHBlciBMb2dpYwogICAgY29uc3QgZG5pRmxpcHBlckNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kbmktZmxpcHBlci1jb250YWluZXInKTsKICAgIGNvbnN0IGRuaUZsaXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLWZsaXBwZXInKTsKICAgIGlmIChkbmlGbGlwcGVyQ29udGFpbmVyICYmIGRuaUZsaXBwZXIpIHsKICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGxldCBzdGFydFggPSAwOwogICAgICAgIGxldCBzdGFydEFuZ2xlID0gMDsKICAgICAgICBsZXQgY3VycmVudEFuZ2xlID0gMDsKICAgICAgICBjb25zdCBnZXRFdmVudFggPSAoZSkgPT4gewogICAgICAgICAgICByZXR1cm4gZS50eXBlLmluY2x1ZGVzKCdtb3VzZScpID8gZS5zY3JlZW5YIDogZS5jaGFuZ2VkVG91Y2hlc1swXS5zY3JlZW5YOwogICAgICAgIH07CiAgICAgICAgY29uc3QgaGFuZGxlRHJhZ1N0YXJ0ID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ21vdXNlZG93bicgJiYgZS5idXR0b24gIT09IDApCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBzdGFydFggPSBnZXRFdmVudFgoZSk7CiAgICAgICAgICAgIHN0YXJ0QW5nbGUgPSBjdXJyZW50QW5nbGU7CiAgICAgICAgICAgIGRuaUZsaXBwZXIuc3R5bGUudHJhbnNpdGlvbiA9ICdub25lJzsgLy8gTm8gdHJhbnNpdGlvbiB3aGlsZSBkcmFnZ2luZwogICAgICAgICAgICBpZiAoZS50eXBlICE9PSAndG91Y2hzdGFydCcpIHsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgY29uc3QgaGFuZGxlRHJhZ01vdmUgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBzY3JvbGxpbmcgd2hpbGUgZHJhZ2dpbmcgY2FyZAogICAgICAgICAgICBjb25zdCBjdXJyZW50WCA9IGdldEV2ZW50WChlKTsKICAgICAgICAgICAgY29uc3QgZGVsdGFYID0gY3VycmVudFggLSBzdGFydFg7CiAgICAgICAgICAgIC8vIEEgZnVsbCBkcmFnIGFjcm9zcyB0aGUgY2FyZCB3aWR0aCBzaG91bGQgYmUgYWJvdXQgYSAxODAtZGVncmVlIHR1cm4KICAgICAgICAgICAgY29uc3Qgcm90YXRpb25TZW5zaXRpdml0eSA9IDE4MCAvIGRuaUZsaXBwZXJDb250YWluZXIub2Zmc2V0V2lkdGg7CiAgICAgICAgICAgIGNvbnN0IGRlbHRhQW5nbGUgPSBkZWx0YVggKiByb3RhdGlvblNlbnNpdGl2aXR5OwogICAgICAgICAgICBjdXJyZW50QW5nbGUgPSBzdGFydEFuZ2xlICsgZGVsdGFBbmdsZTsKICAgICAgICAgICAgZG5pRmxpcHBlci5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlWSgke2N1cnJlbnRBbmdsZX1kZWcpYDsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGhhbmRsZURyYWdFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgZG5pRmxpcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ3RyYW5zZm9ybSAwLjZzIGN1YmljLWJlemllcigwLjM0LCAxLjU2LCAwLjY0LCAxKSc7CiAgICAgICAgICAgIC8vIFNuYXAgdG8gdGhlIG5lYXJlc3QgMTgwLWRlZ3JlZSBzaWRlCiAgICAgICAgICAgIGNvbnN0IGZpbmFsUm90YXRpb24gPSBNYXRoLnJvdW5kKGN1cnJlbnRBbmdsZSAvIDE4MCkgKiAxODA7CiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgbG9naWNhbCBzdGF0ZSBiYXNlZCBvbiB0aGUgZmluYWwgYW5nbGUKICAgICAgICAgICAgLy8gVXNlIG1vZHVsbyB0byBoYW5kbGUgbXVsdGlwbGUgc3BpbnMsIHRob3VnaCB1bmxpa2VseQogICAgICAgICAgICBpc0ZsaXBwZWQgPSAoTWF0aC5yb3VuZChmaW5hbFJvdGF0aW9uIC8gMTgwKSAlIDIpICE9PSAwOwogICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9IGByb3RhdGVZKCR7ZmluYWxSb3RhdGlvbn1kZWcpYDsKICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gZmluYWxSb3RhdGlvbjsgLy8gU3RvcmUgdGhlIGZpbmFsIGFuZ2xlCiAgICAgICAgfTsKICAgICAgICAvLyBNb3VzZSBldmVudHMKICAgICAgICBkbmlGbGlwcGVyQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZURyYWdTdGFydCk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlRHJhZ01vdmUpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVEcmFnRW5kKTsKICAgICAgICAvLyBUb3VjaCBldmVudHMgLSBwYXNzaXZlOiBmYWxzZSBpcyByZXF1aXJlZCB0byBjYWxsIGUucHJldmVudERlZmF1bHQoKSBpbiB0aGUgbW92ZSBoYW5kbGVyCiAgICAgICAgZG5pRmxpcHBlckNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlRHJhZ1N0YXJ0LCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZURyYWdNb3ZlLCB7IHBhc3NpdmU6IGZhbHNlIH0pOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRHJhZ0VuZCk7CiAgICB9CiAgICAvLyBIaWpvcyBETkkgRmxpcHBlciBMb2dpYwogICAgY29uc3QgaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1mbGlwcGVyLWNvbnRhaW5lcicpOwogICAgY29uc3QgaGlqb3NEbmlGbGlwcGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hpam9zLWRuaS1mbGlwcGVyJyk7CiAgICBpZiAoaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyICYmIGhpam9zRG5pRmxpcHBlcikgewogICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgbGV0IHN0YXJ0WCA9IDA7CiAgICAgICAgbGV0IHN0YXJ0QW5nbGUgPSAwOwogICAgICAgIGxldCBjdXJyZW50QW5nbGUgPSAwOwogICAgICAgIGNvbnN0IGdldEV2ZW50WCA9IChlKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBlLnR5cGUuaW5jbHVkZXMoJ21vdXNlJykgPyBlLnNjcmVlblggOiBlLmNoYW5nZWRUb3VjaGVzWzBdLnNjcmVlblg7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBoYW5kbGVEcmFnU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoZS50eXBlID09PSAnbW91c2Vkb3duJyAmJiBlLmJ1dHRvbiAhPT0gMCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0WCA9IGdldEV2ZW50WChlKTsKICAgICAgICAgICAgc3RhcnRBbmdsZSA9IGN1cnJlbnRBbmdsZTsKICAgICAgICAgICAgaGlqb3NEbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAnbm9uZSc7IC8vIE5vIHRyYW5zaXRpb24gd2hpbGUgZHJhZ2dpbmcKICAgICAgICAgICAgaWYgKGUudHlwZSAhPT0gJ3RvdWNoc3RhcnQnKSB7CiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IGhhbmRsZURyYWdNb3ZlID0gKGUpID0+IHsKICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7IC8vIHByZXZlbnQgc2Nyb2xsaW5nIHdoaWxlIGRyYWdnaW5nIGNhcmQKICAgICAgICAgICAgY29uc3QgY3VycmVudFggPSBnZXRFdmVudFgoZSk7CiAgICAgICAgICAgIGNvbnN0IGRlbHRhWCA9IGN1cnJlbnRYIC0gc3RhcnRYOwogICAgICAgICAgICBjb25zdCByb3RhdGlvblNlbnNpdGl2aXR5ID0gMTgwIC8gaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyLm9mZnNldFdpZHRoOwogICAgICAgICAgICBjb25zdCBkZWx0YUFuZ2xlID0gZGVsdGFYICogcm90YXRpb25TZW5zaXRpdml0eTsKICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gc3RhcnRBbmdsZSArIGRlbHRhQW5nbGU7CiAgICAgICAgICAgIGhpam9zRG5pRmxpcHBlci5zdHlsZS50cmFuc2Zvcm0gPSBgcm90YXRlWSgke2N1cnJlbnRBbmdsZX1kZWcpYDsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGhhbmRsZURyYWdFbmQgPSAoZSkgPT4gewogICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgaGlqb3NEbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAndHJhbnNmb3JtIDAuNnMgY3ViaWMtYmV6aWVyKDAuMzQsIDEuNTYsIDAuNjQsIDEpJzsKICAgICAgICAgICAgY29uc3QgZmluYWxSb3RhdGlvbiA9IE1hdGgucm91bmQoY3VycmVudEFuZ2xlIC8gMTgwKSAqIDE4MDsKICAgICAgICAgICAgaGlqb3NEbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9IGByb3RhdGVZKCR7ZmluYWxSb3RhdGlvbn1kZWcpYDsKICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gZmluYWxSb3RhdGlvbjsKICAgICAgICB9OwogICAgICAgIC8vIE1vdXNlIGV2ZW50cwogICAgICAgIGhpam9zRG5pRmxpcHBlckNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVEcmFnU3RhcnQpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZURyYWdNb3ZlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRHJhZ0VuZCk7CiAgICAgICAgLy8gVG91Y2ggZXZlbnRzCiAgICAgICAgaGlqb3NEbmlGbGlwcGVyQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBoYW5kbGVEcmFnU3RhcnQsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlRHJhZ01vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVEcmFnRW5kKTsKICAgIH0KICAgIC8vIEhpam9zIENhcm91c2VsIExvZ2ljCiAgICBjb25zdCBjYXJvdXNlbFdyYXBwZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtY2Fyb3VzZWwtd3JhcHBlcicpOwogICAgY29uc3QgY2Fyb3VzZWxUcmFjayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoaWpvcy1jYXJvdXNlbC10cmFjaycpOwogICAgY29uc3Qgc2xpZGVzID0gQXJyYXkuZnJvbShjYXJvdXNlbFRyYWNrLmNoaWxkcmVuKTsKICAgIGNvbnN0IGRvdHNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtY2Fyb3VzZWwtZG90cycpOwogICAgaWYgKGNhcm91c2VsV3JhcHBlciAmJiBjYXJvdXNlbFRyYWNrICYmIHNsaWRlcy5sZW5ndGggPiAwICYmIGRvdHNDb250YWluZXIpIHsKICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gMDsKICAgICAgICBsZXQgaXNEcmFnZ2luZyA9IGZhbHNlOwogICAgICAgIGxldCBzdGFydFBvcyA9IDA7CiAgICAgICAgbGV0IGN1cnJlbnRUcmFuc2xhdGUgPSAwOwogICAgICAgIGxldCBwcmV2VHJhbnNsYXRlID0gMDsKICAgICAgICBsZXQgYW5pbWF0aW9uSUQ7CiAgICAgICAgY29uc3Qgc2xpZGVXaWR0aCA9ICgpID0+IHNsaWRlc1swXS5vZmZzZXRXaWR0aDsKICAgICAgICAvLyBDcmVhdGUgZG90cwogICAgICAgIHNsaWRlcy5mb3JFYWNoKChfLCBpKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGRvdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgZG90LmNsYXNzTGlzdC5hZGQoJ2Nhcm91c2VsLWRvdCcpOwogICAgICAgICAgICBpZiAoaSA9PT0gMCkKICAgICAgICAgICAgICAgIGRvdC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgZG90LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICAgICAgICAgICAgZ29Ub1NsaWRlKGkpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZG90c0NvbnRhaW5lci5hcHBlbmRDaGlsZChkb3QpOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGRvdHMgPSBBcnJheS5mcm9tKGRvdHNDb250YWluZXIuY2hpbGRyZW4pOwogICAgICAgIGZ1bmN0aW9uIGdvVG9TbGlkZShzbGlkZUluZGV4KSB7CiAgICAgICAgICAgIGlmIChzbGlkZUluZGV4IDwgMCB8fCBzbGlkZUluZGV4ID49IHNsaWRlcy5sZW5ndGgpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IC1zbGlkZUluZGV4ICogc2xpZGVXaWR0aCgpOwogICAgICAgICAgICBjYXJvdXNlbFRyYWNrLnN0eWxlLnRyYW5zZm9ybSA9IGB0cmFuc2xhdGVYKCR7b2Zmc2V0fXB4KWA7CiAgICAgICAgICAgIGNhcm91c2VsVHJhY2suc3R5bGUudHJhbnNpdGlvbiA9ICd0cmFuc2Zvcm0gMC4zcyBlYXNlLWluLW91dCc7CiAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IHNsaWRlSW5kZXg7CiAgICAgICAgICAgIHVwZGF0ZURvdHMoKTsKICAgICAgICAgICAgcHJldlRyYW5zbGF0ZSA9IG9mZnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRG90cygpIHsKICAgICAgICAgICAgZG90cy5mb3JFYWNoKChkb3QsIGkpID0+IHsKICAgICAgICAgICAgICAgIGRvdC5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCBpID09PSBjdXJyZW50SW5kZXgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZ2V0UG9zaXRpb25YID0gKGUpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGUudHlwZS5pbmNsdWRlcygnbW91c2UnKSA/IGUucGFnZVggOiBlLnRvdWNoZXNbMF0uY2xpZW50WDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHRvdWNoU3RhcnQoaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHN0YXJ0UG9zID0gZ2V0UG9zaXRpb25YKGUpOwogICAgICAgICAgICAgICAgYW5pbWF0aW9uSUQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uKTsKICAgICAgICAgICAgICAgIGNhcm91c2VsVHJhY2suc3R5bGUudHJhbnNpdGlvbiA9ICdub25lJzsKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG91Y2hNb3ZlKGUpIHsKICAgICAgICAgICAgaWYgKGlzRHJhZ2dpbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQb3NpdGlvbiA9IGdldFBvc2l0aW9uWChlKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSBwcmV2VHJhbnNsYXRlICsgY3VycmVudFBvc2l0aW9uIC0gc3RhcnRQb3M7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG91Y2hFbmQoKSB7CiAgICAgICAgICAgIGlzRHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uSUQpOwogICAgICAgICAgICBjb25zdCBtb3ZlZEJ5ID0gY3VycmVudFRyYW5zbGF0ZSAtIHByZXZUcmFuc2xhdGU7CiAgICAgICAgICAgIC8vIFNuYXAgbG9naWMKICAgICAgICAgICAgaWYgKG1vdmVkQnkgPCAtMTAwICYmIGN1cnJlbnRJbmRleCA8IHNsaWRlcy5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggKz0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobW92ZWRCeSA+IDEwMCAmJiBjdXJyZW50SW5kZXggPiAwKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggLT0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnb1RvU2xpZGUoY3VycmVudEluZGV4KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYW5pbWF0aW9uKCkgewogICAgICAgICAgICBzZXRTbGlkZXJQb3NpdGlvbigpOwogICAgICAgICAgICBpZiAoaXNEcmFnZ2luZykKICAgICAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRpb24pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTbGlkZXJQb3NpdGlvbigpIHsKICAgICAgICAgICAgY2Fyb3VzZWxUcmFjay5zdHlsZS50cmFuc2Zvcm0gPSBgdHJhbnNsYXRlWCgke2N1cnJlbnRUcmFuc2xhdGV9cHgpYDsKICAgICAgICB9CiAgICAgICAgLy8gRXZlbnQgTGlzdGVuZXJzCiAgICAgICAgc2xpZGVzLmZvckVhY2goKHNsaWRlLCBpbmRleCkgPT4gewogICAgICAgICAgICBjb25zdCBzbGlkZUltYWdlID0gc2xpZGUucXVlcnlTZWxlY3RvcignaW1nJyk7CiAgICAgICAgICAgIGlmIChzbGlkZUltYWdlKQogICAgICAgICAgICAgICAgc2xpZGVJbWFnZS5hZGRFdmVudExpc3RlbmVyKCdkcmFnc3RhcnQnLCAoZSkgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnRIYW5kbGVyID0gdG91Y2hTdGFydChpbmRleCk7CiAgICAgICAgICAgIGNvbnN0IGludGVyYWN0aW9uU3RhcnQgPSAoZSkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZS50YXJnZXQ7CiAgICAgICAgICAgICAgICAvLyBQcmV2ZW50IHN0YXJ0aW5nIGEgZHJhZyBpZiB0aGUgdXNlciBpcyBpbnRlcmFjdGluZyB3aXRoIGFueSBjb250cm9sIGVsZW1lbnQgb3IgaXRzIGNvbnRhaW5lci4KICAgICAgICAgICAgICAgIC8vIFRoaXMgYWxsb3dzIHNsaWRlcnMgYW5kIGlucHV0cyB0byBiZSB1c2VkIHdpdGhvdXQgbW92aW5nIHRoZSBjYXJvdXNlbC4KICAgICAgICAgICAgICAgIGlmICh0YXJnZXQuY2xvc2VzdCgnLmNvbnRyb2wtZ3JvdXAnKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0YXJ0SGFuZGxlcihlKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgLy8gVG91Y2ggZXZlbnRzCiAgICAgICAgICAgIHNsaWRlLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBpbnRlcmFjdGlvblN0YXJ0KTsKICAgICAgICAgICAgc2xpZGUuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0b3VjaEVuZCk7CiAgICAgICAgICAgIHNsaWRlLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRvdWNoTW92ZSk7CiAgICAgICAgICAgIC8vIE1vdXNlIGV2ZW50cwogICAgICAgICAgICBzbGlkZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBpbnRlcmFjdGlvblN0YXJ0KTsKICAgICAgICAgICAgc2xpZGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRvdWNoRW5kKTsKICAgICAgICAgICAgc2xpZGUuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsICgpID0+IHsKICAgICAgICAgICAgICAgIGlmIChpc0RyYWdnaW5nKQogICAgICAgICAgICAgICAgICAgIHRvdWNoRW5kKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzbGlkZS5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0b3VjaE1vdmUpOwogICAgICAgIH0pOwogICAgICAgIC8vIFJlc2l6ZSBvYnNlcnZlcgogICAgICAgIGNvbnN0IHJlc2l6ZU9ic2VydmVyID0gbmV3IFJlc2l6ZU9ic2VydmVyKCgpID0+IHsKICAgICAgICAgICAgZ29Ub1NsaWRlKGN1cnJlbnRJbmRleCk7CiAgICAgICAgfSk7CiAgICAgICAgcmVzaXplT2JzZXJ2ZXIub2JzZXJ2ZShjYXJvdXNlbFdyYXBwZXIpOwogICAgfQogICAgLy8gRXhwb3J0IEhUTUwgbG9naWMKICAgIGNvbnN0IGV4cG9ydEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdleHBvcnQtaHRtbC1idG4nKTsKICAgIGZ1bmN0aW9uIGdlbmVyYXRlQW5kRG93bmxvYWRIdG1sKCkgewogICAgICAgIGNvbnN0IHRlbXBIZWFkID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaGVhZCcpOwogICAgICAgIHRlbXBIZWFkLmlubmVySFRNTCA9IGRvY3VtZW50LmhlYWQuaW5uZXJIVE1MOwogICAgICAgIC8vIFJlbW92ZSBhbnkgcG90ZW50aWFsbHkgcHJvYmxlbWF0aWMgb3IgZHVwbGljYXRlZCBpY29uIGxpbmtzCiAgICAgICAgdGVtcEhlYWQucXVlcnlTZWxlY3RvckFsbCgnbGlua1tyZWw9Imljb24iXSwgbGlua1tyZWw9InNob3J0Y3V0IGljb24iXSwgbGlua1tyZWw9ImFwcGxlLXRvdWNoLWljb24iXScpLmZvckVhY2gobGluayA9PiBsaW5rLnJlbW92ZSgpKTsKICAgICAgICAvLyBBZGQgdGhlIGNvcnJlY3QsIHVzZXItc3BlY2lmaWVkIGljb24gbGluawogICAgICAgIGNvbnN0IGZhdmljb25MaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwogICAgICAgIGZhdmljb25MaW5rLnJlbCA9ICdpY29uJzsKICAgICAgICBmYXZpY29uTGluay5ocmVmID0gJ2h0dHBzOi8vaWlsaS5pby9LWFJCbnRhLmpwZyc7CiAgICAgICAgZmF2aWNvbkxpbmsudHlwZSA9ICdpbWFnZS9qcGVnJzsKICAgICAgICB0ZW1wSGVhZC5hcHBlbmRDaGlsZChmYXZpY29uTGluayk7CiAgICAgICAgLy8gQWxzbyBhZGQgYXBwbGUtdG91Y2gtaWNvbiBmb3IgZ29vZCBtZWFzdXJlCiAgICAgICAgY29uc3QgYXBwbGVUb3VjaEljb25MaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpOwogICAgICAgIGFwcGxlVG91Y2hJY29uTGluay5yZWwgPSAnYXBwbGUtdG91Y2gtaWNvbic7CiAgICAgICAgYXBwbGVUb3VjaEljb25MaW5rLmhyZWYgPSAnaHR0cHM6Ly9paWxpLmlvL0tYUkJudGEuanBnJzsKICAgICAgICB0ZW1wSGVhZC5hcHBlbmRDaGlsZChhcHBsZVRvdWNoSWNvbkxpbmspOwogICAgICAgIGNvbnN0IGhlYWRDb250ZW50ID0gdGVtcEhlYWQuaW5uZXJIVE1MOwogICAgICAgIGNvbnN0IGJvZHlDbG9uZSA9IGRvY3VtZW50LmJvZHkuY2xvbmVOb2RlKHRydWUpOwogICAgICAgIGNvbnN0IGhpam9zU2NyZWVuQ2xvbmUgPSBib2R5Q2xvbmUucXVlcnlTZWxlY3RvcignI2hpam9zLXNjcmVlbicpOwogICAgICAgIGlmIChoaWpvc1NjcmVlbkNsb25lKQogICAgICAgICAgICBoaWpvc1NjcmVlbkNsb25lLnJlbW92ZSgpOwogICAgICAgIGNvbnN0IHNjcmlwdFRhZ0Nsb25lID0gYm9keUNsb25lLnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdFtzcmM9ImluZGV4LnRzeCJdJyk7CiAgICAgICAgaWYgKHNjcmlwdFRhZ0Nsb25lKQogICAgICAgICAgICBzY3JpcHRUYWdDbG9uZS5yZW1vdmUoKTsKICAgICAgICBjb25zdCBhcHBseUFsbER5bmFtaWNEYXRhVG9DbG9uZSA9IChjbG9uZSkgPT4gewogICAgICAgICAgICBjb25zdCBnZXRMaXZlVmFsdWUgPSAoaWQpID0+IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKT8udmFsdWUgfHwgJyc7CiAgICAgICAgICAgIGNvbnN0IHNldENsb25lVGV4dCA9IChzZWxlY3RvciwgdmFsdWUsIGlzVXBwZXJjYXNlID0gZmFsc2UpID0+IHsKICAgICAgICAgICAgICAgIGNsb25lLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpLmZvckVhY2goZWwgPT4gewogICAgICAgICAgICAgICAgICAgIGVsLnRleHRDb250ZW50ID0gaXNVcHBlcmNhc2UgPyB2YWx1ZS50b1VwcGVyQ2FzZSgpIDogdmFsdWU7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc3Qgc2V0Q2xvbmVTcmMgPSAoc2VsZWN0b3IsIHZhbHVlKSA9PiB7CiAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKS5mb3JFYWNoKGVsID0+IHsKICAgICAgICAgICAgICAgICAgICBlbC5zcmMgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCBhcHBseVN0eWxlRnJvbVNsaWRlciA9IChjbG9uZSwgZmllbGQsIHByb3BlcnR5LCB1bml0KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGdldExpdmVWYWx1ZShgJHtmaWVsZH0tJHtwcm9wZXJ0eS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoJ3NpemUnLCAnJykucmVwbGFjZSgnZmFtaWx5JywgJycpfS1zbGlkZXJgKSB8fCBnZXRMaXZlVmFsdWUoYCR7ZmllbGR9LSR7cHJvcGVydHkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdzaXplJywgJycpLnJlcGxhY2UoJ2ZhbWlseScsICcnKX0tc2VsZWN0YCk7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKGAjbWFpbi1kbmktJHtmaWVsZH0sICNoaWpvcy1kbmktJHtmaWVsZH1gKS5mb3JFYWNoKGVsID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgZWwuc3R5bGVbcHJvcGVydHldID0gYCR7dmFsdWV9JHt1bml0fWA7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIC8vIC0tLSBBcHBseSBJbWFnZSBVUkxzIGFuZCBTdHlsZXMgLS0tCiAgICAgICAgICAgIHNldENsb25lU3JjKCcjbWFpbi1kbmktcHJvZmlsZS1pbWFnZSwgI2RldGFpbHMtcHJvZmlsZS1pbWFnZScsIGdldExpdmVWYWx1ZSgnaW1hZ2UtdXJsLWlucHV0JykpOwogICAgICAgICAgICBzZXRDbG9uZVNyYygnI21haW4tZG5pLWJhY2staW1hZ2UnLCBnZXRMaXZlVmFsdWUoJ2RuaS1iYWNrLXVybC1pbnB1dCcpKTsKICAgICAgICAgICAgc2V0Q2xvbmVTcmMoJyNtYWluLWRuaS1xci1pbWFnZSwgI2RldGFpbHMtYmFyY29kZS1pbWFnZScsIGdldExpdmVWYWx1ZSgncXItdXJsLWlucHV0JykpOwogICAgICAgICAgICBbJ3RvcCcsICdsZWZ0JywgJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2gocHJvcCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSBnZXRMaXZlVmFsdWUoYCR7cHJvcH0tc2xpZGVyYCk7CiAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKCcjbWFpbi1kbmktcHJvZmlsZS1waWMnKS5mb3JFYWNoKGVsID0+IGVsLnN0eWxlW3Byb3BdID0gYCR7dmFsfSVgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIFsndG9wJywgJ2xlZnQnLCAnd2lkdGgnLCAnaGVpZ2h0J10uZm9yRWFjaChwcm9wID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IGdldExpdmVWYWx1ZShgcXItJHtwcm9wfS1zbGlkZXJgKTsKICAgICAgICAgICAgICAgIGNsb25lLnF1ZXJ5U2VsZWN0b3JBbGwoJyNtYWluLWRuaS1xci1waWMnKS5mb3JFYWNoKGVsID0+IGVsLnN0eWxlW3Byb3BdID0gYCR7dmFsfSVgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIC0tLSBBcHBseSBUZXh0IENvbnRlbnQgYW5kIFN0eWxlcyAtLS0KICAgICAgICAgICAgY29uc3QgYWxsVGV4dEZpZWxkcyA9IFsnYXBlbGxpZG8nLCAnbm9tYnJlJywgJ2RvY3VtZW50bycsICduYWNpbWllbnRvJywgJ3RyYW1pdGUnLCAnZWplbXBsYXInLCAnZW1pc2lvbicsICd2ZW5jaW1pZW50bycsICdkb21pY2lsaW8nLCAnc2V4bycsICdjdWlsJ107CiAgICAgICAgICAgIGFsbFRleHRGaWVsZHMuZm9yRWFjaChmaWVsZCA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGdldExpdmVWYWx1ZShgJHtmaWVsZH0taW5wdXRgKTsKICAgICAgICAgICAgICAgIHNldENsb25lVGV4dChgI21haW4tZG5pLSR7ZmllbGR9YCwgdmFsdWUsIFsnYXBlbGxpZG8nLCAnc2V4bycsICdkb21pY2lsaW8nXS5pbmNsdWRlcyhmaWVsZCkpOwogICAgICAgICAgICAgICAgYXBwbHlTdHlsZUZyb21TbGlkZXIoY2xvbmUsIGZpZWxkLCAndG9wJywgJyUnKTsKICAgICAgICAgICAgICAgIGFwcGx5U3R5bGVGcm9tU2xpZGVyKGNsb25lLCBmaWVsZCwgJ2xlZnQnLCAnJScpOwogICAgICAgICAgICAgICAgYXBwbHlTdHlsZUZyb21TbGlkZXIoY2xvbmUsIGZpZWxkLCAnZm9udFNpemUnLCAncHgnKTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvbnQgPSBnZXRMaXZlVmFsdWUoYCR7ZmllbGR9LWZvbnQtc2VsZWN0YCk7CiAgICAgICAgICAgICAgICBjbG9uZS5xdWVyeVNlbGVjdG9yQWxsKGAjbWFpbi1kbmktJHtmaWVsZH1gKS5mb3JFYWNoKGVsID0+IGVsLnN0eWxlLmZvbnRGYW1pbHkgPSBmb250KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIC0tLSBQb3B1bGF0ZSBIZWFkZXJzIGFuZCBEZXRhaWxzIFNjcmVlbiAtLS0KICAgICAgICAgICAgY29uc3Qgbm9tYnJlID0gZ2V0TGl2ZVZhbHVlKCdub21icmUtaW5wdXQnKTsKICAgICAgICAgICAgY29uc3QgYXBlbGxpZG8gPSBnZXRMaXZlVmFsdWUoJ2FwZWxsaWRvLWlucHV0Jyk7CiAgICAgICAgICAgIGNvbnN0IGN1aWwgPSBnZXRMaXZlVmFsdWUoJ2N1aWwtaW5wdXQnKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjd2VsY29tZS1uYW1lLCAjZGV0YWlscy1ub21icmUnLCBub21icmUpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkbmktZGlnaXRhbC10aXRsZScsIGAke2FwZWxsaWRvfSAke25vbWJyZX1gLCB0cnVlKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjc29saWNpdHVkLWRuaS1uYW1lJywgYCR7bm9tYnJlfSAke2FwZWxsaWRvfWApOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNtZW51LXVzZXItbmFtZScsIGAke25vbWJyZX0gJHthcGVsbGlkb31gKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjbWVudS11c2VyLWlkJywgY3VpbCk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtYXBlbGxpZG8nLCBhcGVsbGlkbywgdHJ1ZSk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtY3VpbCcsIGN1aWwpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLWRuaScsIGdldExpdmVWYWx1ZSgnZG9jdW1lbnRvLWlucHV0JykpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLXRyYW1pdGUnLCBnZXRMaXZlVmFsdWUoJ3RyYW1pdGUtaW5wdXQnKSk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtZW1pc2lvbicsIGdldExpdmVWYWx1ZSgnZW1pc2lvbi1pbnB1dCcpKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjZGV0YWlscy12ZW5jaW1pZW50bycsIGdldExpdmVWYWx1ZSgndmVuY2ltaWVudG8taW5wdXQnKSk7CiAgICAgICAgICAgIHNldENsb25lVGV4dCgnI2RldGFpbHMtc2V4bycsIGdldExpdmVWYWx1ZSgnc2V4by1pbnB1dCcpLCB0cnVlKTsKICAgICAgICAgICAgc2V0Q2xvbmVUZXh0KCcjZGV0YWlscy1uYWNpbWllbnRvJywgZ2V0TGl2ZVZhbHVlKCduYWNpbWllbnRvLWlucHV0JykpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLWRvbWljaWxpbycsIGdldExpdmVWYWx1ZSgnZG9taWNpbGlvLWlucHV0JyksIHRydWUpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLW5hY2lvbmFsaWRhZCcsICdBUicsIHRydWUpOwogICAgICAgICAgICBzZXRDbG9uZVRleHQoJyNkZXRhaWxzLWx1Z2FyLW5hY2ltaWVudG8nLCAnQVJHRU5UaW5hJywgdHJ1ZSk7CiAgICAgICAgfTsKICAgICAgICBhcHBseUFsbER5bmFtaWNEYXRhVG9DbG9uZShib2R5Q2xvbmUpOwogICAgICAgIGNvbnN0IHJlc2V0Q2xvbmVUb0luaXRpYWxTdGF0ZSA9IChjbG9uZSkgPT4gewogICAgICAgICAgICBjb25zdCBzZXREaXNwbGF5ID0gKHNlbGVjdG9yLCBkaXNwbGF5KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBlbCA9IGNsb25lLnF1ZXJ5U2VsZWN0b3Ioc2VsZWN0b3IpOwogICAgICAgICAgICAgICAgaWYgKGVsKQogICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5OwogICAgICAgICAgICB9OwogICAgICAgICAgICBzZXREaXNwbGF5KCcjbWFpbi1zY3JlZW4nLCAnZmxleCcpOwogICAgICAgICAgICBzZXREaXNwbGF5KCcjZG9jdW1lbnRvcy1zY3JlZW4nLCAnbm9uZScpOwogICAgICAgICAgICBzZXREaXNwbGF5KCcjdGVsZWZvbm9zLXNjcmVlbicsICdub25lJyk7CiAgICAgICAgICAgIHNldERpc3BsYXkoJyNkbmktZGV0YWlscy1zY3JlZW4nLCAnbm9uZScpOwogICAgICAgICAgICBzZXREaXNwbGF5KCcjYm90dG9tLW5hdicsICdub25lJyk7CiAgICAgICAgICAgIC8vIFJlc2V0IERvY3VtZW50b3Mgc2NyZWVuIHN0YXRlCiAgICAgICAgICAgIGNvbnN0IGRvY1NjcmVlbiA9IGNsb25lLnF1ZXJ5U2VsZWN0b3IoJyNkb2N1bWVudG9zLXNjcmVlbicpOwogICAgICAgICAgICBpZiAoZG9jU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkbmlJbml0aWFsVmlldyA9IGRvY1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcjZG5pLWluaXRpYWwtdmlldycpOwogICAgICAgICAgICAgICAgaWYgKGRuaUluaXRpYWxWaWV3KQogICAgICAgICAgICAgICAgICAgIGRuaUluaXRpYWxWaWV3LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICAgICAgY29uc3QgZG5pRGlnaXRhbERpc3BsYXkgPSBkb2NTY3JlZW4ucXVlcnlTZWxlY3RvcignI2RuaS1kaWdpdGFsLWRpc3BsYXknKTsKICAgICAgICAgICAgICAgIGlmIChkbmlEaWdpdGFsRGlzcGxheSkKICAgICAgICAgICAgICAgICAgICBkbmlEaWdpdGFsRGlzcGxheS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgY29uc3QgZG5pRmxpcHBlciA9IGRvY1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcjZG5pLWZsaXBwZXInKTsKICAgICAgICAgICAgICAgIGlmIChkbmlGbGlwcGVyKQogICAgICAgICAgICAgICAgICAgIGRuaUZsaXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3JvdGF0ZVkoMGRlZyknOwogICAgICAgICAgICAgICAgY29uc3QgZG5pQ2FyZCA9IGRvY1NjcmVlbi5xdWVyeVNlbGVjdG9yKCcuZG5pLWNhcmQnKTsKICAgICAgICAgICAgICAgIGlmIChkbmlDYXJkKQogICAgICAgICAgICAgICAgICAgIGRuaUNhcmQuY2xhc3NMaXN0LnJlbW92ZSgnaXMtY29sbGFwc2VkJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHJlc2V0Q2xvbmVUb0luaXRpYWxTdGF0ZShib2R5Q2xvbmUpOwogICAgICAgIGNvbnN0IGludGVyYWN0aXZlU2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CiAgICAgICAgaW50ZXJhY3RpdmVTY3JpcHQudGV4dENvbnRlbnQgPSBgCiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCAoKSA9PiB7CiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0U2NyZWVuTmF2aWdhdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzY3JlZW5zID0gewogICAgICAgICAgICAgICAgICAgICAgICBtYWluOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi1zY3JlZW4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRvczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RvY3VtZW50b3Mtc2NyZWVuJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFpbHM6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGV0YWlscy1zY3JlZW4nKSwKICAgICAgICAgICAgICAgICAgICAgICAgdGVsZWZvbm9zOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVsZWZvbm9zLXNjcmVlbicpLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmF2cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRvczogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2JvdHRvbS1uYXYnKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLmRldGFpbHMtYm90dG9tLW5hdicpLAogICAgICAgICAgICAgICAgICAgICAgICB0ZWxlZm9ub3M6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy50ZWxlZm9ub3MtYm90dG9tLW5hdicpLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9hZGluZ092ZXJsYXkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZy1vdmVybGF5Jyk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd1NjcmVlbiA9IChzY3JlZW5LZXksIHN1YlZpZXcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhzY3JlZW5zKS5mb3JFYWNoKHMgPT4gcyAmJiAocy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC52YWx1ZXMobmF2cykuZm9yRWFjaChuID0+IG4gJiYgKG4uc3R5bGUuZGlzcGxheSA9ICdub25lJykpOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbnNbc2NyZWVuS2V5XSkgc2NyZWVuc1tzY3JlZW5LZXldLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2NyZWVuS2V5ID09PSAnZG9jdW1lbnRvcycgJiYgbmF2cy5kb2N1bWVudG9zKSBuYXZzLmRvY3VtZW50b3Muc3R5bGUuZGlzcGxheSA9ICdmbGV4JzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbktleSA9PT0gJ2RldGFpbHMnICYmIG5hdnMuZGV0YWlscykgbmF2cy5kZXRhaWxzLnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY3JlZW5LZXkgPT09ICd0ZWxlZm9ub3MnICYmIG5hdnMudGVsZWZvbm9zKSBuYXZzLnRlbGVmb25vcy5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcmVlbktleSA9PT0gJ2RvY3VtZW50b3MnICYmIHN1YlZpZXcgPT09ICdkaWdpdGFsJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2hvd0RuaVZpZXcnLCB7IGRldGFpbDogJ2RpZ2l0YWwnIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hdmlnYXRlV2l0aExvYWRlciA9IChzY3JlZW5LZXkpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxvYWRpbmdPdmVybGF5KSBsb2FkaW5nT3ZlcmxheS5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93U2NyZWVuKHNjcmVlbktleSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobG9hZGluZ092ZXJsYXkpIGxvYWRpbmdPdmVybGF5LmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvcy1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ2RvY3VtZW50b3MnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RldGFpbHMtYmFjay1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBzaG93U2NyZWVuKCdkb2N1bWVudG9zJywgJ2RpZ2l0YWwnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RlbGVmb25vcy1idG4tZG9jcycpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IG5hdmlnYXRlV2l0aExvYWRlcigndGVsZWZvbm9zJyk7IH0pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZWxlZm9ub3MtYnRuLWRldGFpbHMnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ3RlbGVmb25vcycpOyB9KTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVsZWZvbm9zLWluaWNpby1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ21haW4nKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2luaWNpby1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBuYXZpZ2F0ZVdpdGhMb2FkZXIoJ21haW4nKTsgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdERuaUZsb3coKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uTG9hZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FjdGlvbi1sb2FkZXInKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBkbmlWaWV3cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1pbml0aWFsLXZpZXcnKSwKICAgICAgICAgICAgICAgICAgICAgICAgc29saWNpdHVkOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG5pLXNvbGljaXR1ZC12aWV3JyksCiAgICAgICAgICAgICAgICAgICAgICAgIGRpZ2l0YWw6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGlnaXRhbC1kaXNwbGF5JyksCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBoZWFkZXJFbGVtZW50cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FyZEhlYWRlcjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1jYXJkLWhlYWRlcicpLAogICAgICAgICAgICAgICAgICAgICAgICBjYXJkQm9keTogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1jYXJkLWJvZHknKSwKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZG9jdW1lbnRvcy1zY3JlZW4gLmRvY3VtZW50b3MtaGVhZGVyJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZG9jdW1lbnRvcy1zY3JlZW4gLmRvY3VtZW50b3MtaGVhZGVyIGgyJyksCiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2hJY29uOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVmcmVzaC1pY29uJyksCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2hvd0RuaVZpZXcgPSAodmlld0tleSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBPYmplY3QudmFsdWVzKGRuaVZpZXdzKS5mb3JFYWNoKHYgPT4gdiAmJiAodi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkbmlWaWV3c1t2aWV3S2V5XSkgZG5pVmlld3Nbdmlld0tleV0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0RpZ2l0YWwgPSB2aWV3S2V5ID09PSAnZGlnaXRhbCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzU29saWNpdHVkID0gdmlld0tleSA9PT0gJ3NvbGljaXR1ZCc7CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyRWxlbWVudHMuY2FyZEhlYWRlcikgaGVhZGVyRWxlbWVudHMuY2FyZEhlYWRlci5zdHlsZS5kaXNwbGF5ID0gKGlzRGlnaXRhbCB8fCBpc1NvbGljaXR1ZCkgPyAnbm9uZScgOiAnZmxleCc7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXJFbGVtZW50cy5jYXJkQm9keSkgaGVhZGVyRWxlbWVudHMuY2FyZEJvZHkuY2xhc3NMaXN0LnRvZ2dsZSgnbm8taGVhZGVyJywgaXNEaWdpdGFsIHx8IGlzU29saWNpdHVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhlYWRlckVsZW1lbnRzLnRpdGxlKSBoZWFkZXJFbGVtZW50cy50aXRsZS50ZXh0Q29udGVudCA9IGlzRGlnaXRhbCA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGlnaXRhbC10aXRsZScpLnRleHRDb250ZW50IDogJ0RvY3VtZW50b3MnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyRWxlbWVudHMucmVmcmVzaEljb24pIGhlYWRlckVsZW1lbnRzLnJlZnJlc2hJY29uLnN0eWxlLmRpc3BsYXkgPSBpc0RpZ2l0YWwgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVhZGVyRWxlbWVudHMuaGVhZGVyKSBoZWFkZXJFbGVtZW50cy5oZWFkZXIuc3R5bGUuanVzdGlmeUNvbnRlbnQgPSBpc0RpZ2l0YWwgPyAnc3BhY2UtYmV0d2VlbicgOiAnZmxleC1zdGFydCc7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzaG93RG5pVmlldycsIChlKSA9PiBzaG93RG5pVmlldyhlLmRldGFpbCkpOwoKICAgICAgICAgICAgICAgICAgICBjb25zdCBwZXJmb3JtQWN0aW9uID0gKHZpZXcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dEbmlWaWV3KHZpZXcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbkxvYWRlcikgYWN0aW9uTG9hZGVyLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc29saWNpdGFyLWRuaS1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBwZXJmb3JtQWN0aW9uKCdzb2xpY2l0dWQnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Zlci1kbmktZGlnaXRhbC1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBlID0+IHsgZS5wcmV2ZW50RGVmYXVsdCgpOyBwZXJmb3JtQWN0aW9uKCdkaWdpdGFsJyk7IH0pOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25maXJtYXItc29saWNpdHVkLWJ0bicpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IHBlcmZvcm1BY3Rpb24oJ2RpZ2l0YWwnKTsgfSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Zlci1kZXRhbGxlLWJ0bicpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4geyBlLnByZXZlbnREZWZhdWx0KCk7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZGV0YWlscy1zY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOyB9KTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYmFjay1idG4nKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChnZXRDb21wdXRlZFN0eWxlKGRuaVZpZXdzLmRpZ2l0YWwpLmRpc3BsYXkgIT09ICdub25lJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93RG5pVmlldygnaW5pdGlhbCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmbGlwcGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2RuaS1mbGlwcGVyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGZsaXBwZXIpIGZsaXBwZXIuc3R5bGUudHJhbnNmb3JtID0gJ3JvdGF0ZVkoMGRlZyknOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi1zY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnRvcy1zY3JlZW4nKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gaW5pdFVzZXJNZW51KCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyLXByb2ZpbGUtYnRuJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1c2VyLW1lbnUnKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhcnJvdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcm9maWxlLWFycm93Jyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFidG4gfHwgIW1lbnUgfHwgIWFycm93KSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbnUuY2xhc3NMaXN0LnRvZ2dsZSgnYWN0aXZlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycm93LmNsYXNzTGlzdC50b2dnbGUoJ3JvdGF0ZWQnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVudS5jbGFzc0xpc3QuY29udGFpbnMoJ2FjdGl2ZScpICYmICFtZW51LmNvbnRhaW5zKGUudGFyZ2V0KSAmJiAhYnRuLmNvbnRhaW5zKGUudGFyZ2V0KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVudS5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycm93LmNsYXNzTGlzdC5yZW1vdmUoJ3JvdGF0ZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmdW5jdGlvbiBpbml0RG5pSW50ZXJhY3Rpb25zKCkgewogICAgICAgICAgICAgICAgICAgIC8vIEROSSBGbGlwcGVyIExvZ2ljIChEcmFnL1N3aXBlKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRuaUZsaXBwZXJDb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZG5pLWZsaXBwZXItY29udGFpbmVyJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG5pRmxpcHBlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktZmxpcHBlcicpOwoKICAgICAgICAgICAgICAgICAgICBpZiAoZG5pRmxpcHBlckNvbnRhaW5lciAmJiBkbmlGbGlwcGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdGFydFggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnRBbmdsZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjdXJyZW50QW5nbGUgPSAwOwoKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2V0RXZlbnRYID0gKGUpID0+IGUudHlwZS5pbmNsdWRlcygnbW91c2UnKSA/IGUuc2NyZWVuWCA6IGUuY2hhbmdlZFRvdWNoZXNbMF0uc2NyZWVuWDsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbmRsZURyYWdTdGFydCA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50eXBlID09PSAnbW91c2Vkb3duJyAmJiBlLmJ1dHRvbiAhPT0gMCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNEcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydFggPSBnZXRFdmVudFgoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydEFuZ2xlID0gY3VycmVudEFuZ2xlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZG5pRmxpcHBlci5zdHlsZS50cmFuc2l0aW9uID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUudHlwZSAhPT0gJ3RvdWNoc3RhcnQnKSBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVEcmFnTW92ZSA9IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRHJhZ2dpbmcpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRYID0gZ2V0RXZlbnRYKGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsdGFYID0gY3VycmVudFggLSBzdGFydFg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByb3RhdGlvblNlbnNpdGl2aXR5ID0gMTgwIC8gZG5pRmxpcHBlckNvbnRhaW5lci5vZmZzZXRXaWR0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhQW5nbGUgPSBkZWx0YVggKiByb3RhdGlvblNlbnNpdGl2aXR5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gc3RhcnRBbmdsZSArIGRlbHRhQW5nbGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9ICdyb3RhdGVZKCcgKyBjdXJyZW50QW5nbGUgKyAnZGVnKSc7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVEcmFnRW5kID0gKCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0RyYWdnaW5nKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0RyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zaXRpb24gPSAndHJhbnNmb3JtIDAuNnMgY3ViaWMtYmV6aWVyKDAuMzQsIDEuNTYsIDAuNjQsIDEpJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbmFsUm90YXRpb24gPSBNYXRoLnJvdW5kKGN1cnJlbnRBbmdsZSAvIDE4MCkgKiAxODA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbmlGbGlwcGVyLnN0eWxlLnRyYW5zZm9ybSA9ICdyb3RhdGVZKCcgKyBmaW5hbFJvdGF0aW9uICsgJ2RlZyknOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEFuZ2xlID0gZmluYWxSb3RhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGRuaUZsaXBwZXJDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgaGFuZGxlRHJhZ1N0YXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaGFuZGxlRHJhZ01vdmUpOwogICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlRHJhZ0VuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRuaUZsaXBwZXJDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZURyYWdTdGFydCwgeyBwYXNzaXZlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlRHJhZ01vdmUsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgaGFuZGxlRHJhZ0VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIC8vIEROSSBDb2xsYXBzZSBMb2dpYwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjZG9jdW1lbnRvcy1zY3JlZW4gLmRuaS1jYXJkJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVhZGVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RuaS1jYXJkLWhlYWRlcicpOwogICAgICAgICAgICAgICAgICAgIGlmIChoZWFkZXIgJiYgY2FyZCkgewogICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0luaXRpYWwgPSBnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktaW5pdGlhbC12aWV3JykpLmRpc3BsYXkgIT09ICdub25lJyB8fCBnZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkbmktc29saWNpdHVkLXZpZXcnKSkuZGlzcGxheSAhPT0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzSW5pdGlhbCkgY2FyZC5jbGFzc0xpc3QudG9nZ2xlKCdpcy1jb2xsYXBzZWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGluaXREaXNhYmxlZEJ1dHRvbnMoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0b3JzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAnI21haW4tc2NyZWVuIGEuZ3JpZC1pdGVtOm5vdCgjZG9jdW1lbnRvcy1idG4pOm5vdCgjaGlqb3MtYnRuKScsCiAgICAgICAgICAgICAgICAgICAgICAgICcjbWFpbi1zY3JlZW4gLnR1cm5vcy1jYXJkIC5idG4nLCAnI21haW4tc2NyZWVuIC5lbGVjY2lvbmVzLWNhcmQnLAogICAgICAgICAgICAgICAgICAgICAgICAnI2RvY3VtZW50b3Mtc2NyZWVuIC5kbmktYWN0aW9ucyBidXR0b246bm90KCN2ZXItZGV0YWxsZS1idG4pJywKICAgICAgICAgICAgICAgICAgICAgICAgJyNkb2N1bWVudG9zLXNjcmVlbiAuZG5pLXFyLXZlcmlmeScsCiAgICAgICAgICAgICAgICAgICAgICAgICcjYm90dG9tLW5hdiBhOm5vdCgjaW5pY2lvLWJ0bik6bm90KCN0ZWxlZm9ub3MtYnRuLWRvY3MpJywKICAgICAgICAgICAgICAgICAgICAgICAgJy5kZXRhaWxzLWJvdHRvbS1uYXYgYTpub3QoLmFjdGl2ZSk6bm90KCN0ZWxlZm9ub3MtYnRuLWRldGFpbHMpJywKICAgICAgICAgICAgICAgICAgICAgICAgJy50ZWxlZm9ub3MtYm90dG9tLW5hdiBhOm5vdCgjdGVsZWZvbm9zLWluaWNpby1idG4pJywKICAgICAgICAgICAgICAgICAgICAgICAgJyN1c2VyLW1lbnUgYTpub3QoI21lbnUtaGlqb3MtYnRuKScsCiAgICAgICAgICAgICAgICAgICAgICAgICcuYXBwLWhlYWRlciBzdmc6Zmlyc3Qtb2YtdHlwZScKICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3JzLmpvaW4oJywgJykpLmZvckVhY2goYnRuID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IGUucHJldmVudERlZmF1bHQoKSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgLy8gRGlzYWJsZSBIaWpvcyBidXR0b24gYXMgaXQgbGVhZHMgdG8gYSByZW1vdmVkIHNjcmVlbgogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW51LWhpam9zLWJ0bicpPy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4gZS5wcmV2ZW50RGVmYXVsdCgpKTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGlqb3MtYnRuJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZSA9PiBlLnByZXZlbnREZWZhdWx0KCkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7IGluaXRTY3JlZW5OYXZpZ2F0aW9uKCk7IH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBuYXZpZ2F0aW9uOicsIGUpOyB9CiAgICAgICAgICAgICAgICB0cnkgeyBpbml0RG5pRmxvdygpOyB9IGNhdGNoKGUpIHsgY29uc29sZS5lcnJvcignRXJyb3IgaW4gRE5JIGZsb3c6JywgZSk7IH0KICAgICAgICAgICAgICAgIHRyeSB7IGluaXRVc2VyTWVudSgpOyB9IGNhdGNoKGUpIHsgY29uc29sZS5lcnJvcignRXJyb3IgaW4gdXNlciBtZW51OicsIGUpOyB9CiAgICAgICAgICAgICAgICB0cnkgeyBpbml0RG5pSW50ZXJhY3Rpb25zKCk7IH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBETkkgaW50ZXJhY3Rpb25zOicsIGUpOyB9CiAgICAgICAgICAgICAgICB0cnkgeyBpbml0RGlzYWJsZWRCdXR0b25zKCk7IH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKCdFcnJvciBkaXNhYmxpbmcgYnV0dG9uczonLCBlKTsgfQogICAgICAgICAgICB9KTsKICAgICAgICBgOwogICAgICAgIGJvZHlDbG9uZS5hcHBlbmRDaGlsZChpbnRlcmFjdGl2ZVNjcmlwdCk7CiAgICAgICAgY29uc3QgaHRtbENvbnRlbnQgPSBgCiAgICAgICAgICAgIDwhRE9DVFlQRSBodG1sPgogICAgICAgICAgICA8aHRtbCBsYW5nPSJlcyI+CiAgICAgICAgICAgIDxoZWFkPiR7aGVhZENvbnRlbnR9PC9oZWFkPgogICAgICAgICAgICAke2JvZHlDbG9uZS5vdXRlckhUTUx9CiAgICAgICAgICAgIDwvaHRtbD4KICAgICAgICBgOwogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbaHRtbENvbnRlbnQudHJpbSgpXSwgeyB0eXBlOiAndGV4dC9odG1sJyB9KTsKICAgICAgICBjb25zdCBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGxpbmsuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgbGluay5kb3dubG9hZCA9ICdpbmRleC5odG1sJzsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmspOwogICAgICAgIGxpbmsuY2xpY2soKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmspOwogICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwobGluay5ocmVmKTsKICAgIH0KICAgIGlmIChleHBvcnRCdG4pIHsKICAgICAgICBleHBvcnRCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBnZW5lcmF0ZUFuZERvd25sb2FkSHRtbCk7CiAgICB9CiAgICAvLyBQV0EgU2VydmljZSBXb3JrZXIgUmVnaXN0cmF0aW9uCiAgICBpZiAoJ3NlcnZpY2VXb3JrZXInIGluIG5hdmlnYXRvcikgewogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4gewogICAgICAgICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWdpc3RlcignL3N3LmpzJykudGhlbihyZWdpc3RyYXRpb24gPT4gewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1NXIHJlZ2lzdGVyZWQ6ICcsIHJlZ2lzdHJhdGlvbik7CiAgICAgICAgICAgIH0pLmNhdGNoKHJlZ2lzdHJhdGlvbkVycm9yID0+IHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTVyByZWdpc3RyYXRpb24gZmFpbGVkOiAnLCByZWdpc3RyYXRpb25FcnJvcik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQp9KTsK","@/sw":"data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdtaWFyZ2VudGluYS1jYWNoZS12NCc7Ci8vIFRoaXMgbGlzdCBzaG91bGQgaW5jbHVkZSBhbGwgdGhlIGZ1bmRhbWVudGFsIGZpbGVzIGZvciB5b3VyIGFwcCBzaGVsbCB0byB3b3JrIG9mZmxpbmUuCmNvbnN0IHVybHNUb0NhY2hlID0gWwogICcvJywKICAnaW5kZXguaHRtbCcsCiAgLy8gVGhlIEpTIGFuZCBDU1MgYXJlIGlubGluZSwgc28gY2FjaGluZyBpbmRleC5odG1sIGlzIGVub3VnaC4KICAvLyBBZGQgYW55IGV4dGVybmFsIGFzc2V0cyB0aGF0IGFyZSBjcml0aWNhbC4KICAnaHR0cHM6Ly9paWxpLmlvL0tYRlJxS3UubWQucG5nJywgLy8gRE5JIEZyb250CiAgJ2h0dHBzOi8vaWlsaS5pby9LVzF6SWIxLm1kLnBuZycsIC8vIEROSSBCYWNrCiAgJ2h0dHBzOi8vaWlsaS5pby9LWFJCbnRhLmpwZycgLy8gQXBwIEljb24KXTsKCi8vIEluc3RhbGwgZXZlbnQ6IGZpcmVzIHdoZW4gdGhlIGJyb3dzZXIgaW5zdGFsbHMgdGhlIHNlcnZpY2Ugd29ya2VyLgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBldmVudCA9PiB7CiAgZXZlbnQud2FpdFVudGlsKAogICAgY2FjaGVzLm9wZW4oQ0FDSEVfTkFNRSkKICAgICAgLnRoZW4oY2FjaGUgPT4gewogICAgICAgIGNvbnNvbGUubG9nKCdPcGVuZWQgY2FjaGUsIGFkZGluZyBhcHAgc2hlbGwgZmlsZXMnKTsKICAgICAgICByZXR1cm4gY2FjaGUuYWRkQWxsKHVybHNUb0NhY2hlKTsKICAgICAgfSkKICApOwp9KTsKCi8vIEFjdGl2YXRlIGV2ZW50OiBmaXJlcyB3aGVuIHRoZSBzZXJ2aWNlIHdvcmtlciBiZWNvbWVzIGFjdGl2ZS4KLy8gVGhpcyBpcyBhIGdvb2QgcGxhY2UgdG8gbWFuYWdlIG9sZCBjYWNoZXMuCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignYWN0aXZhdGUnLCBldmVudCA9PiB7CiAgY29uc3QgY2FjaGVXaGl0ZWxpc3QgPSBbQ0FDSEVfTkFNRV07CiAgZXZlbnQud2FpdFVudGlsKAogICAgY2FjaGVzLmtleXMoKS50aGVuKGNhY2hlTmFtZXMgPT4gewogICAgICByZXR1cm4gUHJvbWlzZS5hbGwoCiAgICAgICAgY2FjaGVOYW1lcy5tYXAoY2FjaGVOYW1lID0+IHsKICAgICAgICAgIC8vIElmIGEgY2FjaGUgbmFtZSBpcyBub3QgaW4gb3VyIHdoaXRlbGlzdCwgd2UgZGVsZXRlIGl0LgogICAgICAgICAgaWYgKGNhY2hlV2hpdGVsaXN0LmluZGV4T2YoY2FjaGVOYW1lKSA9PT0gLTEpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0RlbGV0aW5nIG9sZCBjYWNoZTonLCBjYWNoZU5hbWUpOwogICAgICAgICAgICByZXR1cm4gY2FjaGVzLmRlbGV0ZShjYWNoZU5hbWUpOwogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgICk7CiAgICB9KQogICk7Cn0pOwoKLy8gRmV0Y2ggZXZlbnQ6IGZpcmVzIGZvciBldmVyeSBuZXR3b3JrIHJlcXVlc3QuCi8vIEltcGxlbWVudHMgYSAiTmV0d29yayBGaXJzdCwgZmFsbGluZyBiYWNrIHRvIENhY2hlIiBzdHJhdGVneS4Kc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aCgKICAgIC8vIFRyeSB0byBmZXRjaCBmcm9tIHRoZSBuZXR3b3JrIGZpcnN0LgogICAgZmV0Y2goZXZlbnQucmVxdWVzdCkudGhlbihuZXR3b3JrUmVzcG9uc2UgPT4gewogICAgICAvLyBJZiB0aGUgZmV0Y2ggaXMgc3VjY2Vzc2Z1bCwgd2Ugc2hvdWxkIGNhY2hlIHRoZSBuZXcgcmVzcG9uc2UuCiAgICAgIHJldHVybiBjYWNoZXMub3BlbihDQUNIRV9OQU1FKS50aGVuKGNhY2hlID0+IHsKICAgICAgICAvLyBXZSBjbG9uZSB0aGUgcmVzcG9uc2UgYmVjYXVzZSBhIHJlc3BvbnNlIGNhbiBvbmx5IGJlIGNvbnN1bWVkIG9uY2UuCiAgICAgICAgY2FjaGUucHV0KGV2ZW50LnJlcXVlc3QsIG5ldHdvcmtSZXNwb25zZS5jbG9uZSgpKTsKICAgICAgICAvLyBSZXR1cm4gdGhlIG9yaWdpbmFsIHJlc3BvbnNlIGZyb20gdGhlIG5ldHdvcmsuCiAgICAgICAgcmV0dXJuIG5ldHdvcmtSZXNwb25zZTsKICAgICAgfSk7CiAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgIC8vIElmIHRoZSBuZXR3b3JrIHJlcXVlc3QgZmFpbHMgKGUuZy4sIHdlJ3JlIG9mZmxpbmUpLAogICAgICAvLyB3ZSBmYWxsIGJhY2sgdG8gdGhlIGNhY2hlLgogICAgICByZXR1cm4gY2FjaGVzLm1hdGNoKGV2ZW50LnJlcXVlc3QpOwogICAgfSkKICApOwp9KTs="}}</script>
        <script>
          window.APPLET_FILES = ["index.tsx","metadata.json","index.html","manifest.json","sw.js"];
          </script>
        <script type="module">
        (() => {
  if (window.self === window.top) {
    // Do not run the shim in the main window, only in iframes.
    return;
  }

  window.API_KEY = 'GEMINI_API_KEY';
  window.GEMINI_API_KEY = 'GEMINI_API_KEY';
  window.process = window.process || {};
  window.process.env = window.process.env || {};
  window.process.env.API_KEY = window.API_KEY;
  window.process.env.GEMINI_API_KEY = window.GEMINI_API_KEY;

  const bootstrapChannel = new Promise((resolve) => {
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://aistudio.google.com') {
        return;
      }

      if (event.data.type === 'bootstrap') {
        resolve({
          port: event.ports[0],
          urlPatterns:
              event.data.urlPatterns.map((pattern) => new RegExp(pattern)),
        });
      }
    });
  });

  window.aistudio = window.aistudio || {
    getHostUrl: async function() {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_host_url'},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.url);
        };
      });
    },
    openSelectKey: async function() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'open_select_key'},
          [channel.port2]);
    },
    getModelQuota: async function(model) {
      const hostPort = (await bootstrapChannel).port;
      return new Promise((resolve) => {
        const channel = new MessageChannel();
        hostPort.postMessage(
            {type: 'get_model_quota', model},
            [channel.port2]);
        const port = channel.port1;
        port.onmessage = (message) => {
          resolve(message.data.modelQuota);
        };
      });
    },
  };

  const nativeFetch = window.fetch;

  /**
   * @param {string | URL | Request} resource The resource of the fetch request.
   * @param {RequestInit} options The options of the fetch request.
   * @return {Promise!} The promise of the fetch request.
   */
  async function fetch(resource, options) {
    const config = await bootstrapChannel;

    const request = new Request(resource, options);
    if (!config.urlPatterns.some((pattern) => request.url.match(pattern))) {
      return nativeFetch(resource, options);
    }
    const hostPort = config.port;

    const channel = new MessageChannel();
    const port = channel.port1;
    let bodyBytes;
    const transfer = [channel.port2];
    const parts = [];
    const buffer = await request.arrayBuffer();
    if (buffer.byteLength) {
      bodyBytes = buffer;
      transfer.push(bodyBytes);
    }
    hostPort.postMessage(
        {
          type: 'fetch',
          url: request.url,
          method: request.method,
          headers: [...request.headers.entries()],
          body: bodyBytes,
        },
        transfer);

    let streamController;
    const body = new ReadableStream({
      start(controller) {
        streamController = controller;
      },
    });
    let resolveReceive;
    const receivePromise = new Promise((resolve) => {
      resolveReceive = resolve;
    });
    port.onmessage = (message) => {
      switch (message.data.type) {
        case 'response':
          resolveReceive(new Response(body, {
            status: message.data.status,
            statusText: message.data.statusText,
            headers: new Headers(message.data.headers),
          }));
          break;
        case 'body':
          streamController.enqueue(message.data.data);
          break;
        case 'body_done':
          streamController.close();
          break;
      }
    };
    return receivePromise;
  }

  Object.defineProperty(window, 'fetch', {
    get: function() {
      return fetch;
    },
  });

  // See details in: https://github.com/angular/angular/issues/63064.
  function patchHistoryStateFunctionForAngular(originalFn, baseHref) {
    return (state, unused, url) => {
      if (typeof url === 'string' && !url.startsWith('blob:')) {
        url = baseHref + url;
      }
      return originalFn.apply(window.history, [state, unused, url]);
    };
  }

  if (false) {
    const baseHref = window.location.href;
    window.history.replaceState = patchHistoryStateFunctionForAngular(window.history.replaceState, baseHref);
    window.history.pushState = patchHistoryStateFunctionForAngular(window.history.pushState, baseHref);
  }

  const originalWebSocket = window.WebSocket;
  class ProxiedWebSocket extends EventTarget {
    /**
     * @param {string} url The url of the websocket.
     * @param {Object!} protocols The protocols of the websocket.
     */
    constructor(url, protocols) {
      super();
      this.url = url;
      this.protocols = protocols;

      this.open();
    }

    /** Opens the websocket. */
    async open() {
      const hostPort = (await bootstrapChannel).port;
      const channel = new MessageChannel();
      hostPort.postMessage(
          {type: 'websocket_open', url: this.url, protocols: this.protocols},
          [channel.port2]);
      this.port = channel.port1;
      this.port.onmessage = (message) => {
        if (message.data.type === 'close') {
          const event = new CloseEvent('close', {
            code: message.data.code,
            reason: message.data.reason,
            wasClean: message.data.wasClean,
          });
          if (this.onclose) {
            this.onclose(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'open') {
          const event = new Event('open');
          if (this.onopen) {
            this.onopen(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'message') {
          let data = message.data.data;
          if (message.data.messageType === 'text' || message.data.messageType === 'message') {
            data = new TextDecoder().decode(data);
          }
          const event = new MessageEvent('message', {
            data,
            type: message.data.messageType,
          });
          if (this.onmessage) {
            this.onmessage(event);
          }
          this.dispatchEvent(event);
          return;
        } else if (message.data.type === 'error') {
          const event = new ErrorEvent('error', {
            message: message.data.message,
          });
          if (this.onerror) {
            this.onerror(event);
          }
          this.dispatchEvent(event);
          return;
        }
        console.error('received unknown message in frame', event.data);
      };
    }
    /**
     * @param {string|ArrayBuffer!} data The data to send.
     */
    send(data) {
      if (typeof data === 'string') {
        this.port.postMessage({type: 'send', data});
      } else {
        this.port.postMessage({type: 'send', data}, [data.buffer]);
      }
    }

    /**
     * @param {number} code The code of the close event.
     * @param {string} reason The reason of the close event.
     */
    close(code, reason) {
      this.port.postMessage({type: 'close', code, reason});
    }
  }

  /**
   * @param {string} url The url of the websocket.
   * @param {Object!} protocols The protocols of the websocket.
   * @return {WebSocket!} The websocket.
   */
  function createWebSocket(url, protocols) {
    // This should come from the bootstrap channel, but we want this to
    // work for the synchronous constructor here.
    if (url.startsWith('wss://generativelanguage.googleapis.com/')) {
      return Reflect.construct(ProxiedWebSocket, [url, protocols]);
    }
    return Reflect.construct(originalWebSocket, [url, protocols]);
  }

  Object.defineProperty(window, 'WebSocket', {
    get: function() {
      return createWebSocket;
    },
  });

  async function instrumentErrorReporting() {
    const errors = [];
    let hostPort;

    function reportError(message) {
      if (!hostPort) {
        errors.push(message);
      } else {
        hostPort.postMessage({type: 'error', message: message}, message);
      }
    }

    function serialize(args) {
      return args.map((a) => {
        if (a instanceof Error || a instanceof ErrorEvent) {
          return a.message;
        }
        if(a instanceof CloseEvent) {
          return {code: a.code, reason: a.reason, wasClean: a.wasClean};
        }
        if( a instanceof Map) {
          return JSON.parse(JSON.stringify([...a.entries()]));
        }
        if( a instanceof Set) {
          return JSON.parse(JSON.stringify([...a.values()]));
        }
        if (a instanceof Object) {
          return JSON.parse(JSON.stringify(a));
        }
        return a;
      });
    }

    const originalConsole = window.console;
    const originalConsoleLog = window.console.log;
    const originalConsoleError = window.console.error;
    const originalConsoleWarn = window.console.warn;
    const originalConsoleDebug = window.console.debug;
    window.console = {
      ...originalConsole,
      log: (message, ...args) => {
        originalConsoleLog.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_log', message: combined });
      },
      debug: (message, ...args) => {
        originalConsoleDebug.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_debug', message: combined });
      },
      error: (message, ...args) => {
        originalConsoleError.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_error', message: combined });
      },
      warn: (message, ...args) => {
        originalConsoleWarn.apply(window.console, [message, ...args]);
        const combined = serialize([message, ...args]);
        reportError({type: 'console_warn', message: combined });
      },
    };

    window.onerror = (message, source, lineno, colno, error) => {
      reportError({type: 'error', message: serialize([message]), source, lineno, colno, error});
    };

    window.onunhandledrejection = (event) => {
      reportError({type: 'unhandledrejection', message: serialize([event.reason])});
    };

    window.alert = (message) => {
      reportError({type: 'alert', message: serialize([message]) });
    };

    hostPort = (await bootstrapChannel).port;
    for(const error of errors) {
      hostPort.postMessage({type: 'error', message: error});
    }
  }

  const availableFiles = new Set(window.APPLET_FILES || []);

  instrumentErrorReporting();

  window.addEventListener('hashchange', async (e) =>{
    const config = await bootstrapChannel;
    const hostPort = config.port;
    hostPort.postMessage({type: 'hashchange', hash: window.location.hash});
  });

  if (false) {
    const script = document.createElement('script');
    script.src =
      'https://www.gstatic.com/external_hosted/html2canvas/html2canvas.min.js';
    script.onload = () => {
      window.addEventListener('message', async (event) => {
        if (event.data?.type === 'capture-screenshot') {
          try {
            const canvas = await html2canvas(document.documentElement, {
              logging: false,
              useCORS: true,
              backgroundColor: null,
              scale: 1,
            });
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-result',
                dataUrl: canvas.toDataURL('image/png'),
                requestId: event.data.requestId,
              });
          } catch (e) {
            const hostPort = (await bootstrapChannel).port;
            hostPort.postMessage(
              {
                type: 'screenshot-error',
                error: e.message,
                requestId: event.data.requestId,
              });
          }
        }
      });
    };
    document.head.appendChild(script);
  }
})();
// # sourceURL=iframe_shim.js
        </script>
        <base href="https://ai.studio">




    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Argentina</title>
    <meta name="theme-color" content="#303f9f">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mi Argentina">
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&amp;family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #303f9f;
            --light-gray-bg: #f4f6f8;
            --text-dark: #333;
            --text-light: #6c757d;
            --card-white: #ffffff;
            --info-blue-bg: #d1e7fd;
            --info-blue-text: #0a58ca;
            --warning-pink-bg: #fde2e4;
            --warning-pink-text: #b13a3a;
            --border-color: #e0e0e0;
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scroll on mobile */
        }
        
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--light-gray-bg);
            color: var(--text-dark);
        }
        
        #screen-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 420px;
            margin: 0 auto;
            overflow: hidden; /* Container for screens */
        }
        
        #main-screen, #documentos-screen, #hijos-screen, #dni-details-screen, #telefonos-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-gray-bg);
            overflow-y: auto; /* Allow individual screen scrolling */
            display: none; /* Initially hide all */
            flex-direction: column;
        }

        #main-screen {
            display: flex; /* Show the first screen by default */
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            padding-bottom: 80px; /* Space for bottom nav */
            box-sizing: border-box;
        }

        /* Header */
        .app-header {
            background-color: var(--primary-blue);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .app-header .icon {
            width: 24px;
            height: 24px;
            stroke: white;
            cursor: pointer;
        }

        .logo {
            font-size: 22px;
            color: white;
            font-weight: 500;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
            z-index: 1001; /* Above menu */
        }
        .user-profile .icon-user-circle {
            fill: white;
        }
        .user-profile .icon-chevron {
            stroke: white;
            width: 16px;
            height: 16px;
            transition: transform 0.3s ease;
        }
        .user-profile .icon-chevron.rotated {
            transform: rotate(180deg);
        }

        /* User Menu */
        .user-menu {
            position: absolute;
            top: 68px; /* Below header */
            right: 16px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            width: 280px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
        }

        .user-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-menu-header .name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0 0 4px;
        }
        
        .user-menu-header .id {
            font-size: 14px;
            color: var(--text-light);
            margin: 0 0 8px;
        }

        .user-menu-header .validation-level {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-blue);
        }
        
        .user-menu-header .validation-level .icon {
            width: 18px;
            height: 18px;
            fill: var(--primary-blue);
            stroke: none;
        }

        .user-menu-list a, .user-menu-list div {
            display: block;
            padding: 12px 16px;
            font-size: 15px;
            color: var(--text-dark);
            text-decoration: none;
            cursor: pointer;
        }
        
        .user-menu-list a:hover, .user-menu-list div:hover {
            background-color: #f8f9fa;
        }
        
        .user-menu-footer {
             border-top: 1px solid var(--border-color);
        }


        /* Main Content */
        main {
            padding: 24px 16px;
            flex-grow: 1;
        }

        h1 {
            font-size: 28px;
            margin-top: 0;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .sub-headline {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        /* Cards */
        .card {
            background-color: var(--card-white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .card .icon-container {
            flex-shrink: 0;
        }

        .card .icon {
            width: 40px;
            height: 40px;
            color: var(--primary-blue);
        }
        
        .card .card-content {
            flex-grow: 1;
        }

        .card h3 {
            margin: 0 0 4px;
            font-size: 16px;
            font-weight: 600;
        }

        .card p {
            margin: 0;
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.4;
        }

        .turnos-card p {
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .turnos-card .btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* Grid Menu */
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .grid-item {
            background-color: var(--card-white);
            border-radius: 16px;
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
            text-decoration: none;
            min-height: 90px;
            cursor: pointer;
        }

        .grid-item .icon {
            width: 32px;
            height: 32px;
            margin-bottom: 8px;
            color: var(--primary-blue);
        }

        /* Info Cards */
        .info-card {
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .info-card--blue {
            background-color: var(--info-blue-bg);
        }
        .info-card--blue .icon {
            color: var(--info-blue-text);
        }
        .info-card--blue .info-title {
            color: var(--text-light);
            font-size: 14px;
        }
        .info-card--blue .info-main {
            font-weight: bold;
            font-size: 18px;
            color: var(--text-dark);
            margin: 2px 0;
        }
        .info-card--blue .info-sub {
            font-size: 14px;
            color: var(--text-light);
        }

        .info-card--pink {
            background-color: var(--warning-pink-bg);
        }
        .info-card--pink .icon {
            color: var(--warning-pink-text);
        }
        .info-card--pink .info-main {
            font-weight: 600;
            font-size: 16px;
            color: var(--warning-pink-text);
        }
        
        /* Documentos Screen */
        .documentos-header {
            position: relative;
        }
        
        .documentos-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            flex-grow: 1;
            text-align: center;
        }

        .documentos-header #back-btn, .documentos-header #hijos-back-btn {
            position: absolute;
            left: 16px;
        }

        .documentos-header #refresh-icon {
            position: absolute;
            right: 16px;
        }
        
        .dni-card {
            flex-direction: column;
            align-items: stretch;
            padding: 0;
        }
        
        .dni-card-header {
            display: flex;
            align-items: center;
            padding: 16px;
            gap: 16px;
            cursor: pointer;
        }

        .dni-card-header .card-content {
            flex-grow: 1;
        }
        .dni-card-header .card-content h3 {
            font-size: 18px;
            font-weight: 400;
        }
        .dni-card-header .card-content h3 span {
            font-weight: 600;
        }

        .dni-card-header .icon {
            width: 24px;
            height: 24px;
        }

        .dni-card-body {
            padding: 0 16px 16px;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
            padding-top: 24px;
            max-height: 1000px;
            overflow: hidden;
        }
        
        .dni-card-body.no-header {
             border-top: none;
             margin-top: 0;
             padding-top: 16px;
        }

        .dni-card-body .btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            border: 2px solid var(--primary-blue);
            cursor: pointer;
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        .btn-outline {
            background-color: transparent;
            color: var(--primary-blue);
        }
        .btn-solid {
            background-color: var(--primary-blue);
            color: white;
        }

        .dni-card-body p {
            text-align: center;
            margin: 16px 0;
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
        }

        .renaper-link {
            color: var(--info-blue-text);
            font-weight: 600;
            cursor: pointer;
        }
        
        .device-change-info {
            display: flex;
            align-items: center;
            gap: 12px;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
            margin-top: 16px;
            font-size: 15px;
            color: var(--text-dark);
        }
        .device-change-info .icon {
             width: 24px;
             height: 24px;
             color: var(--primary-blue);
        }
        
        .select-wrapper {
            position: relative;
            margin: 16px 0;
        }

        .select-wrapper::after {
            content: '▼';
            font-size: 12px;
            color: var(--text-dark);
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .custom-select {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-bottom: 1px solid var(--text-dark);
            background-color: transparent;
            font-size: 16px;
            color: var(--text-dark);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        /* DNI Collapse/Expand Styles */
        #dni-toggle-arrow {
            /* transition removed */
        }
        .dni-card.is-collapsed #dni-toggle-arrow {
            transform: rotate(180deg);
        }
        .dni-card.is-collapsed .dni-card-body {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            border-top-width: 0;
        }

        /* DNI Digital Display */
        #dni-digital-display {
            padding: 0;
            text-align: left;
        }
        #dni-digital-display h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .dni-card-visual {
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden; /* Ensures the image corners are rounded */
        }
        
        .dni-profile-pic {
            position: absolute;
            top: 26.3%;
            left: 6.1%;
            width: 25.8%;
            height: 40.9%;
        }

        .dni-qr-pic {
            position: absolute;
            background-color: white;
        }

        .profile-image-inner {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dni-image {
            width: 100%;
            display: block;
            border-radius: 12px;
        }
        
        .dni-text-overlay {
            position: absolute;
            font-family: 'Roboto Condensed', sans-serif;
            color: #2b2b2b;
            font-weight: 700;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dni-text-overlay--light {
            font-weight: 400;
            letter-spacing: normal;
        }

        .last-update {
            text-align: center;
            font-size: 13px;
            color: var(--text-light);
            margin: 24px 0;
        }
        
        .dni-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background-color: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .dni-actions button {
            background-color: white;
            border: none;
            padding: 16px 8px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .dni-actions button .icon {
            width: 20px;
            height: 20px;
        }
        
        .dni-qr-verify {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 500;
            border: 1px solid var(--border-color);
        }
        .dni-qr-verify .icon {
            width: 28px;
            height: 28px;
            color: var(--primary-blue);
        }
        .dni-qr-verify .icon-chevron {
            width: 20px;
            height: 20px;
            color: var(--text-light);
        }

        /* DNI Flipper Styles */
        .dni-flipper-container {
            perspective: 1000px;
            cursor: grab;
            user-select: none;
        }
        .dni-flipper-container:active {
            cursor: grabbing;
        }
        /* Make DNI card contents unselectable and unclickable to prevent context menus */
        .dni-card-visual img, .dni-card-visual .dni-text-overlay, .dni-card-visual .dni-profile-pic, .dni-card-visual .dni-qr-pic {
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none; /* Safari */
        }
        .dni-flipper {
            position: relative;
            width: 100%;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
        }
        /* This pseudo-element will define the aspect ratio of the container */
        .dni-flipper::before {
            content: '';
            display: block;
            padding-top: 63.1%; /* Aspect ratio of DNI image 344/545 */
        }
        .dni-card-front,
        .dni-card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        .dni-card-back {
            transform: rotateY(180deg);
        }
        
        /* Hijos Screen Controls */
        #hijos-screen .app-container {
            background-color: var(--light-gray-bg);
        }
        .controls-container {
            background-color: var(--card-white);
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .control-group {
            margin-bottom: 16px;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
            margin-top: 4px;
        }
        .custom-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
        }
        .control-group-divider {
            border-top: 1px solid var(--border-color);
            margin: 20px 0;
        }
        
        .controls-container .select-wrapper {
            margin: 0;
        }
        
        .controls-container .custom-select {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            padding: 8px 12px;
        }
        .controls-container .select-wrapper::after {
            right: 12px;
        }

        /* Carousel Styles */
        .carousel-wrapper {
            overflow: hidden;
            width: 100%;
            margin-bottom: 16px;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
        }

        .carousel-slide {
            width: 100%;
            flex-shrink: 0;
            box-sizing: border-box;
            padding: 0;
        }
        
        .carousel-dots {
            text-align: center;
            margin-bottom: 24px;
        }

        .carousel-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .carousel-dot.active {
            background-color: var(--primary-blue);
        }


        /* Bottom Nav */
        #bottom-nav, .details-bottom-nav, .telefonos-bottom-nav {
            position: absolute; /* Changed to absolute to be relative to screen */
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--card-white);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            box-sizing: border-box;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 12px;
            gap: 4px;
        }
        .nav-item .icon {
            width: 24px;
            height: 24px;
        }
        .nav-item.active {
            color: var(--primary-blue);
        }
        
        /* DNI Details Screen Styles - REVISED */
        #dni-details-screen .app-container {
            background-color: white;
            padding-bottom: 80px;
        }

        .dni-details-header {
            background-color: #373383;
            color: white;
            padding: 16px;
            display: flex;
            align-items: center;
            position: relative;
            flex-shrink: 0;
        }

        .dni-details-header .icon {
            width: 24px;
            height: 24px;
            stroke: white;
            cursor: pointer;
        }

        .dni-details-header #details-back-btn {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
        }

        .dni-details-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
            flex-grow: 1;
            text-align: center;
        }

        .dni-details-main {
            padding: 16px 24px;
        }

        .barcode-container {
            margin-bottom: 24px;
        }

        .barcode-image {
            display: block;
            height: 70px;
            width: auto;
            max-width: 100%;
            margin: 0 auto;
        }

        .details-profile-container {
            text-align: center;
            margin-bottom: 24px;
        }
        #details-profile-image {
            width: 270px;
            height: 270px;
            border-radius: 0;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            row-gap: 24px;
            column-gap: 16px;
            margin-bottom: 24px;
        }
        
        .info-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .details-divider {
            border: none;
            border-top: 1px solid #eeeeee;
            margin: 24px 0;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            color: var(--text-dark);
            font-weight: 500;
            line-height: 1.4;
        }

        .info-value.uppercase {
            font-weight: 700;
            text-transform: uppercase;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-gray-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.77, 0, 0.175, 1);
            visibility: hidden;
        }

        .loading-overlay.active {
            transform: translateX(0);
            visibility: visible;
        }

        .spinner {
            border: 6px solid rgba(0, 0, 0, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border-left-color: var(--primary-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        /* Action Loader (Spinner only) */
        .action-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(244, 246, 248, 0.85); /* Subtle bg */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        .action-loader.active {
            opacity: 1;
            visibility: visible;
        }

        /* Telefonos Screen Styles */
        #telefonos-screen .app-container {
            background-color: #fff;
        }
        
        #telefonos-screen main {
            background-color: var(--light-gray-bg);
        }

        #telefonos-screen h2 {
            font-size: 24px;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 24px;
        }

        .telefonos-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .telefono-item {
            background-color: var(--card-white);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .telefono-number {
            font-size: 28px;
            font-weight: 500;
            color: var(--primary-blue);
            width: 80px;
            flex-shrink: 0;
        }
        
        .telefono-description {
            flex-grow: 1;
            font-size: 16px;
            color: var(--text-dark);
            padding: 0 16px;
            border-left: 1px solid var(--border-color);
        }

        .telefono-icon {
            width: 24px;
            height: 24px;
            color: var(--text-light);
            flex-shrink: 0;
        }
    </style>
<link rel="icon" href="https://iili.io/KXRBnta.jpg" type="image/jpeg"><link rel="apple-touch-icon" href="https://iili.io/KXRBnta.jpg"></head>
            <body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    <div id="action-loader" class="action-loader">
        <div class="spinner"></div>
    </div>
    
    <div id="screen-container">
        <div id="main-screen" style="display: flex;">
            <div class="app-container">
                <header class="app-header">
                    <!-- Hamburger Icon -->
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
                    </svg>

                    <div class="logo">Mi Argentina</div>

                    <div id="user-profile-btn" class="user-profile">
                        <!-- User Icon -->
                        <svg class="icon icon-user-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd"></path>
                        </svg>
                        <!-- Chevron Down Icon -->
                        <svg id="profile-arrow" class="icon icon-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path>
                        </svg>
                    </div>
                </header>

                <div id="user-menu" class="user-menu">
                    <div class="user-menu-header">
                        <p class="name" id="menu-user-name">MARIA ELENA GOMEZ</p>
                        <p class="id" id="menu-user-id">20-35123456-9</p>
                        <div class="validation-level">
                            Validado Nivel 3
                            <svg class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        </div>
                    </div>
                    <div class="user-menu-list">
                        <a href="#">Mi perfil</a>
                        <a href="#" id="menu-hijos-btn">Hijos/as asociados</a>
                        <a href="#">Suscribir servicios</a>
                        <a href="#">Configurar mi cuenta</a>
                        <a href="#">Seguridad</a>
                        <a href="#">Términos y Condiciones</a>
                    </div>
                    <div class="user-menu-footer">
                        <a href="#">Cerrar la sesión</a>
                    </div>
                </div>

                <main>
                    <h1>¡Hola <span id="welcome-name">MARIA ELENA</span>!</h1>
                    <p class="sub-headline">Gestioná trámites, sacá turnos, accedé a tus credenciales y recibí información personalizada.</p>

                    <section class="turnos-card card">
                        <div class="icon-container">
                             <!-- Ticket Icon -->
                             <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 5H9C6.79086 5 5 6.79086 5 9V10.5C6.10457 10.5 7 11.3954 7 12.5C7 13.6046 6.10457 14.5 5 14.5V16C5 18.2091 6.79086 20 9 20H15C17.2091 20 19 18.2091 19 16V14.5C17.8954 14.5 17 13.6046 17 12.5C17 11.3954 17.8954 10.5 19 10.5V9C19 6.79086 17.2091 5 15 5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                <text x="8" y="17.5" font-family="Arial, sans-serif" font-size="6" font-weight="bold" fill="currentColor">01</text>
                            </svg>
                        </div>
                        <div class="card-content">
                            <p>No tenés turnos programados</p>
                            <button class="btn">Sacar turno</button>
                        </div>
                    </section>

                    <section class="elecciones-card card">
                         <div class="icon-container">
                            <!-- Ballot Box Icon -->
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75h16.5v10.5h-16.5z"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.75L12 3.75l8.25 6"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25h6v3.75H9z"></path>
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8.25V6"></path>
                            </svg>
                         </div>
                         <div class="card-content">
                            <h3>Elecciones 2025</h3>
                            <p>Conocé donde votar en las próximas elecciones</p>
                         </div>
                    </section>

                    <h2 class="section-title">¿Qué necesitás hoy?</h2>

                    <div class="grid-menu">
                        <a href="#" id="documentos-btn" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 21z"></path></svg>
                            Documentos
                        </a>
                        <a href="#" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 013.375-3.375h9.75a3.375 3.375 0 013.375 3.375v1.875m-17.25 4.5h16.5M6 12V6.375c0-1.036.84-1.875 1.875-1.875h7.5c1.035 0 1.875.84 1.875 1.875V12m-12 0h12"></path></svg>
                            Vehículos
                        </a>
                        <a href="#" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125V6.375c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v.001c0 .621.504 1.125 1.125 1.125z"></path></svg>
                            Trabajo
                        </a>
                        <a href="#" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z"></path></svg>
                            Salud
                        </a>
                        <a href="#" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Cobros
                        </a>
                        <a href="#" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path></svg>
                            Trámites
                        </a>
                        <a href="#" class="grid-item">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M15 5H9C6.79086 5 5 6.79086 5 9V10.5C6.10457 10.5 7 11.3954 7 12.5C7 13.6046 6.10457 14.5 5 14.5V16C5 18.2091 6.79086 20 9 20H15C17.2091 20 19 18.2091 19 16V14.5C17.8954 14.5 17 13.6046 17 12.5C17 11.3954 17.8954 10.5 19 10.5V9C19 6.79086 17.2091 5 15 5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                <text x="8" y="17.5" font-family="Arial, sans-serif" font-size="6" font-weight="bold" fill="currentColor">01</text>
                            </svg>
                            Turnos
                        </a>
                        <a href="#" id="hijos-btn" class="grid-item">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.897M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.228a4.5 4.5 0 00-1.897 1.897M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"></path>
                            </svg>
                            Hijos
                        </a>
                    </div>

                    <section class="info-card info-card--blue">
                        <div class="icon-container">
                            <svg class="icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="6" y="7" width="28" height="29" rx="4" stroke="currentColor" stroke-width="2"></rect>
                                <path d="M13 7 V 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                <path d="M27 7 V 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                                <rect x="10" y="14" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <rect x="17.25" y="14" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <rect x="24.5" y="14" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <rect x="10" y="21.25" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <g>
                                    <rect x="17.25" y="21.25" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                    <path d="M19 24.5 l2 2 l3.5 -4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </g>
                                <rect x="24.5" y="21.25" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <rect x="10" y="28.5" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <rect x="17.25" y="28.5" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                                <rect x="24.5" y="28.5" width="5.5" height="5.5" rx="1" stroke="currentColor" stroke-width="1.5"></rect>
                            </svg>
                        </div>
                        <div class="card-content">
                            <div class="info-title">Próximo feriado</div>
                            <div class="info-main">12 de Octubre</div>
                            <div class="info-sub">12 de octubre. Día de la raza.</div>
                        </div>
                    </section>

                    <section class="info-card info-card--pink">
                        <div class="icon-container">
                            <svg class="icon" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M31.5 12 C 34.98 17.06 34.42 23.61 30.58 27.97 C 26.74 32.33 20.47 33.15 15.5 30" stroke="#f06292" stroke-width="3" stroke-linecap="round"></path>
                                <circle cx="31.5" cy="12" r="1.5" fill="#f06292"></circle>
                                <g stroke="currentColor">
                                    <circle cx="20" cy="20" r="11" stroke-width="1.5"></circle>
                                    <path d="M20 19C21.6569 19 23 17.6569 23 16C23 14.3431 21.6569 13 20 13C18.3431 13 17 14.3431 17 16C17 17.6569 18.3431 19 20 19Z" stroke-width="1.5"></path>
                                    <path d="M16 25C16 22.7909 17.7909 21 20 21C22.2091 21 24 22.7909 24 25" stroke-width="1.5" stroke-linecap="round"></path>
                                </g>
                            </svg>
                        </div>
                        <div class="card-content">
                            <div class="info-main">Mantené tu perfil actualizado</div>
                        </div>
                    </section>

                </main>
            </div>
        </div>

        <div id="documentos-screen" style="display: none;">
            <div class="app-container">
                 <header class="app-header documentos-header">
                    <!-- Back Arrow Icon -->
                    <svg id="back-btn" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"></path>
                    </svg>
                    <h2>Documentos</h2>
                    <svg id="refresh-icon" class="icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0M2.985 19.644A8.25 8.25 0 0111.664 2.985m7.007 11.664v4.992h-4.992m0 0l-3.181-3.183a8.25 8.25 0 00-11.664 0m11.664 0l-3.181 3.183"></path>
                    </svg>
                </header>
                <main>
                    <section class="card dni-card">
                        <div class="dni-card-header" id="dni-card-header">
                            <div class="icon-container">
                                 <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 21z"></path></svg>
                            </div>
                            <div class="card-content">
                                 <h3><span>Documento Nacional de Identidad</span><br>(DNI)</h3>
                            </div>
                            <!-- Up Arrow Icon -->
                            <svg class="icon" id="dni-toggle-arrow" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
                            </svg>
                        </div>
                        <div class="dni-card-body" id="dni-card-body">
                            
                            <div id="dni-initial-view" style="display: block;">
                                <button id="solicitar-dni-btn" class="btn btn-outline">Solicitar DNI Digital por primera vez</button>
                                <button id="ver-dni-digital-btn" class="btn btn-solid">Ver DNI Digital</button>
                                <p>Datos suministrados por <span class="renaper-link">RENAPER</span></p>
                                <p>Recordá que podés solicitar el DNI para vos e tus hijos y tenerlos disponibles en la App.</p>
                                <div class="device-change-info">
                                    <!-- Info Icon -->
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                       <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"></path>
                                    </svg>
                                    <span>Cambié o voy a cambiar de dispositivo</span>
                                </div>
                            </div>

                            <div id="dni-solicitud-view" style="display: none;">
                                <p>Recordá que podés solicitar el DNI para vos e tus hijos y tenerlos disponibles en la App.</p>
                                <div class="select-wrapper">
                                    <select class="custom-select">
                                        <option id="solicitud-dni-name">MARIA ELENA GOMEZ</option>
                                    </select>
                                </div>
                                <button id="confirmar-solicitud-btn" class="btn btn-solid">Solicitar DNI Digital</button>
                                <p>Recordá que podés solicitar el DNI para vos e tus hijos y tenerlos disponibles en la App.</p>
                                <button class="btn btn-outline">Asociar un hijo/a</button>
                            </div>
                            
                            <div id="dni-digital-display" style="display: none;">
                               <h3 id="dni-digital-title">GOMEZ MARIA ELENA</h3>
                               <div class="dni-flipper-container">
                                   <div id="dni-flipper" class="dni-flipper" style="transform: rotateY(0deg);">
                                       <div class="dni-card-visual dni-card-front">
                                           <div class="dni-profile-pic" id="main-dni-profile-pic" style="top: 30.1%; left: 5%; width: 25.1%; height: 47.8%;">
                                               <img alt="Foto de perfil" class="profile-image-inner" id="main-dni-profile-image" src="https://i.pravatar.cc/150?img=3">
                                           </div>
                                           <!-- Text Overlays -->
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-apellido" style="top: 19.6%; left: 30.7%; font-size: 14px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">GOMEZ</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-nombre" style="top: 29.6%; left: 30.7%; font-size: 17px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">MARIA ELENA</div>
                                           <div class="dni-text-overlay" id="main-dni-documento" style="top: 87.2%; left: 3.1%; font-size: 21px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">35.123.456</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-nacimiento" style="top: 52.2%; left: 30.7%; font-size: 15px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">15 MAY/MAY 1990</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-tramite" style="top: 90%; left: 31%; font-size: 10px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">12345678901</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-ejemplar" style="top: 41.9%; left: 78.4%; font-size: 14px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">C</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-emision" style="top: 63.4%; left: 31%; font-size: 15px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">10 OCT/OCT 2021</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-vencimiento" style="top: 74.9%; left: 31%; font-size: 15px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">10 OCT/OCT 2036</div>
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-sexo" style="top: 41.3%; left: 31%; font-size: 17px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">M</div>
                                           <!-- Barcode -->
                                           <div class="dni-qr-pic" id="main-dni-qr-pic" style="top: 81.3%; left: 55.7%; width: 40%; height: 16.6%;">
                                               <img alt="Código de barras" class="profile-image-inner" id="main-dni-qr-image" src="https://i.ibb.co/Ld122f3/barcode-dni-r65jxl.png">
                                           </div>
                                           <!-- Base Image -->
                                           <img src="https://iili.io/KXFRqKu.md.png" alt="DNI Digital" class="dni-image">
                                       </div>
                                       <div class="dni-card-visual dni-card-back">
                                           <div class="dni-text-overlay dni-text-overlay--light" id="main-dni-domicilio" style="top: 3.7%; left: 23.1%; font-size: 14px; font-family: &quot;Roboto Condensed&quot;, sans-serif;">CALLE FALSA 123</div>
                                           <img src="https://iili.io/KW1zIb1.md.png" alt="DNI Digital Reverso" class="dni-image" id="main-dni-back-image">
                                       </div>
                                   </div>
                               </div>
                               <p class="last-update">Última actualización: 03/10/2025 16:59:27 hs</p>
                               <div class="dni-actions">
                                   <button id="ver-detalle-btn">
                                       <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                       Ver detalle
                                    </button>
                                   <button>
                                       <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                                       Desactivar DNI
                                    </button>
                               </div>
                               <div class="dni-qr-verify">
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5A.75.75 0 014.5 3h3.75a.75.75 0 010 1.5H5.25v3.75a.75.75 0 01-1.5 0V4.5zM19.5 3a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V5.25h-3.75a.75.75 0 010-1.5H19.5zM3.75 19.5a.75.75 0 01.75-.75h3.75a.75.75 0 010 1.5H5.25v-3.75a.75.75 0 01-1.5 0v3.75zM19.5 19.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v3.75a.75.75 0 01-.75.75h-3.75a.75.75 0 010-1.5h3v-2.25zM10.5 9.75h3v3h-3v-3zM10.5 15h3v3h-3v-3zM6 9.75h3v3H6v-3zM6 15h3v3H6v-3z"></path></svg>
                                    <span>Verifica código QR</span>
                                    <svg class="icon icon-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5"></path></svg>
                               </div>
                            </div>
                        </div>
                    </section>
                </main>
                <nav id="bottom-nav" style="display: none;">
                    <a href="#" id="inicio-btn" class="nav-item active">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z"></path><path d="M12 5.432l8.159 8.159c.026.026.05.054.07.084v6.101A2.25 2.25 0 0117.25 22h-2.5a.75.75 0 01-.75-.75V17.5a.75.75 0 00-.75-.75h-2.5a.75.75 0 00-.75.75v3.75a.75.75 0 01-.75-.75h-2.5A2.25 2.25 0 013.75 19.775v-6.101c.02-.03.044-.058.07-.084L12 5.432z"></path></svg>
                        <span>Inicio</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg>
                        <span>Novedades</span>
                    </a>
                    <a href="#" id="telefonos-btn-docs" class="nav-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        <span>Teléfonos</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 01.33.633l-3.25 2.5a.375.375 0 01-.66 0l-3.25-2.5a.375.375 0 01.33-.633H15.91zM9.75 9.75a.375.375 0 01.375-.375h3.75a.375.375 0 01.375.375v.375a.375.375 0 01-.375.375h-3.75a.375.375 0 01-.375-.375V9.75z"></path></svg>
                        <span>Tina</span>
                    </a>
                </nav>
            </div>
        </div>
        
        
        
        <div id="dni-details-screen" style="display: none;">
            <div class="app-container">
                <header class="dni-details-header">
                    <!-- Back Arrow Icon -->
                    <svg id="details-back-btn" class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"></path>
                    </svg>
                    <h2>DNI Digital</h2>
                </header>
                <main class="dni-details-main">
                    <div class="details-profile-container">
                        <img id="details-profile-image" alt="Foto de perfil" src="https://i.pravatar.cc/150?img=3">
                    </div>
                    <div class="barcode-container">
                        <img id="details-barcode-image" src="https://i.ibb.co/Ld122f3/barcode-dni-r65jxl.png" alt="Barcode" class="barcode-image">
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">DNI</span>
                            <span class="info-value" id="details-dni">35.123.456</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Número de trámite</span>
                            <span class="info-value" id="details-tramite">12345678901</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha de emisión</span>
                            <span class="info-value" id="details-emision">10 OCT/OCT 2021</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha de vencimiento</span>
                            <span class="info-value" id="details-vencimiento">10 OCT/OCT 2036</span>
                        </div>
                    </div>
                    <hr class="details-divider">
                    <div class="info-list">
                         <div class="info-item">
                            <span class="info-label">Nombre</span>
                            <span class="info-value" id="details-nombre">MARIA ELENA</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Apellido</span>
                            <span class="info-value uppercase" id="details-apellido">GOMEZ</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">CUIL</span>
                            <span class="info-value" id="details-cuil">20-35123456-9</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Sexo</span>
                            <span class="info-value uppercase" id="details-sexo">M</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha de nacimiento</span>
                            <span class="info-value" id="details-nacimiento">15 MAY/MAY 1990</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Nacionalidad</span>
                            <span class="info-value uppercase" id="details-nacionalidad">AR</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Lugar de nacimiento</span>
                            <span class="info-value uppercase" id="details-lugar-nacimiento">ARGENTINA</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Domicilio</span>
                            <span class="info-value uppercase" id="details-domicilio">CALLE FALSA 123</span>
                        </div>
                    </div>
                </main>
                <nav class="details-bottom-nav">
                    <a href="#" class="nav-item active">
                        <!-- Home Icon -->
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z"></path>
                          <path d="M12 5.432l8.159 8.159c.026.026.05.054.07.084v6.101A2.25 2.25 0 0117.25 22h-2.5a.75.75 0 01-.75-.75V17.5a.75.75 0 00-.75-.75h-2.5a.75.75 0 00-.75.75v3.75a.75.75 0 01-.75-.75h-2.5A2.25 2.25 0 013.75 19.775v-6.101c.02-.03.044-.058.07-.084L12 5.432z"></path>
                        </svg>
                        <span>Inicio</span>
                    </a>
                    <a href="#" class="nav-item">
                        <!-- List Icon -->
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
                        </svg>
                        <span>Novedades</span>
                    </a>
                    <a href="#" id="telefonos-btn-details" class="nav-item">
                        <!-- Phone Icon -->
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path>
                        </svg>
                        <span>Teléfonos</span>
                    </a>
                    <a href="#" class="nav-item">
                        <!-- Tina Icon -->
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 01.33.633l-3.25 2.5a.375.375 0 01-.66 0l-3.25-2.5a.375.375 0 01.33-.633H15.91zM9.75 9.75a.375.375 0 01.375-.375h3.75a.375.375 0 01.375.375v.375a.375.375 0 01-.375.375h-3.75a.375.375 0 01-.375-.375V9.75z"></path>
                        </svg>
                        <span>Tina</span>
                    </a>
                </nav>
            </div>
        </div>

        <div id="telefonos-screen" style="display: none;">
            <div class="app-container">
                <header class="app-header">
                     <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
                    </svg>
                    <div class="logo">Mi Argentina</div>
                    <div class="user-profile">
                        <svg class="icon icon-user-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0021.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 003.065 7.097A9.716 9.716 0 0012 21.75a9.716 9.716 0 006.685-2.653zm-12.54-1.285A7.486 7.486 0 0112 15a7.486 7.486 0 015.855 2.812A8.224 8.224 0 0112 20.25a8.224 8.224 0 01-5.855-2.438zM15.75 9a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </header>
                <main>
                    <h2>Teléfonos útiles</h2>
                    <div class="telefonos-list">
                        <div class="telefono-item">
                            <div class="telefono-number">911</div>
                            <div class="telefono-description">Central de emergencias</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                        <div class="telefono-item">
                            <div class="telefono-number">144</div>
                            <div class="telefono-description">Víctimas de violencia</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                        <div class="telefono-item">
                            <div class="telefono-number">107</div>
                            <div class="telefono-description">Emergencias Médicas</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                         <div class="telefono-item">
                            <div class="telefono-number">100</div>
                            <div class="telefono-description">Bomberos</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                         <div class="telefono-item">
                            <div class="telefono-number">102</div>
                            <div class="telefono-description">La línea de las chicas y los...</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                         <div class="telefono-item">
                            <div class="telefono-number">103</div>
                            <div class="telefono-description">Defensa Civil</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                         <div class="telefono-item">
                            <div class="telefono-number">106</div>
                            <div class="telefono-description">Emergencia Náutica</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                         <div class="telefono-item">
                            <div class="telefono-number">135</div>
                            <div class="telefono-description">Asistencia</div>
                            <svg class="telefono-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        </div>
                    </div>
                </main>
                <nav class="telefonos-bottom-nav">
                    <a href="#" id="telefonos-inicio-btn" class="nav-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z"></path><path d="M12 5.432l8.159 8.159c.026.026.05.054.07.084v6.101A2.25 2.25 0 0117.25 22h-2.5a.75.75 0 01-.75-.75V17.5a.75.75 0 00-.75-.75h-2.5a.75.75 0 00-.75.75v3.75a.75.75 0 01-.75-.75h-2.5A2.25 2.25 0 013.75 19.775v-6.101c.02-.03.044-.058.07-.084L12 5.432z"></path></svg>
                        <span>Inicio</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path></svg>
                        <span>Novedades</span>
                    </a>
                    <a href="#" class="nav-item active">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"></path></svg>
                        <span>Teléfonos</span>
                    </a>
                    <a href="#" class="nav-item">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 01.33.633l-3.25 2.5a.375.375 0 01-.66 0l-3.25-2.5a.375.375 0 01.33-.633H15.91zM9.75 9.75a.375.375 0 01.375-.375h3.75a.375.375 0 01.375.375v.375a.375.375 0 01-.375.375h-3.75a.375.375 0 01-.375-.375V9.75z"></path></svg>
                        <span>Tina</span>
                    </a>
                </nav>
            </div>
        </div>
    </div>


    



        <script type="module" onerror="console.error('Failed to load the app. Try reloading it.')">import '@/index';</script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                function initScreenNavigation() {
                    const screens = {
                        main: document.getElementById('main-screen'),
                        documentos: document.getElementById('documentos-screen'),
                        details: document.getElementById('dni-details-screen'),
                        telefonos: document.getElementById('telefonos-screen'),
                    };
                    const navs = {
                        documentos: document.getElementById('bottom-nav'),
                        details: document.querySelector('.details-bottom-nav'),
                        telefonos: document.querySelector('.telefonos-bottom-nav'),
                    };
                    const loadingOverlay = document.getElementById('loading-overlay');
                    
                    const showScreen = (screenKey, subView) => {
                        Object.values(screens).forEach(s => s && (s.style.display = 'none'));
                        Object.values(navs).forEach(n => n && (n.style.display = 'none'));
                        
                        if (screens[screenKey]) screens[screenKey].style.display = 'flex';
                        
                        if (screenKey === 'documentos' && navs.documentos) navs.documentos.style.display = 'flex';
                        if (screenKey === 'details' && navs.details) navs.details.style.display = 'flex';
                        if (screenKey === 'telefonos' && navs.telefonos) navs.telefonos.style.display = 'flex';
                        
                        if (screenKey === 'documentos' && subView === 'digital') {
                           document.dispatchEvent(new CustomEvent('showDniView', { detail: 'digital' }));
                        }
                    };

                    const navigateWithLoader = (screenKey) => {
                        if (loadingOverlay) loadingOverlay.classList.add('active');
                        setTimeout(() => {
                            showScreen(screenKey);
                            if (loadingOverlay) loadingOverlay.classList.remove('active');
                        }, 1000);
                    };

                    document.getElementById('documentos-btn')?.addEventListener('click', e => { e.preventDefault(); navigateWithLoader('documentos'); });
                    document.getElementById('details-back-btn')?.addEventListener('click', e => { e.preventDefault(); showScreen('documentos', 'digital'); });
                    document.getElementById('telefonos-btn-docs')?.addEventListener('click', e => { e.preventDefault(); navigateWithLoader('telefonos'); });
                    document.getElementById('telefonos-btn-details')?.addEventListener('click', e => { e.preventDefault(); navigateWithLoader('telefonos'); });
                    document.getElementById('telefonos-inicio-btn')?.addEventListener('click', e => { e.preventDefault(); navigateWithLoader('main'); });
                    document.getElementById('inicio-btn')?.addEventListener('click', e => { e.preventDefault(); navigateWithLoader('main'); });
                }

                function initDniFlow() {
                    const actionLoader = document.getElementById('action-loader');
                    const dniViews = {
                        initial: document.getElementById('dni-initial-view'),
                        solicitud: document.getElementById('dni-solicitud-view'),
                        digital: document.getElementById('dni-digital-display'),
                    };
                    const headerElements = {
                        cardHeader: document.getElementById('dni-card-header'),
                        cardBody: document.getElementById('dni-card-body'),
                        header: document.querySelector('#documentos-screen .documentos-header'),
                        title: document.querySelector('#documentos-screen .documentos-header h2'),
                        refreshIcon: document.getElementById('refresh-icon'),
                    };

                    const showDniView = (viewKey) => {
                        Object.values(dniViews).forEach(v => v && (v.style.display = 'none'));
                        if (dniViews[viewKey]) dniViews[viewKey].style.display = 'block';

                        const isDigital = viewKey === 'digital';
                        const isSolicitud = viewKey === 'solicitud';
                        
                        if (headerElements.cardHeader) headerElements.cardHeader.style.display = (isDigital || isSolicitud) ? 'none' : 'flex';
                        if (headerElements.cardBody) headerElements.cardBody.classList.toggle('no-header', isDigital || isSolicitud);
                        if (headerElements.title) headerElements.title.textContent = isDigital ? document.getElementById('dni-digital-title').textContent : 'Documentos';
                        if (headerElements.refreshIcon) headerElements.refreshIcon.style.display = isDigital ? 'block' : 'none';
                        if (headerElements.header) headerElements.header.style.justifyContent = isDigital ? 'space-between' : 'flex-start';
                    };
                    document.addEventListener('showDniView', (e) => showDniView(e.detail));

                    const performAction = (view) => {
                        if (actionLoader) actionLoader.classList.add('active');
                        setTimeout(() => {
                            showDniView(view);
                            if (actionLoader) actionLoader.classList.remove('active');
                        }, 1000);
                    };

                    document.getElementById('solicitar-dni-btn')?.addEventListener('click', e => { e.preventDefault(); performAction('solicitud'); });
                    document.getElementById('ver-dni-digital-btn')?.addEventListener('click', e => { e.preventDefault(); performAction('digital'); });
                    document.getElementById('confirmar-solicitud-btn')?.addEventListener('click', e => { e.preventDefault(); performAction('digital'); });
                    document.getElementById('ver-detalle-btn')?.addEventListener('click', e => { e.preventDefault(); document.getElementById('dni-details-screen').style.display = 'flex'; });
                    document.getElementById('back-btn')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (getComputedStyle(dniViews.digital).display !== 'none') {
                           showDniView('initial');
                           const flipper = document.querySelector('#dni-flipper');
                           if(flipper) flipper.style.transform = 'rotateY(0deg)';
                        } else {
                           document.getElementById('main-screen').style.display = 'flex';
                           document.getElementById('documentos-screen').style.display = 'none';
                        }
                    });
                }

                function initUserMenu() {
                    const btn = document.getElementById('user-profile-btn');
                    const menu = document.getElementById('user-menu');
                    const arrow = document.getElementById('profile-arrow');
                    if (!btn || !menu || !arrow) return;
                    
                    btn.addEventListener('click', e => {
                        e.stopPropagation();
                        menu.classList.toggle('active');
                        arrow.classList.toggle('rotated');
                    });
                    
                    document.addEventListener('click', e => {
                        if (menu.classList.contains('active') && !menu.contains(e.target) && !btn.contains(e.target)) {
                            menu.classList.remove('active');
                            arrow.classList.remove('rotated');
                        }
                    });
                }
                
                function initDniInteractions() {
                    // DNI Flipper Logic (Drag/Swipe)
                    const dniFlipperContainer = document.querySelector('.dni-flipper-container');
                    const dniFlipper = document.getElementById('dni-flipper');

                    if (dniFlipperContainer && dniFlipper) {
                        let isDragging = false;
                        let startX = 0;
                        let startAngle = 0;
                        let currentAngle = 0;

                        const getEventX = (e) => e.type.includes('mouse') ? e.screenX : e.changedTouches[0].screenX;
                        
                        const handleDragStart = (e) => {
                            if (e.type === 'mousedown' && e.button !== 0) return;
                            isDragging = true;
                            startX = getEventX(e);
                            startAngle = currentAngle;
                            dniFlipper.style.transition = 'none';
                            if (e.type !== 'touchstart') e.preventDefault();
                        };

                        const handleDragMove = (e) => {
                            if (!isDragging) return;
                            e.preventDefault();
                            const currentX = getEventX(e);
                            const deltaX = currentX - startX;
                            const rotationSensitivity = 180 / dniFlipperContainer.offsetWidth;
                            const deltaAngle = deltaX * rotationSensitivity;
                            currentAngle = startAngle + deltaAngle;
                            dniFlipper.style.transform = 'rotateY(' + currentAngle + 'deg)';
                        };
                        
                        const handleDragEnd = () => {
                            if (!isDragging) return;
                            isDragging = false;
                            dniFlipper.style.transition = 'transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
                            const finalRotation = Math.round(currentAngle / 180) * 180;
                            dniFlipper.style.transform = 'rotateY(' + finalRotation + 'deg)';
                            currentAngle = finalRotation;
                        };

                        dniFlipperContainer.addEventListener('mousedown', handleDragStart);
                        document.addEventListener('mousemove', handleDragMove);
                        document.addEventListener('mouseup', handleDragEnd);
                        dniFlipperContainer.addEventListener('touchstart', handleDragStart, { passive: false });
                        document.addEventListener('touchmove', handleDragMove, { passive: false });
                        document.addEventListener('touchend', handleDragEnd);
                    }
                    
                    // DNI Collapse Logic
                    const card = document.querySelector('#documentos-screen .dni-card');
                    const header = document.getElementById('dni-card-header');
                    if (header && card) {
                        header.addEventListener('click', () => {
                            const isInitial = getComputedStyle(document.getElementById('dni-initial-view')).display !== 'none' || getComputedStyle(document.getElementById('dni-solicitud-view')).display !== 'none';
                            if (isInitial) card.classList.toggle('is-collapsed');
                        });
                    }
                }

                function initDisabledButtons() {
                    const selectors = [
                        '#main-screen a.grid-item:not(#documentos-btn):not(#hijos-btn)',
                        '#main-screen .turnos-card .btn', '#main-screen .elecciones-card',
                        '#documentos-screen .dni-actions button:not(#ver-detalle-btn)',
                        '#documentos-screen .dni-qr-verify',
                        '#bottom-nav a:not(#inicio-btn):not(#telefonos-btn-docs)',
                        '.details-bottom-nav a:not(.active):not(#telefonos-btn-details)',
                        '.telefonos-bottom-nav a:not(#telefonos-inicio-btn)',
                        '#user-menu a:not(#menu-hijos-btn)',
                        '.app-header svg:first-of-type'
                    ];
                    document.querySelectorAll(selectors.join(', ')).forEach(btn => {
                        btn.addEventListener('click', (e) => e.preventDefault());
                    });
                    // Disable Hijos button as it leads to a removed screen
                    document.getElementById('menu-hijos-btn')?.addEventListener('click', e => e.preventDefault());
                    document.getElementById('hijos-btn')?.addEventListener('click', e => e.preventDefault());
                }

                try { initScreenNavigation(); } catch(e) { console.error('Error in navigation:', e); }
                try { initDniFlow(); } catch(e) { console.error('Error in DNI flow:', e); }
                try { initUserMenu(); } catch(e) { console.error('Error in user menu:', e); }
                try { initDniInteractions(); } catch(e) { console.error('Error in DNI interactions:', e); }
                try { initDisabledButtons(); } catch(e) { console.error('Error disabling buttons:', e); }
            });
        </script></body>
            </html>